
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../cli/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>API - ZipStrain</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ZipStrain" class="md-header__button md-logo" aria-label="ZipStrain" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ZipStrain
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ZipStrain" class="md-nav__button md-logo" aria-label="ZipStrain" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ZipStrain
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome to ZipStrain
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../NextflowPipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nextflow Pipeline for ZipStrain
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ZipStrain Command Line Interface
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#database" class="md-nav__link">
    <span class="md-ellipsis">
      Database
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.database" class="md-nav__link">
    <span class="md-ellipsis">
      database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database--zipstraindatabase" class="md-nav__link">
    <span class="md-ellipsis">
      zipstrain.database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonConfig" class="md-nav__link">
    <span class="md-ellipsis">
      GenomeComparisonConfig
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenomeComparisonConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonConfig.from_json" class="md-nav__link">
    <span class="md-ellipsis">
      from_json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonConfig.get_maximal_scope_config" class="md-nav__link">
    <span class="md-ellipsis">
      get_maximal_scope_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonConfig.is_compatible" class="md-nav__link">
    <span class="md-ellipsis">
      is_compatible
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonConfig.to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      to_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonConfig.to_json" class="md-nav__link">
    <span class="md-ellipsis">
      to_json
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase" class="md-nav__link">
    <span class="md-ellipsis">
      GenomeComparisonDatabase
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenomeComparisonDatabase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.add_comp_database" class="md-nav__link">
    <span class="md-ellipsis">
      add_comp_database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.dump_obj" class="md-nav__link">
    <span class="md-ellipsis">
      dump_obj
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.get_all_profile_names" class="md-nav__link">
    <span class="md-ellipsis">
      get_all_profile_names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.get_remaining_pairs" class="md-nav__link">
    <span class="md-ellipsis">
      get_remaining_pairs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.is_complete" class="md-nav__link">
    <span class="md-ellipsis">
      is_complete
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.load_obj" class="md-nav__link">
    <span class="md-ellipsis">
      load_obj
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.save_new_compare_database" class="md-nav__link">
    <span class="md-ellipsis">
      save_new_compare_database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.to_complete_input_table" class="md-nav__link">
    <span class="md-ellipsis">
      to_complete_input_table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.update_compare_database" class="md-nav__link">
    <span class="md-ellipsis">
      update_compare_database
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase" class="md-nav__link">
    <span class="md-ellipsis">
      ProfileDatabase
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ProfileDatabase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase.add_database" class="md-nav__link">
    <span class="md-ellipsis">
      add_database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase.add_profile" class="md-nav__link">
    <span class="md-ellipsis">
      add_profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase.from_csv" class="md-nav__link">
    <span class="md-ellipsis">
      from_csv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase.save_as_new_database" class="md-nav__link">
    <span class="md-ellipsis">
      save_as_new_database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase.to_csv" class="md-nav__link">
    <span class="md-ellipsis">
      to_csv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase.update_database" class="md-nav__link">
    <span class="md-ellipsis">
      update_database
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileItem" class="md-nav__link">
    <span class="md-ellipsis">
      ProfileItem
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#profile" class="md-nav__link">
    <span class="md-ellipsis">
      Profile
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Profile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile" class="md-nav__link">
    <span class="md-ellipsis">
      profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile--zipstrainprofile" class="md-nav__link">
    <span class="md-ellipsis">
      zipstrain.profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile.build_gene_loc_table" class="md-nav__link">
    <span class="md-ellipsis">
      build_gene_loc_table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile.build_gene_range_table" class="md-nav__link">
    <span class="md-ellipsis">
      build_gene_range_table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile.get_strain_hetrogeneity" class="md-nav__link">
    <span class="md-ellipsis">
      get_strain_hetrogeneity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile.parse_gene_loc_table" class="md-nav__link">
    <span class="md-ellipsis">
      parse_gene_loc_table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile.profile_bam" class="md-nav__link">
    <span class="md-ellipsis">
      profile_bam
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile.profile_bam_in_chunks" class="md-nav__link">
    <span class="md-ellipsis">
      profile_bam_in_chunks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compare" class="md-nav__link">
    <span class="md-ellipsis">
      Compare
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compare">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare" class="md-nav__link">
    <span class="md-ellipsis">
      compare
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare--zipstraincompare" class="md-nav__link">
    <span class="md-ellipsis">
      zipstrain.compare
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.PolarsANIExpressions" class="md-nav__link">
    <span class="md-ellipsis">
      PolarsANIExpressions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.add_contiguity_info" class="md-nav__link">
    <span class="md-ellipsis">
      add_contiguity_info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.add_genome_info" class="md-nav__link">
    <span class="md-ellipsis">
      add_genome_info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.adjust_for_sequence_errors" class="md-nav__link">
    <span class="md-ellipsis">
      adjust_for_sequence_errors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.calculate_pop_ani" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_pop_ani
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.compare_genes" class="md-nav__link">
    <span class="md-ellipsis">
      compare_genes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.compare_genomes" class="md-nav__link">
    <span class="md-ellipsis">
      compare_genomes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.coverage_filter" class="md-nav__link">
    <span class="md-ellipsis">
      coverage_filter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.get_gene_ani" class="md-nav__link">
    <span class="md-ellipsis">
      get_gene_ani
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.get_longest_consecutive_blocks" class="md-nav__link">
    <span class="md-ellipsis">
      get_longest_consecutive_blocks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.get_shared_locs" class="md-nav__link">
    <span class="md-ellipsis">
      get_shared_locs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.get_unique_scaffolds" class="md-nav__link">
    <span class="md-ellipsis">
      get_unique_scaffolds
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils" class="md-nav__link">
    <span class="md-ellipsis">
      Utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils--zipstrainutils" class="md-nav__link">
    <span class="md-ellipsis">
      zipstrain.utils
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.build_null_poisson" class="md-nav__link">
    <span class="md-ellipsis">
      build_null_poisson
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.clean_bases" class="md-nav__link">
    <span class="md-ellipsis">
      clean_bases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.collect_breadth_tables" class="md-nav__link">
    <span class="md-ellipsis">
      collect_breadth_tables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.count_bases" class="md-nav__link">
    <span class="md-ellipsis">
      count_bases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.extract_genome_length" class="md-nav__link">
    <span class="md-ellipsis">
      extract_genome_length
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.get_genome_breadth_matrix" class="md-nav__link">
    <span class="md-ellipsis">
      get_genome_breadth_matrix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.make_the_bed" class="md-nav__link">
    <span class="md-ellipsis">
      make_the_bed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.process_mpileup_function" class="md-nav__link">
    <span class="md-ellipsis">
      process_mpileup_function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.split_lf_to_chunks" class="md-nav__link">
    <span class="md-ellipsis">
      split_lf_to_chunks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visualize" class="md-nav__link">
    <span class="md-ellipsis">
      Visualize
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Visualize">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize" class="md-nav__link">
    <span class="md-ellipsis">
      visualize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize--zipstrainvisualize" class="md-nav__link">
    <span class="md-ellipsis">
      zipstrain.visualize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.calculate_ibs" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_ibs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.calculate_identical_frac_vs_popani" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_identical_frac_vs_popani
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.calculate_strainsharing" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_strainsharing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.get_cdf" class="md-nav__link">
    <span class="md-ellipsis">
      get_cdf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.plot_clustermap" class="md-nav__link">
    <span class="md-ellipsis">
      plot_clustermap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.plot_ibs" class="md-nav__link">
    <span class="md-ellipsis">
      plot_ibs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.plot_ibs_heatmap" class="md-nav__link">
    <span class="md-ellipsis">
      plot_ibs_heatmap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.plot_identical_frac_vs_popani" class="md-nav__link">
    <span class="md-ellipsis">
      plot_identical_frac_vs_popani
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.plot_strainsharing" class="md-nav__link">
    <span class="md-ellipsis">
      plot_strainsharing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-manager" class="md-nav__link">
    <span class="md-ellipsis">
      Task Manager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Task Manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager" class="md-nav__link">
    <span class="md-ellipsis">
      task_manager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager--zipstraintask_manager" class="md-nav__link">
    <span class="md-ellipsis">
      zipstrain.task_manager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="zipstrain.task_manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager--key-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Key concepts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch" class="md-nav__link">
    <span class="md-ellipsis">
      Batch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Batch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.stats" class="md-nav__link">
    <span class="md-ellipsis">
      stats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.status" class="md-nav__link">
    <span class="md-ellipsis">
      status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.cancel" class="md-nav__link">
    <span class="md-ellipsis">
      cancel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      cleanup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.outputs_ready" class="md-nav__link">
    <span class="md-ellipsis">
      outputs_ready
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.update_status" class="md-nav__link">
    <span class="md-ellipsis">
      update_status
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.BatchFileOutput" class="md-nav__link">
    <span class="md-ellipsis">
      BatchFileOutput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BatchFileOutput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.BatchFileOutput.ready" class="md-nav__link">
    <span class="md-ellipsis">
      ready
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.BatchFileOutput.register_batch" class="md-nav__link">
    <span class="md-ellipsis">
      register_batch
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.CollectComps" class="md-nav__link">
    <span class="md-ellipsis">
      CollectComps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.CompareRunner" class="md-nav__link">
    <span class="md-ellipsis">
      CompareRunner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.CompareTaskGenerator" class="md-nav__link">
    <span class="md-ellipsis">
      CompareTaskGenerator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CompareTaskGenerator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.CompareTaskGenerator.generate_tasks" class="md-nav__link">
    <span class="md-ellipsis">
      generate_tasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.CompareTaskGenerator.get_total_tasks" class="md-nav__link">
    <span class="md-ellipsis">
      get_total_tasks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FastCompareLocalBatch" class="md-nav__link">
    <span class="md-ellipsis">
      FastCompareLocalBatch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FastCompareSlurmBatch" class="md-nav__link">
    <span class="md-ellipsis">
      FastCompareSlurmBatch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FastCompareTask" class="md-nav__link">
    <span class="md-ellipsis">
      FastCompareTask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FileInput" class="md-nav__link">
    <span class="md-ellipsis">
      FileInput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FileInput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FileInput.get_value" class="md-nav__link">
    <span class="md-ellipsis">
      get_value
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FileOutput" class="md-nav__link">
    <span class="md-ellipsis">
      FileOutput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FileOutput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FileOutput.ready" class="md-nav__link">
    <span class="md-ellipsis">
      ready
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FileOutput.register_task" class="md-nav__link">
    <span class="md-ellipsis">
      register_task
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Input" class="md-nav__link">
    <span class="md-ellipsis">
      Input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.IntInput" class="md-nav__link">
    <span class="md-ellipsis">
      IntInput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IntInput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.IntInput.get_value" class="md-nav__link">
    <span class="md-ellipsis">
      get_value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.IntInput.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.IntOutput" class="md-nav__link">
    <span class="md-ellipsis">
      IntOutput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IntOutput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.IntOutput.ready" class="md-nav__link">
    <span class="md-ellipsis">
      ready
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.LocalBatch" class="md-nav__link">
    <span class="md-ellipsis">
      LocalBatch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LocalBatch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.LocalBatch.cancel" class="md-nav__link">
    <span class="md-ellipsis">
      cancel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.LocalBatch.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Output" class="md-nav__link">
    <span class="md-ellipsis">
      Output
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Output">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Output.register_task" class="md-nav__link">
    <span class="md-ellipsis">
      register_task
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.PrepareCompareGenomeRunOutputs" class="md-nav__link">
    <span class="md-ellipsis">
      PrepareCompareGenomeRunOutputs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PrepareCompareGenomeRunOutputs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.PrepareCompareGenomeRunOutputs.pre_run" class="md-nav__link">
    <span class="md-ellipsis">
      pre_run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.ProfileBamTask" class="md-nav__link">
    <span class="md-ellipsis">
      ProfileBamTask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.ProfileRunner" class="md-nav__link">
    <span class="md-ellipsis">
      ProfileRunner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.ProfileTaskGenerator" class="md-nav__link">
    <span class="md-ellipsis">
      ProfileTaskGenerator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ProfileTaskGenerator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.ProfileTaskGenerator.generate_tasks" class="md-nav__link">
    <span class="md-ellipsis">
      generate_tasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.ProfileTaskGenerator.get_total_tasks" class="md-nav__link">
    <span class="md-ellipsis">
      get_total_tasks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Runner" class="md-nav__link">
    <span class="md-ellipsis">
      Runner
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Runner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Runner.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmBatch" class="md-nav__link">
    <span class="md-ellipsis">
      SlurmBatch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SlurmBatch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmBatch.cancel" class="md-nav__link">
    <span class="md-ellipsis">
      cancel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmBatch.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmConfig" class="md-nav__link">
    <span class="md-ellipsis">
      SlurmConfig
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SlurmConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmConfig.from_json" class="md-nav__link">
    <span class="md-ellipsis">
      from_json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmConfig.to_slurm_args" class="md-nav__link">
    <span class="md-ellipsis">
      to_slurm_args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmConfig.validate_time" class="md-nav__link">
    <span class="md-ellipsis">
      validate_time
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Status" class="md-nav__link">
    <span class="md-ellipsis">
      Status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.StringInput" class="md-nav__link">
    <span class="md-ellipsis">
      StringInput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StringInput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.StringInput.get_value" class="md-nav__link">
    <span class="md-ellipsis">
      get_value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.StringInput.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.StringOutput" class="md-nav__link">
    <span class="md-ellipsis">
      StringOutput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StringOutput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.StringOutput.ready" class="md-nav__link">
    <span class="md-ellipsis">
      ready
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task" class="md-nav__link">
    <span class="md-ellipsis">
      Task
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Task">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.batch_dir" class="md-nav__link">
    <span class="md-ellipsis">
      batch_dir
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.command" class="md-nav__link">
    <span class="md-ellipsis">
      command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.post_run" class="md-nav__link">
    <span class="md-ellipsis">
      post_run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.pre_run" class="md-nav__link">
    <span class="md-ellipsis">
      pre_run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.status" class="md-nav__link">
    <span class="md-ellipsis">
      status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.task_dir" class="md-nav__link">
    <span class="md-ellipsis">
      task_dir
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.get_status" class="md-nav__link">
    <span class="md-ellipsis">
      get_status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.map_io" class="md-nav__link">
    <span class="md-ellipsis">
      map_io
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.TaskGenerator" class="md-nav__link">
    <span class="md-ellipsis">
      TaskGenerator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.get_cpu_usage" class="md-nav__link">
    <span class="md-ellipsis">
      get_cpu_usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.get_memory_usage" class="md-nav__link">
    <span class="md-ellipsis">
      get_memory_usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.lazy_run_compares" class="md-nav__link">
    <span class="md-ellipsis">
      lazy_run_compares
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#database" class="md-nav__link">
    <span class="md-ellipsis">
      Database
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Database">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.database" class="md-nav__link">
    <span class="md-ellipsis">
      database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database--zipstraindatabase" class="md-nav__link">
    <span class="md-ellipsis">
      zipstrain.database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonConfig" class="md-nav__link">
    <span class="md-ellipsis">
      GenomeComparisonConfig
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenomeComparisonConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonConfig.from_json" class="md-nav__link">
    <span class="md-ellipsis">
      from_json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonConfig.get_maximal_scope_config" class="md-nav__link">
    <span class="md-ellipsis">
      get_maximal_scope_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonConfig.is_compatible" class="md-nav__link">
    <span class="md-ellipsis">
      is_compatible
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonConfig.to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      to_dict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonConfig.to_json" class="md-nav__link">
    <span class="md-ellipsis">
      to_json
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase" class="md-nav__link">
    <span class="md-ellipsis">
      GenomeComparisonDatabase
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GenomeComparisonDatabase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.add_comp_database" class="md-nav__link">
    <span class="md-ellipsis">
      add_comp_database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.dump_obj" class="md-nav__link">
    <span class="md-ellipsis">
      dump_obj
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.get_all_profile_names" class="md-nav__link">
    <span class="md-ellipsis">
      get_all_profile_names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.get_remaining_pairs" class="md-nav__link">
    <span class="md-ellipsis">
      get_remaining_pairs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.is_complete" class="md-nav__link">
    <span class="md-ellipsis">
      is_complete
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.load_obj" class="md-nav__link">
    <span class="md-ellipsis">
      load_obj
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.save_new_compare_database" class="md-nav__link">
    <span class="md-ellipsis">
      save_new_compare_database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.to_complete_input_table" class="md-nav__link">
    <span class="md-ellipsis">
      to_complete_input_table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.GenomeComparisonDatabase.update_compare_database" class="md-nav__link">
    <span class="md-ellipsis">
      update_compare_database
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase" class="md-nav__link">
    <span class="md-ellipsis">
      ProfileDatabase
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ProfileDatabase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase.add_database" class="md-nav__link">
    <span class="md-ellipsis">
      add_database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase.add_profile" class="md-nav__link">
    <span class="md-ellipsis">
      add_profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase.from_csv" class="md-nav__link">
    <span class="md-ellipsis">
      from_csv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase.save_as_new_database" class="md-nav__link">
    <span class="md-ellipsis">
      save_as_new_database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase.to_csv" class="md-nav__link">
    <span class="md-ellipsis">
      to_csv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileDatabase.update_database" class="md-nav__link">
    <span class="md-ellipsis">
      update_database
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.database.ProfileItem" class="md-nav__link">
    <span class="md-ellipsis">
      ProfileItem
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#profile" class="md-nav__link">
    <span class="md-ellipsis">
      Profile
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Profile">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile" class="md-nav__link">
    <span class="md-ellipsis">
      profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile--zipstrainprofile" class="md-nav__link">
    <span class="md-ellipsis">
      zipstrain.profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile.build_gene_loc_table" class="md-nav__link">
    <span class="md-ellipsis">
      build_gene_loc_table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile.build_gene_range_table" class="md-nav__link">
    <span class="md-ellipsis">
      build_gene_range_table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile.get_strain_hetrogeneity" class="md-nav__link">
    <span class="md-ellipsis">
      get_strain_hetrogeneity
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile.parse_gene_loc_table" class="md-nav__link">
    <span class="md-ellipsis">
      parse_gene_loc_table
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile.profile_bam" class="md-nav__link">
    <span class="md-ellipsis">
      profile_bam
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.profile.profile_bam_in_chunks" class="md-nav__link">
    <span class="md-ellipsis">
      profile_bam_in_chunks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compare" class="md-nav__link">
    <span class="md-ellipsis">
      Compare
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compare">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare" class="md-nav__link">
    <span class="md-ellipsis">
      compare
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare--zipstraincompare" class="md-nav__link">
    <span class="md-ellipsis">
      zipstrain.compare
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.PolarsANIExpressions" class="md-nav__link">
    <span class="md-ellipsis">
      PolarsANIExpressions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.add_contiguity_info" class="md-nav__link">
    <span class="md-ellipsis">
      add_contiguity_info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.add_genome_info" class="md-nav__link">
    <span class="md-ellipsis">
      add_genome_info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.adjust_for_sequence_errors" class="md-nav__link">
    <span class="md-ellipsis">
      adjust_for_sequence_errors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.calculate_pop_ani" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_pop_ani
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.compare_genes" class="md-nav__link">
    <span class="md-ellipsis">
      compare_genes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.compare_genomes" class="md-nav__link">
    <span class="md-ellipsis">
      compare_genomes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.coverage_filter" class="md-nav__link">
    <span class="md-ellipsis">
      coverage_filter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.get_gene_ani" class="md-nav__link">
    <span class="md-ellipsis">
      get_gene_ani
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.get_longest_consecutive_blocks" class="md-nav__link">
    <span class="md-ellipsis">
      get_longest_consecutive_blocks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.get_shared_locs" class="md-nav__link">
    <span class="md-ellipsis">
      get_shared_locs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.compare.get_unique_scaffolds" class="md-nav__link">
    <span class="md-ellipsis">
      get_unique_scaffolds
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utils" class="md-nav__link">
    <span class="md-ellipsis">
      Utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils" class="md-nav__link">
    <span class="md-ellipsis">
      utils
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils--zipstrainutils" class="md-nav__link">
    <span class="md-ellipsis">
      zipstrain.utils
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.build_null_poisson" class="md-nav__link">
    <span class="md-ellipsis">
      build_null_poisson
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.clean_bases" class="md-nav__link">
    <span class="md-ellipsis">
      clean_bases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.collect_breadth_tables" class="md-nav__link">
    <span class="md-ellipsis">
      collect_breadth_tables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.count_bases" class="md-nav__link">
    <span class="md-ellipsis">
      count_bases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.extract_genome_length" class="md-nav__link">
    <span class="md-ellipsis">
      extract_genome_length
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.get_genome_breadth_matrix" class="md-nav__link">
    <span class="md-ellipsis">
      get_genome_breadth_matrix
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.make_the_bed" class="md-nav__link">
    <span class="md-ellipsis">
      make_the_bed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.process_mpileup_function" class="md-nav__link">
    <span class="md-ellipsis">
      process_mpileup_function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.utils.split_lf_to_chunks" class="md-nav__link">
    <span class="md-ellipsis">
      split_lf_to_chunks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visualize" class="md-nav__link">
    <span class="md-ellipsis">
      Visualize
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Visualize">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize" class="md-nav__link">
    <span class="md-ellipsis">
      visualize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize--zipstrainvisualize" class="md-nav__link">
    <span class="md-ellipsis">
      zipstrain.visualize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.calculate_ibs" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_ibs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.calculate_identical_frac_vs_popani" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_identical_frac_vs_popani
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.calculate_strainsharing" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_strainsharing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.get_cdf" class="md-nav__link">
    <span class="md-ellipsis">
      get_cdf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.plot_clustermap" class="md-nav__link">
    <span class="md-ellipsis">
      plot_clustermap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.plot_ibs" class="md-nav__link">
    <span class="md-ellipsis">
      plot_ibs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.plot_ibs_heatmap" class="md-nav__link">
    <span class="md-ellipsis">
      plot_ibs_heatmap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.plot_identical_frac_vs_popani" class="md-nav__link">
    <span class="md-ellipsis">
      plot_identical_frac_vs_popani
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.visualize.plot_strainsharing" class="md-nav__link">
    <span class="md-ellipsis">
      plot_strainsharing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-manager" class="md-nav__link">
    <span class="md-ellipsis">
      Task Manager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Task Manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager" class="md-nav__link">
    <span class="md-ellipsis">
      task_manager
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager--zipstraintask_manager" class="md-nav__link">
    <span class="md-ellipsis">
      zipstrain.task_manager
    </span>
  </a>
  
    <nav class="md-nav" aria-label="zipstrain.task_manager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager--key-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Key concepts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch" class="md-nav__link">
    <span class="md-ellipsis">
      Batch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Batch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.stats" class="md-nav__link">
    <span class="md-ellipsis">
      stats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.status" class="md-nav__link">
    <span class="md-ellipsis">
      status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.cancel" class="md-nav__link">
    <span class="md-ellipsis">
      cancel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      cleanup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.outputs_ready" class="md-nav__link">
    <span class="md-ellipsis">
      outputs_ready
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Batch.update_status" class="md-nav__link">
    <span class="md-ellipsis">
      update_status
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.BatchFileOutput" class="md-nav__link">
    <span class="md-ellipsis">
      BatchFileOutput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BatchFileOutput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.BatchFileOutput.ready" class="md-nav__link">
    <span class="md-ellipsis">
      ready
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.BatchFileOutput.register_batch" class="md-nav__link">
    <span class="md-ellipsis">
      register_batch
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.CollectComps" class="md-nav__link">
    <span class="md-ellipsis">
      CollectComps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.CompareRunner" class="md-nav__link">
    <span class="md-ellipsis">
      CompareRunner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.CompareTaskGenerator" class="md-nav__link">
    <span class="md-ellipsis">
      CompareTaskGenerator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CompareTaskGenerator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.CompareTaskGenerator.generate_tasks" class="md-nav__link">
    <span class="md-ellipsis">
      generate_tasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.CompareTaskGenerator.get_total_tasks" class="md-nav__link">
    <span class="md-ellipsis">
      get_total_tasks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FastCompareLocalBatch" class="md-nav__link">
    <span class="md-ellipsis">
      FastCompareLocalBatch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FastCompareSlurmBatch" class="md-nav__link">
    <span class="md-ellipsis">
      FastCompareSlurmBatch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FastCompareTask" class="md-nav__link">
    <span class="md-ellipsis">
      FastCompareTask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FileInput" class="md-nav__link">
    <span class="md-ellipsis">
      FileInput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FileInput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FileInput.get_value" class="md-nav__link">
    <span class="md-ellipsis">
      get_value
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FileOutput" class="md-nav__link">
    <span class="md-ellipsis">
      FileOutput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FileOutput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FileOutput.ready" class="md-nav__link">
    <span class="md-ellipsis">
      ready
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.FileOutput.register_task" class="md-nav__link">
    <span class="md-ellipsis">
      register_task
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Input" class="md-nav__link">
    <span class="md-ellipsis">
      Input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.IntInput" class="md-nav__link">
    <span class="md-ellipsis">
      IntInput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IntInput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.IntInput.get_value" class="md-nav__link">
    <span class="md-ellipsis">
      get_value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.IntInput.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.IntOutput" class="md-nav__link">
    <span class="md-ellipsis">
      IntOutput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IntOutput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.IntOutput.ready" class="md-nav__link">
    <span class="md-ellipsis">
      ready
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.LocalBatch" class="md-nav__link">
    <span class="md-ellipsis">
      LocalBatch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LocalBatch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.LocalBatch.cancel" class="md-nav__link">
    <span class="md-ellipsis">
      cancel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.LocalBatch.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Output" class="md-nav__link">
    <span class="md-ellipsis">
      Output
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Output">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Output.register_task" class="md-nav__link">
    <span class="md-ellipsis">
      register_task
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.PrepareCompareGenomeRunOutputs" class="md-nav__link">
    <span class="md-ellipsis">
      PrepareCompareGenomeRunOutputs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PrepareCompareGenomeRunOutputs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.PrepareCompareGenomeRunOutputs.pre_run" class="md-nav__link">
    <span class="md-ellipsis">
      pre_run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.ProfileBamTask" class="md-nav__link">
    <span class="md-ellipsis">
      ProfileBamTask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.ProfileRunner" class="md-nav__link">
    <span class="md-ellipsis">
      ProfileRunner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.ProfileTaskGenerator" class="md-nav__link">
    <span class="md-ellipsis">
      ProfileTaskGenerator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ProfileTaskGenerator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.ProfileTaskGenerator.generate_tasks" class="md-nav__link">
    <span class="md-ellipsis">
      generate_tasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.ProfileTaskGenerator.get_total_tasks" class="md-nav__link">
    <span class="md-ellipsis">
      get_total_tasks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Runner" class="md-nav__link">
    <span class="md-ellipsis">
      Runner
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Runner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Runner.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmBatch" class="md-nav__link">
    <span class="md-ellipsis">
      SlurmBatch
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SlurmBatch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmBatch.cancel" class="md-nav__link">
    <span class="md-ellipsis">
      cancel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmBatch.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmConfig" class="md-nav__link">
    <span class="md-ellipsis">
      SlurmConfig
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SlurmConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmConfig.from_json" class="md-nav__link">
    <span class="md-ellipsis">
      from_json
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmConfig.to_slurm_args" class="md-nav__link">
    <span class="md-ellipsis">
      to_slurm_args
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.SlurmConfig.validate_time" class="md-nav__link">
    <span class="md-ellipsis">
      validate_time
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Status" class="md-nav__link">
    <span class="md-ellipsis">
      Status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.StringInput" class="md-nav__link">
    <span class="md-ellipsis">
      StringInput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StringInput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.StringInput.get_value" class="md-nav__link">
    <span class="md-ellipsis">
      get_value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.StringInput.validate" class="md-nav__link">
    <span class="md-ellipsis">
      validate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.StringOutput" class="md-nav__link">
    <span class="md-ellipsis">
      StringOutput
    </span>
  </a>
  
    <nav class="md-nav" aria-label="StringOutput">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.StringOutput.ready" class="md-nav__link">
    <span class="md-ellipsis">
      ready
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task" class="md-nav__link">
    <span class="md-ellipsis">
      Task
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Task">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.batch_dir" class="md-nav__link">
    <span class="md-ellipsis">
      batch_dir
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.command" class="md-nav__link">
    <span class="md-ellipsis">
      command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.post_run" class="md-nav__link">
    <span class="md-ellipsis">
      post_run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.pre_run" class="md-nav__link">
    <span class="md-ellipsis">
      pre_run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.status" class="md-nav__link">
    <span class="md-ellipsis">
      status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.task_dir" class="md-nav__link">
    <span class="md-ellipsis">
      task_dir
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.get_status" class="md-nav__link">
    <span class="md-ellipsis">
      get_status
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.Task.map_io" class="md-nav__link">
    <span class="md-ellipsis">
      map_io
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.TaskGenerator" class="md-nav__link">
    <span class="md-ellipsis">
      TaskGenerator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.get_cpu_usage" class="md-nav__link">
    <span class="md-ellipsis">
      get_cpu_usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.get_memory_usage" class="md-nav__link">
    <span class="md-ellipsis">
      get_memory_usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zipstrain.task_manager.lazy_run_compares" class="md-nav__link">
    <span class="md-ellipsis">
      lazy_run_compares
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="api">API</h1>
<p>ZipStrain provides a Python API for programmatic access, enabling integration into larger bioinformatics pipelines and workflows. The API also allows for downstream analyses and visualizations.</p>
<hr />
<h2 id="database">Database</h2>


<div class="doc doc-object doc-module">



<a id="zipstrain.database"></a>
    <div class="doc doc-contents first">

        <h4 id="zipstrain.database--zipstraindatabase">zipstrain.database</h4>
<p>This module provides classes and functions to manage profile and comparison databases for efficient data handling.
The ProfileDatabase class manages profiles, while the GenomeComparisonDatabase class handles comparisons between profiles.
See the documentation of each class for more details.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h4 id="zipstrain.database.GenomeComparisonConfig" class="doc doc-heading">
            <code>GenomeComparisonConfig</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>


        <p>This class defines object which have all necessary options to describe 
Parameters used to compare profiles:</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="zipstrain.database.GenomeComparisonConfig.gene_db_id">gene_db_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ID of the gene fasta database to use for the comparison. The file name is perfect.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zipstrain.database.GenomeComparisonConfig.reference_id">reference_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ID of the reference fasta database to use for the comparison. The file name is perfect.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zipstrain.database.GenomeComparisonConfig.scope">scope</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The scope of the comparison- 'all' if all covered positions are desired. Otherwise, a bunch of genome names separated by commas.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zipstrain.database.GenomeComparisonConfig.min_cov">min_cov</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum coverage a base on the reference fasta that must have in order to be compared.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zipstrain.database.GenomeComparisonConfig.null_model_p_value(float)">null_model_p_value(float)</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>P_value above which a base call is counted as sequencing error</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zipstrain.database.GenomeComparisonConfig.min_gene_compare_len">min_gene_compare_len</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum length of a gene that needs to be covered at min_cov to be considered for gene similarity calculations</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zipstrain.database.GenomeComparisonConfig.stb_file_loc">stb_file_loc</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The location of the scaffold to bin file.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zipstrain.database.GenomeComparisonConfig.null_model_loc">null_model_loc</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The location of the null model file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GenomeComparisonConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class defines object which have all necessary options to describe </span>
<span class="sd">    Parameters used to compare profiles:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        gene_db_id (str): The ID of the gene fasta database to use for the comparison. The file name is perfect.</span>
<span class="sd">        reference_id (str): The ID of the reference fasta database to use for the comparison. The file name is perfect.</span>
<span class="sd">        scope (str): The scope of the comparison- &#39;all&#39; if all covered positions are desired. Otherwise, a bunch of genome names separated by commas.</span>
<span class="sd">        min_cov (int): Minimum coverage a base on the reference fasta that must have in order to be compared.</span>
<span class="sd">        null_model_p_value(float): P_value above which a base call is counted as sequencing error</span>
<span class="sd">        min_gene_compare_len (int): Minimum length of a gene that needs to be covered at min_cov to be considered for gene similarity calculations</span>
<span class="sd">        stb_file_loc (str): The location of the scaffold to bin file.</span>
<span class="sd">        null_model_loc (str): The location of the null model file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">)</span>
    <span class="n">gene_db_id</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;An ID given to the gene fasta file used for profiling. IMPORTANT: Make sure that this is in agreement with gene database IDs in the Profile Database.&quot;</span><span class="p">)</span>
    <span class="n">reference_id</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;An ID given to the reference fasta file used for profiling. IMPORTANT: Make sure that this is in agreement with reference IDs in the Profile Database.&quot;</span><span class="p">)</span>
    <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;An ID given to the reference fasta file used for profiling. IMPORTANT: Make sure that this is in agreement with reference IDs in the Profile Database.&quot;</span><span class="p">)</span>
    <span class="n">min_cov</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Minimum coverage a base on the reference fasta that must have in order to be compared.&quot;</span><span class="p">)</span>
    <span class="n">min_gene_compare_len</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Minimum length of a gene that needs to be covered at min_cov to be considered for gene similarity calculations&quot;</span><span class="p">)</span>
    <span class="n">null_model_p_value</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;P_value above which a base call is counted as sequencing error&quot;</span><span class="p">)</span>
    <span class="n">stb_file_loc</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;The location of the scaffold to bin file.&quot;</span><span class="p">)</span>
    <span class="n">null_model_loc</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;The location of the null model file.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">GenomeComparisonConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if this comparison configuration is compatible with another. Two configurations are compatible if they have the same parameters, except for scope.</span>
<span class="sd">        Scope can be different as long as they are not disjoint. Also, all is compatible with any scope.</span>
<span class="sd">        Args:</span>
<span class="sd">            other (GenomeComparisonConfig): The other comparison configuration to check compatibility with.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the configurations are compatible, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">!=</span><span class="s2">&quot;scope&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">scope</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span> <span class="o">==</span> <span class="nb">set</span><span class="p">()):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">json_file_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GenomeComparisonConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a GenomeComparisonConfig instance from a json file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file_dir</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">config_dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">json_file_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes the the current object to a json file&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file_dir</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the dictionary representation of the current object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_maximal_scope_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">GenomeComparisonConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenomeComparisonConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a new GenomeComparisonConfig object with the maximal scope that is compatible with the two configurations.</span>
<span class="sd">        Args:</span>
<span class="sd">            other (GenomeComparisonConfig): The other comparison configuration to get the maximal scope with.</span>
<span class="sd">        Returns:</span>
<span class="sd">            GenomeComparisonConfig: The new comparison configuration with the maximal scope.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_compatible</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The two comparison configurations are not compatible.&quot;</span><span class="p">)</span>

        <span class="n">new_scope</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">new_scope</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>

        <span class="k">elif</span> <span class="n">other</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">new_scope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">new_scope</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_scope</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))))</span>
        <span class="n">curr_config_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">curr_config_dict</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">new_scope</span> <span class="k">if</span> <span class="n">new_scope</span><span class="o">==</span><span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">new_scope</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">GenomeComparisonConfig</span><span class="p">(</span><span class="o">**</span><span class="n">curr_config_dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonConfig.from_json" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_json</span><span class="p">(</span><span class="n">json_file_dir</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Create a GenomeComparisonConfig instance from a json file.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">json_file_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GenomeComparisonConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a GenomeComparisonConfig instance from a json file.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file_dir</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">config_dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonConfig.get_maximal_scope_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_maximal_scope_config</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Get a new GenomeComparisonConfig object with the maximal scope that is compatible with the two configurations.
Args:
    other (GenomeComparisonConfig): The other comparison configuration to get the maximal scope with.
Returns:
    GenomeComparisonConfig: The new comparison configuration with the maximal scope.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_maximal_scope_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">GenomeComparisonConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenomeComparisonConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a new GenomeComparisonConfig object with the maximal scope that is compatible with the two configurations.</span>
<span class="sd">    Args:</span>
<span class="sd">        other (GenomeComparisonConfig): The other comparison configuration to get the maximal scope with.</span>
<span class="sd">    Returns:</span>
<span class="sd">        GenomeComparisonConfig: The new comparison configuration with the maximal scope.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_compatible</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The two comparison configurations are not compatible.&quot;</span><span class="p">)</span>

    <span class="n">new_scope</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">new_scope</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>

    <span class="k">elif</span> <span class="n">other</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">new_scope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">new_scope</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_scope</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))))</span>
    <span class="n">curr_config_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">curr_config_dict</span><span class="p">[</span><span class="s2">&quot;scope&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">new_scope</span> <span class="k">if</span> <span class="n">new_scope</span><span class="o">==</span><span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">new_scope</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">GenomeComparisonConfig</span><span class="p">(</span><span class="o">**</span><span class="n">curr_config_dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonConfig.is_compatible" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_compatible</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Check if this comparison configuration is compatible with another. Two configurations are compatible if they have the same parameters, except for scope.
Scope can be different as long as they are not disjoint. Also, all is compatible with any scope.
Args:
    other (GenomeComparisonConfig): The other comparison configuration to check compatibility with.
Returns:
    bool: True if the configurations are compatible, False otherwise.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">GenomeComparisonConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if this comparison configuration is compatible with another. Two configurations are compatible if they have the same parameters, except for scope.</span>
<span class="sd">    Scope can be different as long as they are not disjoint. Also, all is compatible with any scope.</span>
<span class="sd">    Args:</span>
<span class="sd">        other (GenomeComparisonConfig): The other comparison configuration to check compatibility with.</span>
<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the configurations are compatible, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">!=</span><span class="s2">&quot;scope&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">scope</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span> <span class="o">==</span> <span class="nb">set</span><span class="p">()):</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonConfig.to_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_dict</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Returns the dictionary representation of the current object</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the dictionary representation of the current object&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonConfig.to_json" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_json</span><span class="p">(</span><span class="n">json_file_dir</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Writes the the current object to a json file</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">json_file_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes the the current object to a json file&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_file_dir</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.database.GenomeComparisonDatabase" class="doc doc-heading">
            <code>GenomeComparisonDatabase</code>


</h4>


    <div class="doc doc-contents ">


        <p>GenomeComparisonDatabase object holds a reference to a comparison parquet file. The methods in this class serve to provide
functionality for working with the comparison data in an easy and efficient manner.
The comparison parquet file the result of running compare, and optionally concatenating multiple compare parquet file from single comparisons.
This parquet file must contain the following columns:</p>
<ul>
<li>
<p>genome</p>
</li>
<li>
<p>total_positions</p>
</li>
<li>
<p>share_allele_pos</p>
</li>
<li>
<p>genome_pop_ani</p>
</li>
<li>
<p>max_consecutive_length</p>
</li>
<li>
<p>shared_genes_count</p>
</li>
<li>
<p>identical_gene_count</p>
</li>
<li>
<p>sample_1</p>
</li>
<li>
<p>sample_2</p>
</li>
</ul>
<p>A ComparisonDatabase object needs a ComparisonConfig object to specify the parameters used for the comparison.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>profile_db</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ProfileDatabase (zipstrain.database.ProfileDatabase)" href="#zipstrain.database.ProfileDatabase">ProfileDatabase</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The profile database used for the comparison.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="GenomeComparisonConfig (zipstrain.database.GenomeComparisonConfig)" href="#zipstrain.database.GenomeComparisonConfig">GenomeComparisonConfig</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The comparison configuration used for the comparison.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>comp_db_loc</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The location of the comparison database parquet file. If
None, an empty comparison database is created.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GenomeComparisonDatabase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GenomeComparisonDatabase object holds a reference to a comparison parquet file. The methods in this class serve to provide</span>
<span class="sd">    functionality for working with the comparison data in an easy and efficient manner.</span>
<span class="sd">    The comparison parquet file the result of running compare, and optionally concatenating multiple compare parquet file from single comparisons.</span>
<span class="sd">    This parquet file must contain the following columns:</span>


<span class="sd">    - genome</span>

<span class="sd">    - total_positions</span>

<span class="sd">    - share_allele_pos</span>

<span class="sd">    - genome_pop_ani</span>

<span class="sd">    - max_consecutive_length</span>

<span class="sd">    - shared_genes_count</span>

<span class="sd">    - identical_gene_count</span>

<span class="sd">    - sample_1</span>

<span class="sd">    - sample_2</span>

<span class="sd">    A ComparisonDatabase object needs a ComparisonConfig object to specify the parameters used for the comparison.</span>

<span class="sd">    Args:</span>
<span class="sd">        profile_db (ProfileDatabase): The profile database used for the comparison.</span>
<span class="sd">        config (GenomeComparisonConfig): The comparison configuration used for the comparison.</span>
<span class="sd">        comp_db_loc (str|None): The location of the comparison database parquet file. If</span>
<span class="sd">            None, an empty comparison database is created.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">COLUMN_NAMES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;genome&quot;</span><span class="p">,</span>
        <span class="s2">&quot;total_positions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;share_allele_pos&quot;</span><span class="p">,</span>
        <span class="s2">&quot;genome_pop_ani&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max_consecutive_length&quot;</span><span class="p">,</span>
        <span class="s2">&quot;shared_genes_count&quot;</span><span class="p">,</span>
        <span class="s2">&quot;identical_gene_count&quot;</span><span class="p">,</span>
        <span class="s2">&quot;perc_id_genes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sample_1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sample_2&quot;</span>
    <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">profile_db</span><span class="p">:</span> <span class="n">ProfileDatabase</span><span class="p">,</span>
                 <span class="n">config</span><span class="p">:</span> <span class="n">GenomeComparisonConfig</span><span class="p">,</span>
                 <span class="n">comp_db_loc</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_db</span> <span class="o">=</span> <span class="n">profile_db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="k">if</span> <span class="n">comp_db_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">comp_db_loc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comp_db</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comp_db</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">({</span>
                <span class="s2">&quot;genome&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;total_positions&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;share_allele_pos&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;genome_pop_ani&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;max_consecutive_length&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;shared_genes_count&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;identical_gene_count&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;perc_id_genes&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;sample_1&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;sample_2&quot;</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">},</span> <span class="n">schema</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;genome&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">,</span>
                <span class="s2">&quot;total_positions&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
                <span class="s2">&quot;share_allele_pos&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
                <span class="s2">&quot;genome_pop_ani&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
                <span class="s2">&quot;max_consecutive_length&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
                <span class="s2">&quot;shared_genes_count&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
                <span class="s2">&quot;identical_gene_count&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
                <span class="s2">&quot;perc_id_genes&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
                <span class="s2">&quot;sample_1&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">,</span>
                <span class="s2">&quot;sample_2&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span>
            <span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span><span class="o">=</span><span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">comp_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comp_db</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_db</span><span class="o">.</span><span class="n">_validate_db</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comp_db</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COLUMN_NAMES</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Your comparison database must provide these extra columns: </span><span class="si">{</span><span class="w"> </span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">COLUMN_NAMES</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_comp_db</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1">#check if all profile names exist in the profile database</span>
        <span class="n">profile_names_in_comp_db</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_all_profile_names</span><span class="p">())</span>
        <span class="n">profile_names_in_profile_db</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;profile_name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">profile_names_in_comp_db</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">profile_names_in_profile_db</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The following profile names are in the comparison database but not in the profile database: </span><span class="si">{</span><span class="n">profile_names_in_comp_db</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">profile_names_in_profile_db</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_profile_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all profile names that are in the comparison database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sample_2&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
        <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_remaining_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get pairs of profiles that are in the profile database but not in the comparison database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;profile_name&quot;</span><span class="p">)</span>
        <span class="n">pairs</span><span class="o">=</span><span class="n">profiles</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;cross&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;profile_name&quot;</span><span class="p">:</span><span class="s2">&quot;profile_1&quot;</span><span class="p">,</span><span class="s2">&quot;profile_name_right&quot;</span><span class="p">:</span><span class="s2">&quot;profile_2&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;profile_1&quot;</span><span class="p">)</span><span class="o">&lt;</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;profile_2&quot;</span><span class="p">))</span>
        <span class="n">samplepairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_db</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">()</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">min_horizontal</span><span class="p">([</span><span class="s2">&quot;sample_1&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;profile_1&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">max_horizontal</span><span class="p">([</span><span class="s2">&quot;sample_1&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;profile_2&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;profile_1&quot;</span><span class="p">,</span> <span class="s2">&quot;profile_2&quot;</span><span class="p">])</span>

        <span class="n">remaining_pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">samplepairs</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;profile_1&quot;</span><span class="p">,</span> <span class="s2">&quot;profile_2&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;anti&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s2">&quot;profile_1&quot;</span><span class="p">,</span><span class="s2">&quot;profile_2&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">remaining_pairs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the comparison database is complete, i.e., if all pairs of profiles in the profile database have been compared.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remaining_pairs</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_comp_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp_database</span><span class="p">:</span> <span class="n">GenomeComparisonDatabase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge the provided comparison database into the current database.</span>

<span class="sd">        Args:</span>
<span class="sd">            comp_database (ComparisonDatabase): The comparison database to merge.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">comp_database</span><span class="o">.</span><span class="n">_validate_db</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The comparison database provided is not valid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">is_compatible</span><span class="p">(</span><span class="n">comp_database</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The comparison database provided is not compatible with the current comparison database.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_db</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_comp_db</span><span class="p">,</span> <span class="n">comp_database</span><span class="o">.</span><span class="n">comp_db</span><span class="p">])</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_maximal_scope_config</span><span class="p">(</span><span class="n">comp_database</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">save_new_compare_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the database to a parquet file.&quot;&quot;&quot;</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="n">output_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># The new database must be written to a new location</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="o">.</span><span class="n">absolute</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The output path must be different from the current database location.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">comp_db</span><span class="o">.</span><span class="n">sink_parquet</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">update_compare_database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Overwrites the comparison database saved on the disk to the current comparison database object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;comp_db_loc attribute is not determined yet!&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tmp_path</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.parquet&quot;</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;tmp_comp_db_&quot;</span><span class="p">,</span><span class="nb">dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span><span class="o">.</span><span class="n">parent</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comp_db</span><span class="o">.</span><span class="n">sink_parquet</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comp_db</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Something went wrong when updating the comparison database:</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dump_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dump the current object to a json file.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_path (str): The path to save the json file to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;profile_db_loc&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_db</span><span class="o">.</span><span class="n">db_loc</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_db</span><span class="o">.</span><span class="n">db_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s2">&quot;comp_db_loc&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_obj</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenomeComparisonDatabase</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a GenomeComparisonDatabase object from a json file.</span>

<span class="sd">        Args:</span>
<span class="sd">            json_path (str): The path to the json file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            GenomeComparisonDatabase: The loaded GenomeComparisonDatabase object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">obj_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">profile_db</span><span class="o">=</span><span class="n">ProfileDatabase</span><span class="p">(</span><span class="n">db_loc</span><span class="o">=</span><span class="n">obj_dict</span><span class="p">[</span><span class="s2">&quot;profile_db_loc&quot;</span><span class="p">])</span> <span class="p">,</span> 
                   <span class="n">config</span><span class="o">=</span><span class="n">GenomeComparisonConfig</span><span class="p">(</span><span class="o">**</span><span class="n">obj_dict</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]),</span> 
                   <span class="n">comp_db_loc</span><span class="o">=</span><span class="n">obj_dict</span><span class="p">[</span><span class="s2">&quot;comp_db_loc&quot;</span><span class="p">])</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">to_complete_input_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method gives a table of all pairwise comparisons that is needed to make the comparison database complete. The table contains the following columns:</span>

<span class="sd">        - sample_name_1</span>

<span class="sd">        - sample_name_2</span>

<span class="sd">        - profile_location_1</span>

<span class="sd">        - scaffold_location_1</span>

<span class="sd">        - profile_location_2</span>

<span class="sd">        - scaffold_location_2</span>

<span class="sd">        Returns:</span>
<span class="sd">            pl.LazyFrame: The table of all pairwise comparisons needed to complete the comparison database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_remaining_pairs</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;profile_1&quot;</span><span class="p">:</span><span class="s2">&quot;sample_name_1&quot;</span><span class="p">,</span><span class="s2">&quot;profile_2&quot;</span><span class="p">:</span><span class="s2">&quot;sample_name_2&quot;</span><span class="p">})</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;profile_name&quot;</span><span class="p">,</span><span class="s2">&quot;profile_location&quot;</span><span class="p">,</span><span class="s2">&quot;scaffold_location&quot;</span><span class="p">]),</span><span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;sample_name_1&quot;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;profile_name&quot;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;profile_location&quot;</span><span class="p">:</span><span class="s2">&quot;profile_location_1&quot;</span><span class="p">,</span><span class="s2">&quot;scaffold_location&quot;</span><span class="p">:</span><span class="s2">&quot;scaffold_location_1&quot;</span><span class="p">})</span>
                <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;profile_name&quot;</span><span class="p">,</span><span class="s2">&quot;profile_location&quot;</span><span class="p">,</span><span class="s2">&quot;scaffold_location&quot;</span><span class="p">]),</span><span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;sample_name_2&quot;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;profile_name&quot;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;profile_location&quot;</span><span class="p">:</span><span class="s2">&quot;profile_location_2&quot;</span><span class="p">,</span><span class="s2">&quot;scaffold_location&quot;</span><span class="p">:</span><span class="s2">&quot;scaffold_location_2&quot;</span><span class="p">})</span>
               <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonDatabase.add_comp_database" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_comp_database</span><span class="p">(</span><span class="n">comp_database</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Merge the provided comparison database into the current database.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>comp_database</code>
            </td>
            <td>
                  <code><span title="ComparisonDatabase">ComparisonDatabase</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The comparison database to merge.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_comp_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp_database</span><span class="p">:</span> <span class="n">GenomeComparisonDatabase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge the provided comparison database into the current database.</span>

<span class="sd">    Args:</span>
<span class="sd">        comp_database (ComparisonDatabase): The comparison database to merge.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">comp_database</span><span class="o">.</span><span class="n">_validate_db</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The comparison database provided is not valid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">is_compatible</span><span class="p">(</span><span class="n">comp_database</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The comparison database provided is not compatible with the current comparison database.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_comp_db</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_comp_db</span><span class="p">,</span> <span class="n">comp_database</span><span class="o">.</span><span class="n">comp_db</span><span class="p">])</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_maximal_scope_config</span><span class="p">(</span><span class="n">comp_database</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonDatabase.dump_obj" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dump_obj</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Dump the current object to a json file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to save the json file to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dump_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dump the current object to a json file.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_path (str): The path to save the json file to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">obj_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;profile_db_loc&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_db</span><span class="o">.</span><span class="n">db_loc</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_db</span><span class="o">.</span><span class="n">db_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
        <span class="s2">&quot;comp_db_loc&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonDatabase.get_all_profile_names" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_all_profile_names</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Get all profile names that are in the comparison database.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_all_profile_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all profile names that are in the comparison database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sample_2&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonDatabase.get_remaining_pairs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_remaining_pairs</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Get pairs of profiles that are in the profile database but not in the comparison database.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_remaining_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get pairs of profiles that are in the profile database but not in the comparison database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">profiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profile_db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;profile_name&quot;</span><span class="p">)</span>
    <span class="n">pairs</span><span class="o">=</span><span class="n">profiles</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;cross&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;profile_name&quot;</span><span class="p">:</span><span class="s2">&quot;profile_1&quot;</span><span class="p">,</span><span class="s2">&quot;profile_name_right&quot;</span><span class="p">:</span><span class="s2">&quot;profile_2&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;profile_1&quot;</span><span class="p">)</span><span class="o">&lt;</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;profile_2&quot;</span><span class="p">))</span>
    <span class="n">samplepairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_db</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">()</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">min_horizontal</span><span class="p">([</span><span class="s2">&quot;sample_1&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;profile_1&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">max_horizontal</span><span class="p">([</span><span class="s2">&quot;sample_1&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;profile_2&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;profile_1&quot;</span><span class="p">,</span> <span class="s2">&quot;profile_2&quot;</span><span class="p">])</span>

    <span class="n">remaining_pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">samplepairs</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;profile_1&quot;</span><span class="p">,</span> <span class="s2">&quot;profile_2&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;anti&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s2">&quot;profile_1&quot;</span><span class="p">,</span><span class="s2">&quot;profile_2&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">remaining_pairs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonDatabase.is_complete" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_complete</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Check if the comparison database is complete, i.e., if all pairs of profiles in the profile database have been compared.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the comparison database is complete, i.e., if all pairs of profiles in the profile database have been compared.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_remaining_pairs</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonDatabase.load_obj" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_obj</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Load a GenomeComparisonDatabase object from a json file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>json_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the json file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>GenomeComparisonDatabase</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="GenomeComparisonDatabase (zipstrain.database.GenomeComparisonDatabase)" href="#zipstrain.database.GenomeComparisonDatabase">GenomeComparisonDatabase</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The loaded GenomeComparisonDatabase object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_obj</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenomeComparisonDatabase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a GenomeComparisonDatabase object from a json file.</span>

<span class="sd">    Args:</span>
<span class="sd">        json_path (str): The path to the json file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        GenomeComparisonDatabase: The loaded GenomeComparisonDatabase object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">obj_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">profile_db</span><span class="o">=</span><span class="n">ProfileDatabase</span><span class="p">(</span><span class="n">db_loc</span><span class="o">=</span><span class="n">obj_dict</span><span class="p">[</span><span class="s2">&quot;profile_db_loc&quot;</span><span class="p">])</span> <span class="p">,</span> 
               <span class="n">config</span><span class="o">=</span><span class="n">GenomeComparisonConfig</span><span class="p">(</span><span class="o">**</span><span class="n">obj_dict</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]),</span> 
               <span class="n">comp_db_loc</span><span class="o">=</span><span class="n">obj_dict</span><span class="p">[</span><span class="s2">&quot;comp_db_loc&quot;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonDatabase.save_new_compare_database" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_new_compare_database</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Save the database to a parquet file.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_new_compare_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the database to a parquet file.&quot;&quot;&quot;</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="n">output_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># The new database must be written to a new location</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="o">.</span><span class="n">absolute</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The output path must be different from the current database location.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">comp_db</span><span class="o">.</span><span class="n">sink_parquet</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonDatabase.to_complete_input_table" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_complete_input_table</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>This method gives a table of all pairwise comparisons that is needed to make the comparison database complete. The table contains the following columns:</p>
<ul>
<li>
<p>sample_name_1</p>
</li>
<li>
<p>sample_name_2</p>
</li>
<li>
<p>profile_location_1</p>
</li>
<li>
<p>scaffold_location_1</p>
</li>
<li>
<p>profile_location_2</p>
</li>
<li>
<p>scaffold_location_2</p>
</li>
</ul>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pl.LazyFrame: The table of all pairwise comparisons needed to complete the comparison database.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_complete_input_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This method gives a table of all pairwise comparisons that is needed to make the comparison database complete. The table contains the following columns:</span>

<span class="sd">    - sample_name_1</span>

<span class="sd">    - sample_name_2</span>

<span class="sd">    - profile_location_1</span>

<span class="sd">    - scaffold_location_1</span>

<span class="sd">    - profile_location_2</span>

<span class="sd">    - scaffold_location_2</span>

<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: The table of all pairwise comparisons needed to complete the comparison database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_remaining_pairs</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;profile_1&quot;</span><span class="p">:</span><span class="s2">&quot;sample_name_1&quot;</span><span class="p">,</span><span class="s2">&quot;profile_2&quot;</span><span class="p">:</span><span class="s2">&quot;sample_name_2&quot;</span><span class="p">})</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">lf</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;profile_name&quot;</span><span class="p">,</span><span class="s2">&quot;profile_location&quot;</span><span class="p">,</span><span class="s2">&quot;scaffold_location&quot;</span><span class="p">]),</span><span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;sample_name_1&quot;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;profile_name&quot;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;profile_location&quot;</span><span class="p">:</span><span class="s2">&quot;profile_location_1&quot;</span><span class="p">,</span><span class="s2">&quot;scaffold_location&quot;</span><span class="p">:</span><span class="s2">&quot;scaffold_location_1&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_db</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;profile_name&quot;</span><span class="p">,</span><span class="s2">&quot;profile_location&quot;</span><span class="p">,</span><span class="s2">&quot;scaffold_location&quot;</span><span class="p">]),</span><span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;sample_name_2&quot;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;profile_name&quot;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;profile_location&quot;</span><span class="p">:</span><span class="s2">&quot;profile_location_2&quot;</span><span class="p">,</span><span class="s2">&quot;scaffold_location&quot;</span><span class="p">:</span><span class="s2">&quot;scaffold_location_2&quot;</span><span class="p">})</span>
           <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.GenomeComparisonDatabase.update_compare_database" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_compare_database</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Overwrites the comparison database saved on the disk to the current comparison database object</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_compare_database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Overwrites the comparison database saved on the disk to the current comparison database object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;comp_db_loc attribute is not determined yet!&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tmp_path</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.parquet&quot;</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;tmp_comp_db_&quot;</span><span class="p">,</span><span class="nb">dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span><span class="o">.</span><span class="n">parent</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comp_db</span><span class="o">.</span><span class="n">sink_parquet</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_comp_db</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_db_loc</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Something went wrong when updating the comparison database:</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.database.ProfileDatabase" class="doc doc-heading">
            <code>ProfileDatabase</code>


</h4>


    <div class="doc doc-contents ">


        <p>The profile database simply holds profile information. Does not need to be specific to a comparison database.
The data behind a profile is stored in a parquet file. It is basically a table with the following columns:</p>
<ul>
<li>
<p>profile_name: An arbitrary name given to the profile (Usually sample name or name of the parquet file)</p>
</li>
<li>
<p>profile_location: The location of the profile</p>
</li>
<li>
<p>scaffold_location: The location of the scaffold</p>
</li>
<li>
<p>reference_db_id: The ID of the reference database. This could be the name or any other identifier for the database that the reads are mapped to.</p>
</li>
<li>
<p>gene_db_id: The ID of the gene database in fasta format. This could be the name or any other identifier for the database that the reads are mapped to.</p>
</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>db_loc</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The location of the profile database parquet file. If None, an empty database is created.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProfileDatabase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The profile database simply holds profile information. Does not need to be specific to a comparison database.</span>
<span class="sd">    The data behind a profile is stored in a parquet file. It is basically a table with the following columns:</span>

<span class="sd">    - profile_name: An arbitrary name given to the profile (Usually sample name or name of the parquet file)</span>

<span class="sd">    - profile_location: The location of the profile</span>

<span class="sd">    - scaffold_location: The location of the scaffold</span>

<span class="sd">    - reference_db_id: The ID of the reference database. This could be the name or any other identifier for the database that the reads are mapped to.</span>

<span class="sd">    - gene_db_id: The ID of the gene database in fasta format. This could be the name or any other identifier for the database that the reads are mapped to.</span>

<span class="sd">    Args:</span>
<span class="sd">        db_loc (str|None): The location of the profile database parquet file. If None, an empty database is created.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">db_loc</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="k">if</span> <span class="n">db_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_loc</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">db_loc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_loc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">({</span>
                <span class="s2">&quot;profile_name&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;profile_location&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;scaffold_location&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;reference_db_id&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;gene_db_id&quot;</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">},</span> <span class="n">schema</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;profile_name&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">,</span>
                <span class="s2">&quot;profile_location&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">,</span>
                <span class="s2">&quot;scaffold_location&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">,</span>
                <span class="s2">&quot;reference_db_id&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">,</span>
                <span class="s2">&quot;gene_db_id&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span>
            <span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_loc</span><span class="o">=</span><span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">check_profile_exists</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">check_scaffold_exists</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simple method to see if the database has the minimum required structure.&quot;&quot;&quot;</span>

        <span class="c1">### Next check if the database has the required columns</span>
        <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;profile_name&quot;</span><span class="p">,</span><span class="s2">&quot;profile_location&quot;</span><span class="p">,</span> <span class="s2">&quot;scaffold_location&quot;</span><span class="p">,</span> <span class="s2">&quot;reference_db_id&quot;</span><span class="p">,</span> <span class="s2">&quot;gene_db_id&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">collect_schema</span><span class="p">()</span><span class="o">.</span><span class="n">names</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required column: </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">check_profile_exists</span><span class="p">:</span>
            <span class="c1"># Check if the profile exists in the database</span>
            <span class="n">db_path_validated</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;profile_location&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;profile_location&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map_elements</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span><span class="n">return_dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Boolean</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;profile_exists&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;profile_exists&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">db_path_validated</span><span class="o">.</span><span class="n">height</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">db_path_validated</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2"> profiles that do not exist: </span><span class="si">{</span><span class="n">db_path_validated</span><span class="p">[</span><span class="s1">&#39;profile_location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1">### add log later</span>
        <span class="k">if</span> <span class="n">check_scaffold_exists</span><span class="p">:</span>
            <span class="n">db_path_validated</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;scaffold_location&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;scaffold_location&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map_elements</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span><span class="n">return_dtype</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">Boolean</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;scaffold_exists&quot;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;scaffold_exists&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">db_path_validated</span><span class="o">.</span><span class="n">height</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">db_path_validated</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2"> scaffolds that do not exist: </span><span class="si">{</span><span class="n">db_path_validated</span><span class="p">[</span><span class="s1">&#39;scaffold_location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1">### add log later</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span>
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a profile to the database.</span>
<span class="sd">        The data dictionary must contain the following and only the following keys:</span>

<span class="sd">        - profile_name</span>

<span class="sd">        - profile_location</span>

<span class="sd">        - scaffold_location</span>

<span class="sd">        - reference_db_id</span>

<span class="sd">        - gene_db_id</span>

<span class="sd">        Args:</span>
<span class="sd">            data (dict): The profile data to add.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">profile_item</span> <span class="o">=</span> <span class="n">ProfileItem</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
            <span class="n">lf</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">({</span>
                <span class="s2">&quot;profile_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">profile_item</span><span class="o">.</span><span class="n">profile_name</span><span class="p">],</span>
                <span class="s2">&quot;profile_location&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">profile_item</span><span class="o">.</span><span class="n">profile_location</span><span class="p">],</span>
                <span class="s2">&quot;scaffold_location&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">profile_item</span><span class="o">.</span><span class="n">scaffold_location</span><span class="p">],</span>
                <span class="s2">&quot;reference_db_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">profile_item</span><span class="o">.</span><span class="n">reference_db_id</span><span class="p">],</span>
                <span class="s2">&quot;gene_db_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">profile_item</span><span class="o">.</span><span class="n">gene_db_id</span><span class="p">]</span>
            <span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">lf</span><span class="p">])</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_db</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The profile data provided is not valid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">add_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_database</span><span class="p">:</span> <span class="n">ProfileDatabase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge the provided profile database into the current database.</span>

<span class="sd">        Args:</span>
<span class="sd">            profile_database (ProfileDatabase): The profile database to merge.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">profile_database</span><span class="o">.</span><span class="n">_validate_db</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The profile database provided is not valid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">profile_database</span><span class="o">.</span><span class="n">db</span><span class="p">])</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">save_as_new_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the database to a parquet file.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_path (str): The path to save the database to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#The new database must be written to a new location</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_loc</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The output path must be different from the current database location.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">sink_parquet</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_loc</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="c1">### add log later</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span> 
        <span class="c1">### add log later</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Overwrites the database saved on the disk to the current database object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;db_loc attribute is not determined yet!&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_loc</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Something went wrong when updating the database:</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_csv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProfileDatabase</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a ProfileDatabase instance from a CSV file with exactly same columns as the required columns for a profile database.</span>

<span class="sd">        Args:</span>
<span class="sd">            csv_path (str): The path to the CSV file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ProfileDatabase: The created ProfileDatabase instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lf</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">scan_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span> <span class="c1"># To avoid clash when using to_csv on same file</span>
        <span class="n">prof_db</span><span class="o">=</span><span class="bp">cls</span><span class="p">()</span>
        <span class="n">prof_db</span><span class="o">.</span><span class="n">_db</span><span class="o">=</span><span class="n">lf</span>
        <span class="n">prof_db</span><span class="o">.</span><span class="n">_validate_db</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">prof_db</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">output_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Writes the the current database object to a csv file&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            output_dir (str): The path to save the CSV file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">sink_csv</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.ProfileDatabase.add_database" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_database</span><span class="p">(</span><span class="n">profile_database</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Merge the provided profile database into the current database.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>profile_database</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ProfileDatabase (zipstrain.database.ProfileDatabase)" href="#zipstrain.database.ProfileDatabase">ProfileDatabase</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The profile database to merge.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_database</span><span class="p">:</span> <span class="n">ProfileDatabase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge the provided profile database into the current database.</span>

<span class="sd">    Args:</span>
<span class="sd">        profile_database (ProfileDatabase): The profile database to merge.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">profile_database</span><span class="o">.</span><span class="n">_validate_db</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The profile database provided is not valid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">profile_database</span><span class="o">.</span><span class="n">db</span><span class="p">])</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.ProfileDatabase.add_profile" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_profile</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Add a profile to the database.
The data dictionary must contain the following and only the following keys:</p>
<ul>
<li>
<p>profile_name</p>
</li>
<li>
<p>profile_location</p>
</li>
<li>
<p>scaffold_location</p>
</li>
<li>
<p>reference_db_id</p>
</li>
<li>
<p>gene_db_id</p>
</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The profile data to add.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span>
                <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a profile to the database.</span>
<span class="sd">    The data dictionary must contain the following and only the following keys:</span>

<span class="sd">    - profile_name</span>

<span class="sd">    - profile_location</span>

<span class="sd">    - scaffold_location</span>

<span class="sd">    - reference_db_id</span>

<span class="sd">    - gene_db_id</span>

<span class="sd">    Args:</span>
<span class="sd">        data (dict): The profile data to add.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">profile_item</span> <span class="o">=</span> <span class="n">ProfileItem</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
        <span class="n">lf</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">({</span>
            <span class="s2">&quot;profile_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">profile_item</span><span class="o">.</span><span class="n">profile_name</span><span class="p">],</span>
            <span class="s2">&quot;profile_location&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">profile_item</span><span class="o">.</span><span class="n">profile_location</span><span class="p">],</span>
            <span class="s2">&quot;scaffold_location&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">profile_item</span><span class="o">.</span><span class="n">scaffold_location</span><span class="p">],</span>
            <span class="s2">&quot;reference_db_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">profile_item</span><span class="o">.</span><span class="n">reference_db_id</span><span class="p">],</span>
            <span class="s2">&quot;gene_db_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">profile_item</span><span class="o">.</span><span class="n">gene_db_id</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">lf</span><span class="p">])</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_db</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The profile data provided is not valid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.ProfileDatabase.from_csv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Create a ProfileDatabase instance from a CSV file with exactly same columns as the required columns for a profile database.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>csv_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the CSV file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>ProfileDatabase</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="ProfileDatabase (zipstrain.database.ProfileDatabase)" href="#zipstrain.database.ProfileDatabase">ProfileDatabase</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The created ProfileDatabase instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_csv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProfileDatabase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a ProfileDatabase instance from a CSV file with exactly same columns as the required columns for a profile database.</span>

<span class="sd">    Args:</span>
<span class="sd">        csv_path (str): The path to the CSV file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ProfileDatabase: The created ProfileDatabase instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lf</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">scan_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span> <span class="c1"># To avoid clash when using to_csv on same file</span>
    <span class="n">prof_db</span><span class="o">=</span><span class="bp">cls</span><span class="p">()</span>
    <span class="n">prof_db</span><span class="o">.</span><span class="n">_db</span><span class="o">=</span><span class="n">lf</span>
    <span class="n">prof_db</span><span class="o">.</span><span class="n">_validate_db</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">prof_db</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.ProfileDatabase.save_as_new_database" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_as_new_database</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Save the database to a parquet file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to save the database to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_as_new_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the database to a parquet file.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_path (str): The path to save the database to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#The new database must be written to a new location</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_loc</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The output path must be different from the current database location.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">sink_parquet</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_loc</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="c1">### add log later</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">pass</span> 
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.ProfileDatabase.to_csv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_csv</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Writes the the current database object to a csv file"</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to save the CSV file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">output_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes the the current database object to a csv file&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        output_dir (str): The path to save the CSV file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">sink_csv</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.database.ProfileDatabase.update_database" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_database</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Overwrites the database saved on the disk to the current database object</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Overwrites the database saved on the disk to the current database object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_loc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;db_loc attribute is not determined yet!&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_loc</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Something went wrong when updating the database:</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.database.ProfileItem" class="doc doc-heading">
            <code>ProfileItem</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>


        <p>This class describes all necessary attributes of a profile and makes sure they comply with the necessary formating.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/database.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProfileItem</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class describes all necessary attributes of a profile and makes sure they comply with the necessary formating.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">)</span>
    <span class="n">profile_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;An arbitrary name given to the profile (Usually sample name or name of the parquet file)&quot;</span><span class="p">)</span>
    <span class="n">profile_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;The location of the profile&quot;</span><span class="p">)</span>
    <span class="n">scaffold_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;The location of the scaffold&quot;</span><span class="p">)</span>
    <span class="n">reference_db_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;The ID of the reference database. This could be the name or any other identifier for the database that the reads are mapped to.&quot;</span><span class="p">)</span>
    <span class="n">gene_db_id</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;The ID of the gene database in fasta format. This could be the name or any other identifier for the database that the reads are mapped to.&quot;</span><span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;profile_location&quot;</span><span class="p">,</span><span class="s2">&quot;scaffold_location&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_file_exists</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;reference_db_id&quot;</span><span class="p">,</span><span class="s2">&quot;gene_db_id&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_reference_db_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The reference_db_id and gene_db_id cannot be empty.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><hr />
<h2 id="profile">Profile</h2>


<div class="doc doc-object doc-module">



<a id="zipstrain.profile"></a>
    <div class="doc doc-contents first">

        <h4 id="zipstrain.profile--zipstrainprofile">zipstrain.profile</h4>
<p>This module provides functions and utilities to profile a bamfile.
By profile we mean generating gene, genome, and nucleotide counts at each position on the reference.
This is a fundamental step for downstream analysis in zipstrain.</p>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="zipstrain.profile.build_gene_loc_table" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_gene_loc_table</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">,</span> <span class="n">scaffold</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Build a gene location table from a FASTA file.</p>
<p>Parameters:
fasta_file (pathlib.Path): Path to the FASTA file.</p>
<p>Returns:
pl.DataFrame: A Polars DataFrame containing gene locations.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/profile.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_gene_loc_table</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">:</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span><span class="n">scaffold</span><span class="p">:</span><span class="nb">set</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a gene location table from a FASTA file.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    fasta_file (pathlib.Path): Path to the FASTA file.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pl.DataFrame: A Polars DataFrame containing gene locations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scaffolds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gene_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pos</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">genes</span> <span class="ow">in</span> <span class="n">parse_gene_loc_table</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">genes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">scaffold</span><span class="p">:</span>
            <span class="n">scaffolds</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">genes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">genes</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">genes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">gene_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">genes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">genes</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">genes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">genes</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">genes</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s2">&quot;scaffold&quot;</span><span class="p">:</span><span class="n">scaffolds</span><span class="p">,</span>
        <span class="s2">&quot;gene&quot;</span><span class="p">:</span><span class="n">gene_ids</span><span class="p">,</span>
        <span class="s2">&quot;pos&quot;</span><span class="p">:</span><span class="n">pos</span>
    <span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.profile.build_gene_range_table" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_gene_range_table</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Build a gene location table in the form of <gene scaffold start end> from a FASTA file.
Parameters:
fasta_file (pathlib.Path): Path to the FASTA file.</p>
<p>Returns:
pl.DataFrame: A Polars DataFrame containing gene locations.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/profile.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_gene_range_table</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">:</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a gene location table in the form of &lt;gene scaffold start end&gt; from a FASTA file.</span>
<span class="sd">    Parameters:</span>
<span class="sd">    fasta_file (pathlib.Path): Path to the FASTA file.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pl.DataFrame: A Polars DataFrame containing gene locations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">parsed_annot</span> <span class="ow">in</span> <span class="n">parse_gene_loc_table</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">):</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parsed_annot</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;scaffold&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">],</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.profile.get_strain_hetrogeneity" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_strain_hetrogeneity</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">stb</span><span class="p">,</span> <span class="n">min_cov</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">freq_threshold</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate strain heterogeneity for each genome based on nucleotide frequencies.
The definition of strain heterogeneity here is the fraction of sites that have enough coverage
(min_cov) and have a dominant nucleotide with frequency less than freq_threshold.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>profile</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The profile LazyFrame containing nucleotide counts.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>stb</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The scaffold-to-bin mapping LazyFrame. First column is 'scaffold', second column is 'bin'.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_cov</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The minimum coverage threshold.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>freq_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The frequency threshold for dominant nucleotides.</p>
              </div>
            </td>
            <td>
                  <code>0.8</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
pl.LazyFrame: A LazyFrame containing strain heterogeneity information grouped by genome.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/profile.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_strain_hetrogeneity</span><span class="p">(</span><span class="n">profile</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
                            <span class="n">stb</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> 
                            <span class="n">min_cov</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">freq_threshold</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate strain heterogeneity for each genome based on nucleotide frequencies.</span>
<span class="sd">    The definition of strain heterogeneity here is the fraction of sites that have enough coverage</span>
<span class="sd">    (min_cov) and have a dominant nucleotide with frequency less than freq_threshold.</span>

<span class="sd">    Args:</span>
<span class="sd">        profile (pl.LazyFrame): The profile LazyFrame containing nucleotide counts.</span>
<span class="sd">        stb (pl.LazyFrame): The scaffold-to-bin mapping LazyFrame. First column is &#39;scaffold&#39;, second column is &#39;bin&#39;.</span>
<span class="sd">        min_cov (int): The minimum coverage threshold.</span>
<span class="sd">        freq_threshold (float): The frequency threshold for dominant nucleotides.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pl.LazyFrame: A LazyFrame containing strain heterogeneity information grouped by genome.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate the total number of sites with sufficient coverage</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span><span class="o">+</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">+</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span><span class="o">+</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;coverage&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;coverage&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_cov</span><span class="p">)</span>

    <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">max_horizontal</span><span class="p">([</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;coverage&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">freq_threshold</span><span class="p">)</span>
        <span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int8</span><span class="p">)</span>
        <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;heterogeneous_site&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stb</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;chrom&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;scaffold&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total_sites_at_</span><span class="si">{</span><span class="n">min_cov</span><span class="si">}</span><span class="s2">_coverage&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;heterogeneous_site&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;heterogeneous_sites&quot;</span><span class="p">)</span>
    <span class="p">])</span>

    <span class="n">strain_heterogeneity</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;heterogeneous_sites&quot;</span><span class="p">)</span><span class="o">/</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total_sites_at_</span><span class="si">{</span><span class="n">min_cov</span><span class="si">}</span><span class="s2">_coverage&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;strain_heterogeneity&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">strain_heterogeneity</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.profile.parse_gene_loc_table" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parse_gene_loc_table</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Extract gene locations from a FASTA assuming it is from prodigal yield gene info.</p>
<p>Parameters:
fasta_file (pathlib.Path): Path to the FASTA file.</p>
        <p>Tuple: A tuple containing:
    - gene_ID
    - scaffold
    - start
    - end</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/profile.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse_gene_loc_table</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">:</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract gene locations from a FASTA assuming it is from prodigal yield gene info.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    fasta_file (pathlib.Path): Path to the FASTA file.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Tuple: A tuple containing:</span>
<span class="sd">        - gene_ID</span>
<span class="sd">        - scaffold</span>
<span class="sd">        - start</span>
<span class="sd">        - end</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fasta_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">):</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">gene_id</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">scaffold</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gene_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">end</span><span class="o">=</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>      
                <span class="k">yield</span> <span class="n">gene_id</span><span class="p">,</span> <span class="n">scaffold</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">end</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.profile.profile_bam" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">profile_bam</span><span class="p">(</span><span class="n">bed_file</span><span class="p">,</span> <span class="n">bam_file</span><span class="p">,</span> <span class="n">gene_range_table</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Profile a BAM file in chunks using provided BED files.</p>
<p>Parameters:
bed_file (list[pathlib.Path]): A bed file describing all regions to be profiled.
bam_file (pathlib.Path): Path to the BAM file.
gene_range_table (pathlib.Path): Path to the gene range table.
output_dir (pathlib.Path): Directory to save output files.
num_workers (int): Number of concurrent workers to use.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/profile.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">profile_bam</span><span class="p">(</span>
    <span class="n">bed_file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">bam_file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">gene_range_table</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">4</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Profile a BAM file in chunks using provided BED files.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    bed_file (list[pathlib.Path]): A bed file describing all regions to be profiled.</span>
<span class="sd">    bam_file (pathlib.Path): Path to the BAM file.</span>
<span class="sd">    gene_range_table (pathlib.Path): Path to the gene range table.</span>
<span class="sd">    output_dir (pathlib.Path): Directory to save output files.</span>
<span class="sd">    num_workers (int): Number of concurrent workers to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">profile_bam_in_chunks</span><span class="p">(</span>
        <span class="n">bed_file</span><span class="o">=</span><span class="n">bed_file</span><span class="p">,</span>
        <span class="n">bam_file</span><span class="o">=</span><span class="n">bam_file</span><span class="p">,</span>
        <span class="n">gene_range_table</span><span class="o">=</span><span class="n">gene_range_table</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span>
    <span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.profile.profile_bam_in_chunks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">profile_bam_in_chunks</span><span class="p">(</span><span class="n">bed_file</span><span class="p">,</span> <span class="n">bam_file</span><span class="p">,</span> <span class="n">gene_range_table</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Profile a BAM file in chunks using provided BED files.</p>
<p>Parameters:
bed_file (list[pathlib.Path]): A bed file describing all regions to be profiled.
bam_file (pathlib.Path): Path to the BAM file.
gene_range_table (pathlib.Path): Path to the gene range table.
output_dir (pathlib.Path): Directory to save output files.
num_workers (int): Number of concurrent workers to use.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/profile.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">profile_bam_in_chunks</span><span class="p">(</span>
    <span class="n">bed_file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">bam_file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">gene_range_table</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">4</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Profile a BAM file in chunks using provided BED files.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    bed_file (list[pathlib.Path]): A bed file describing all regions to be profiled.</span>
<span class="sd">    bam_file (pathlib.Path): Path to the BAM file.</span>
<span class="sd">    gene_range_table (pathlib.Path): Path to the gene range table.</span>
<span class="sd">    output_dir (pathlib.Path): Directory to save output files.</span>
<span class="sd">    num_workers (int): Number of concurrent workers to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">output_dir</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="n">bam_file</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">bam_file</span><span class="p">)</span>
    <span class="n">bed_file</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">bed_file</span><span class="p">)</span>
    <span class="n">gene_range_table</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">gene_range_table</span><span class="p">)</span>

    <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">(</span><span class="n">output_dir</span><span class="o">/</span><span class="s2">&quot;tmp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bed_lf</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">scan_csv</span><span class="p">(</span><span class="n">bed_file</span><span class="p">,</span><span class="n">has_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">bed_chunks</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">split_lf_to_chunks</span><span class="p">(</span><span class="n">bed_lf</span><span class="p">,</span><span class="n">num_workers</span><span class="p">)</span>
    <span class="n">bed_chunk_files</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">chunk_id</span><span class="p">,</span> <span class="n">bed_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bed_chunks</span><span class="p">):</span>
        <span class="n">bed_file</span><span class="o">.</span><span class="n">sink_csv</span><span class="p">(</span><span class="n">output_dir</span><span class="o">/</span><span class="s2">&quot;tmp&quot;</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;bed_chunk_</span><span class="si">{</span><span class="n">chunk_id</span><span class="si">}</span><span class="s2">.bed&quot;</span><span class="p">,</span><span class="n">include_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bed_chunk_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_dir</span><span class="o">/</span><span class="s2">&quot;tmp&quot;</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;bed_chunk_</span><span class="si">{</span><span class="n">chunk_id</span><span class="si">}</span><span class="s2">.bed&quot;</span><span class="p">)</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">chunk_id</span><span class="p">,</span> <span class="n">bed_chunk_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bed_chunk_files</span><span class="p">):</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_profile_chunk_task</span><span class="p">(</span>
            <span class="n">bed_file</span><span class="o">=</span><span class="n">bed_chunk_file</span><span class="p">,</span>
            <span class="n">bam_file</span><span class="o">=</span><span class="n">bam_file</span><span class="p">,</span>
            <span class="n">gene_range_table</span><span class="o">=</span><span class="n">gene_range_table</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="o">/</span><span class="s2">&quot;tmp&quot;</span><span class="p">,</span>
            <span class="n">chunk_id</span><span class="o">=</span><span class="n">chunk_id</span>
        <span class="p">))</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span> 
    <span class="n">pfs</span><span class="o">=</span><span class="p">[</span><span class="n">output_dir</span><span class="o">/</span><span class="s2">&quot;tmp&quot;</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bam_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">chunk_id</span><span class="si">}</span><span class="s2">.parquet&quot;</span> <span class="k">for</span> <span class="n">chunk_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bed_chunk_files</span><span class="p">))]</span>
    <span class="n">mpileup_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span> <span class="k">for</span> <span class="n">pf</span> <span class="ow">in</span> <span class="n">pfs</span><span class="p">])</span>
    <span class="n">mpileup_df</span><span class="o">.</span><span class="n">sink_parquet</span><span class="p">(</span><span class="n">output_dir</span><span class="o">/</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bam_file</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;zstd&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -r </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/tmp&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="compare">Compare</h2>


<div class="doc doc-object doc-module">



<a id="zipstrain.compare"></a>
    <div class="doc doc-contents first">

        <h4 id="zipstrain.compare--zipstraincompare">zipstrain.compare</h4>
<p>This module provides all comparison functions for zipstrain.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h4 id="zipstrain.compare.PolarsANIExpressions" class="doc doc-heading">
            <code>PolarsANIExpressions</code>


</h4>


    <div class="doc doc-contents ">


        <p>Any kind of ANI calculation based on two profiles should be implemented as a method of this class.
In defining this method, the following rules should be followed:</p>
<ul>
<li>
<p>The method returns a Polars expression (pl.Expr).</p>
</li>
<li>
<p>When applied to a row, the method returns a zero if that position is a SNV. Otherwise it should return a number greater than zero.</p>
</li>
<li>
<p>A, T, C, G columns in the first profile are named "A", "T", "C", "G" and in the second profile they are named "A_2", "T_2", "C_2", "G_2".</p>
</li>
<li>
<p>popani: Population ANI based on the shared alleles between two profiles.</p>
</li>
<li>conani: Consensus ANI based on the consensus alleles between two profiles.</li>
<li>cosani_<threshold>: Generalized cosine similarity ANI where threshold is a float value between 0 and 1. Once the similarity is below the threshold, it is considered a SNV.</li>
</ul>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/compare.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PolarsANIExpressions</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Any kind of ANI calculation based on two profiles should be implemented as a method of this class.</span>
<span class="sd">    In defining this method, the following rules should be followed:</span>

<span class="sd">    -   The method returns a Polars expression (pl.Expr).</span>

<span class="sd">    -   When applied to a row, the method returns a zero if that position is a SNV. Otherwise it should return a number greater than zero.</span>

<span class="sd">    -   A, T, C, G columns in the first profile are named &quot;A&quot;, &quot;T&quot;, &quot;C&quot;, &quot;G&quot; and in the second profile they are named &quot;A_2&quot;, &quot;T_2&quot;, &quot;C_2&quot;, &quot;G_2&quot;.</span>

<span class="sd">    1. popani: Population ANI based on the shared alleles between two profiles.</span>
<span class="sd">    2. conani: Consensus ANI based on the consensus alleles between two profiles.</span>
<span class="sd">    3. cosani_&lt;threshold&gt;: Generalized cosine similarity ANI where threshold is a float value between 0 and 1. Once the similarity is below the threshold, it is considered a SNV.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MPILE_1_BASES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">]</span>
    <span class="n">MPILE_2_BASES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A_2&quot;</span><span class="p">,</span> <span class="s2">&quot;T_2&quot;</span><span class="p">,</span> <span class="s2">&quot;C_2&quot;</span><span class="p">,</span> <span class="s2">&quot;G_2&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">popani</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span><span class="o">*</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;A_2&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span><span class="o">*</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;C_2&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">)</span><span class="o">*</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;G_2&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">*</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;T_2&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">conani</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">max_base_1</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">max_horizontal</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MPILE_1_BASES</span><span class="p">])</span>
        <span class="n">max_base_2</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">max_horizontal</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MPILE_2_BASES</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">max_base_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;A_2&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">max_base_2</span><span class="p">)</span> <span class="o">|</span> 
                       <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">max_base_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;T_2&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">max_base_2</span><span class="p">)</span> <span class="o">|</span> 
                       <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">max_base_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;C_2&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">max_base_2</span><span class="p">)</span> <span class="o">|</span> 
                       <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">max_base_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;G_2&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">max_base_2</span><span class="p">))</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generalized_cos_ani</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">threshold</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
        <span class="n">dot_product</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span><span class="o">*</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;A_2&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span><span class="o">*</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;C_2&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">)</span><span class="o">*</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;G_2&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">*</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;T_2&quot;</span><span class="p">)</span>
        <span class="n">magnitude_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">magnitude_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;A_2&quot;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;C_2&quot;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;G_2&quot;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;T_2&quot;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">cos_sim</span> <span class="o">=</span> <span class="n">dot_product</span> <span class="o">/</span> <span class="p">(</span><span class="n">magnitude_1</span> <span class="o">*</span> <span class="n">magnitude_2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">cos_sim</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cosani_&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid threshold in method name: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">generalized_cos_ani</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h4 id="zipstrain.compare.add_contiguity_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_contiguity_info</span><span class="p">(</span><span class="n">mpile_contig</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Adds group id information to the lazy frame. If on the same scaffold and not popANI, then they are in the same group.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mpile_contig</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input LazyFrame containing mpileup data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pl.LazyFrame: Updated LazyFrame with group id information added.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/compare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_contiguity_info</span><span class="p">(</span><span class="n">mpile_contig</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Adds group id information to the lazy frame. If on the same scaffold and not popANI, then they are in the same group.</span>

<span class="sd">    Args:</span>
<span class="sd">        mpile_contig (pl.LazyFrame): The input LazyFrame containing mpileup data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: Updated LazyFrame with group id information added.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mpile_contig</span><span class="o">=</span> <span class="n">mpile_contig</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s2">&quot;scaffold&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">])</span>
    <span class="n">mpile_contig</span> <span class="o">=</span> <span class="n">mpile_contig</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;scaffold&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;scaffold&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;prev_scaffold&quot;</span><span class="p">)),</span>
    <span class="p">])</span>
    <span class="n">mpile_contig</span> <span class="o">=</span> <span class="n">mpile_contig</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
        <span class="p">(((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;scaffold&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;prev_scaffold&quot;</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;surr&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span><span class="o">.</span><span class="n">cum_sum</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;group_id&quot;</span><span class="p">)</span>
    <span class="p">])</span>
    <span class="k">return</span> <span class="n">mpile_contig</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.compare.add_genome_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_genome_info</span><span class="p">(</span><span class="n">mpile_contig</span><span class="p">,</span> <span class="n">scaffold_to_genome</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Adds genome information to the mpileup LazyFrame based on scaffold to genome mapping.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mpile_contig</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input LazyFrame containing mpileup data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scaffold_to_genome</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The LazyFrame mapping scaffolds to genomes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pl.LazyFrame: Updated LazyFrame with genome information added.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/compare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_genome_info</span><span class="p">(</span><span class="n">mpile_contig</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">scaffold_to_genome</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds genome information to the mpileup LazyFrame based on scaffold to genome mapping.</span>

<span class="sd">    Args:</span>
<span class="sd">        mpile_contig (pl.LazyFrame): The input LazyFrame containing mpileup data.</span>
<span class="sd">        scaffold_to_genome (pl.LazyFrame): The LazyFrame mapping scaffolds to genomes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: Updated LazyFrame with genome information added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">mpile_contig</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">scaffold_to_genome</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;scaffold&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="s2">&quot;NA&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.compare.adjust_for_sequence_errors" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">adjust_for_sequence_errors</span><span class="p">(</span><span class="n">mpile_frame</span><span class="p">,</span> <span class="n">null_model</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Adjust the mpile frame for sequence errors based on the null model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mpile_frame</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input LazyFrame containing coverage data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>null_model</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The null model LazyFrame containing error counts.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pl.LazyFrame: Adjusted LazyFrame with sequence errors accounted for.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/compare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">adjust_for_sequence_errors</span><span class="p">(</span><span class="n">mpile_frame</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">null_model</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adjust the mpile frame for sequence errors based on the null model.</span>

<span class="sd">    Args:</span>
<span class="sd">        mpile_frame (pl.LazyFrame): The input LazyFrame containing coverage data.</span>
<span class="sd">        null_model (pl.LazyFrame): The null model LazyFrame containing error counts.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: Adjusted LazyFrame with sequence errors accounted for.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">mpile_frame</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">null_model</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;cov&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;max_error_count&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">base</span><span class="p">))</span>
        <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">]</span>
    <span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;max_error_count&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.compare.calculate_pop_ani" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_pop_ani</span><span class="p">(</span><span class="n">mpile_contig</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculates the population ANI (Average Nucleotide Identity) for the given mpileup LazyFrame.
NOTE: Remember that this function should be applied to the merged mpileup using get_shared_locs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mpile_contig</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input LazyFrame containing mpileup data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pl.LazyFrame: Updated LazyFrame with population ANI information added.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/compare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_pop_ani</span><span class="p">(</span><span class="n">mpile_contig</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the population ANI (Average Nucleotide Identity) for the given mpileup LazyFrame.</span>
<span class="sd">    NOTE: Remember that this function should be applied to the merged mpileup using get_shared_locs.</span>

<span class="sd">    Args:</span>
<span class="sd">        mpile_contig (pl.LazyFrame): The input LazyFrame containing mpileup data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: Updated LazyFrame with population ANI information added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">mpile_contig</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="n">total_positions</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">(),</span>
            <span class="n">share_allele_pos</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;surr&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">genome_pop_ani</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;share_allele_pos&quot;</span><span class="p">)</span><span class="o">/</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_positions&quot;</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.compare.compare_genes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compare_genes</span><span class="p">(</span><span class="n">mpile_contig_1</span><span class="p">,</span> <span class="n">mpile_contig_2</span><span class="p">,</span> <span class="n">null_model</span><span class="p">,</span> <span class="n">scaffold_to_genome</span><span class="p">,</span> <span class="n">min_cov</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_gene_compare_len</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;streaming&#39;</span><span class="p">,</span> <span class="n">ani_method</span><span class="o">=</span><span class="s1">&#39;popani&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compares two profiles and generates gene-level comparison statistics.
The final output is a Polars LazyFrame with gene comparison statistics in the following columns:
- genome: The genome identifier.
- gene: The gene identifier.
- total_positions: Total number of positions compared in the gene.
- share_allele_pos: Number of positions with shared alleles in the gene.
- ani: Average Nucleotide Identity (ANI) percentage for the gene.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mpile_contig_1</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The first profile as a LazyFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mpile_contig_2</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The second profile as a LazyFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>null_model</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The null model LazyFrame that contains the thresholds for sequence error adjustment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scaffold_to_genome</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A mapping LazyFrame from scaffolds to genomes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_cov</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum coverage threshold for filtering positions. Default is 5.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_gene_compare_len</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum length of genes that needs to be covered to consider for comparison. Default is 100.</p>
              </div>
            </td>
            <td>
                  <code>100</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>engine</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Polars engine to use for computation. Default is "streaming".</p>
              </div>
            </td>
            <td>
                  <code>&#39;streaming&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ani_method</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ANI calculation method to use. Default is "popani".</p>
              </div>
            </td>
            <td>
                  <code>&#39;popani&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pl.LazyFrame: A LazyFrame containing gene-level comparison statistics.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/compare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compare_genes</span><span class="p">(</span><span class="n">mpile_contig_1</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
              <span class="n">mpile_contig_2</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
              <span class="n">null_model</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
              <span class="n">scaffold_to_genome</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
              <span class="n">min_cov</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
              <span class="n">min_gene_compare_len</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
              <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">,</span>
              <span class="n">ani_method</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;popani&quot;</span>
            <span class="p">)</span><span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares two profiles and generates gene-level comparison statistics.</span>
<span class="sd">    The final output is a Polars LazyFrame with gene comparison statistics in the following columns:</span>
<span class="sd">    - genome: The genome identifier.</span>
<span class="sd">    - gene: The gene identifier.</span>
<span class="sd">    - total_positions: Total number of positions compared in the gene.</span>
<span class="sd">    - share_allele_pos: Number of positions with shared alleles in the gene.</span>
<span class="sd">    - ani: Average Nucleotide Identity (ANI) percentage for the gene.</span>

<span class="sd">    Args:</span>
<span class="sd">        mpile_contig_1 (pl.LazyFrame): The first profile as a LazyFrame.</span>
<span class="sd">        mpile_contig_2 (pl.LazyFrame): The second profile as a LazyFrame.</span>
<span class="sd">        null_model (pl.LazyFrame): The null model LazyFrame that contains the thresholds for sequence error adjustment.</span>
<span class="sd">        scaffold_to_genome (pl.LazyFrame): A mapping LazyFrame from scaffolds to genomes.</span>
<span class="sd">        min_cov (int): Minimum coverage threshold for filtering positions. Default is 5.</span>
<span class="sd">        min_gene_compare_len (int): Minimum length of genes that needs to be covered to consider for comparison. Default is 100.</span>
<span class="sd">        engine (str): The Polars engine to use for computation. Default is &quot;streaming&quot;.</span>
<span class="sd">        ani_method (str): The ANI calculation method to use. Default is &quot;popani&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: A LazyFrame containing gene-level comparison statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lf1</span><span class="o">=</span><span class="n">coverage_filter</span><span class="p">(</span><span class="n">mpile_contig_1</span><span class="p">,</span> <span class="n">min_cov</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">lf1</span><span class="o">=</span><span class="n">adjust_for_sequence_errors</span><span class="p">(</span><span class="n">lf1</span><span class="p">,</span> <span class="n">null_model</span><span class="p">)</span>
    <span class="n">lf2</span><span class="o">=</span><span class="n">coverage_filter</span><span class="p">(</span><span class="n">mpile_contig_2</span><span class="p">,</span> <span class="n">min_cov</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">lf2</span><span class="o">=</span><span class="n">adjust_for_sequence_errors</span><span class="p">(</span><span class="n">lf2</span><span class="p">,</span> <span class="n">null_model</span><span class="p">)</span>
    <span class="c1">### Now we need to only keep (scaffold, pos) that are in both lf1 and lf2</span>
    <span class="n">lf</span> <span class="o">=</span> <span class="n">get_shared_locs</span><span class="p">(</span><span class="n">lf1</span><span class="p">,</span> <span class="n">lf2</span><span class="p">,</span> <span class="n">ani_method</span><span class="o">=</span><span class="n">ani_method</span><span class="p">)</span>
    <span class="c1">## Let&#39;s add genome information for all scaffolds and positions</span>
    <span class="n">lf</span> <span class="o">=</span> <span class="n">add_genome_info</span><span class="p">(</span><span class="n">lf</span><span class="p">,</span> <span class="n">scaffold_to_genome</span><span class="p">)</span>
    <span class="c1">## Let&#39;s calculate gene ani for each gene in each genome</span>
    <span class="n">gene_comp</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">group_by</span><span class="p">([</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span> <span class="s2">&quot;gene&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">total_positions</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">(),</span>
        <span class="n">share_allele_pos</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;surr&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_positions&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_gene_compare_len</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">ani</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;share_allele_pos&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_positions&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">gene_comp</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.compare.compare_genomes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compare_genomes</span><span class="p">(</span><span class="n">mpile_contig_1</span><span class="p">,</span> <span class="n">mpile_contig_2</span><span class="p">,</span> <span class="n">null_model</span><span class="p">,</span> <span class="n">scaffold_to_genome</span><span class="p">,</span> <span class="n">min_cov</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_gene_compare_len</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">memory_mode</span><span class="o">=</span><span class="s1">&#39;heavy&#39;</span><span class="p">,</span> <span class="n">chrom_batch_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">shared_scaffolds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaffold_scope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;streaming&#39;</span><span class="p">,</span> <span class="n">ani_method</span><span class="o">=</span><span class="s1">&#39;popani&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compares two profiles and generates genome-level comparison statistics.
The final output is a Polars LazyFrame with genome comparison statisticsin the following columns:</p>
<ul>
<li>
<p>genome: The genome identifier.</p>
</li>
<li>
<p>total_positions: Total number of positions compared.</p>
</li>
<li>
<p>share_allele_pos: Number of positions with shared alleles.</p>
</li>
<li>
<p>genome_pop_ani: Population ANI percentage.</p>
</li>
<li>
<p>max_consecutive_length: Length of the longest consecutive block of shared alleles.</p>
</li>
<li>
<p>shared_genes_count: Number of genes compared.</p>
</li>
<li>
<p>identical_gene_count: Number of identical genes.</p>
</li>
<li>
<p>perc_id_genes: Percentage of identical genes.</p>
</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mpile_contig_1</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The first profile as a LazyFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mpile_contig_2</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The second profile as a LazyFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>null_model</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The null model LazyFrame that contains the thresholds for sequence error adjustment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scaffold_to_genome</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A mapping LazyFrame from scaffolds to genomes.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_cov</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum coverage threshold for filtering positions. Default is 5.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_gene_compare_len</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum length of genes that needs to be covered to consider for comparison. Default is 100.</p>
              </div>
            </td>
            <td>
                  <code>100</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>memory_mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Memory mode for processing. Options are "heavy" or "light". Default is "heavy".</p>
              </div>
            </td>
            <td>
                  <code>&#39;heavy&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chrom_batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size for processing scaffolds in light memory mode. Default</p>
              </div>
            </td>
            <td>
                  <code>10000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>shared_scaffolds</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of shared scaffolds between the two profiles. Required for light memory mode.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>scaffold_scope</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of scaffolds to limit the comparison to. Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>engine</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Polars engine to use for computation. Default is "streaming".</p>
              </div>
            </td>
            <td>
                  <code>&#39;streaming&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ani_method</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ANI calculation method to use. Default is "popani".</p>
              </div>
            </td>
            <td>
                  <code>&#39;popani&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pl.LazyFrame: A LazyFrame containing genome-level comparison statistics.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/compare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compare_genomes</span><span class="p">(</span><span class="n">mpile_contig_1</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
              <span class="n">mpile_contig_2</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
              <span class="n">null_model</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
              <span class="n">scaffold_to_genome</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
              <span class="n">min_cov</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
              <span class="n">min_gene_compare_len</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
              <span class="n">memory_mode</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;heavy&quot;</span><span class="p">,</span>
              <span class="n">chrom_batch_size</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
              <span class="n">shared_scaffolds</span><span class="p">:</span><span class="nb">list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">scaffold_scope</span><span class="p">:</span><span class="nb">list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">,</span>
              <span class="n">ani_method</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;popani&quot;</span>
            <span class="p">)</span><span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares two profiles and generates genome-level comparison statistics.</span>
<span class="sd">    The final output is a Polars LazyFrame with genome comparison statisticsin the following columns:</span>

<span class="sd">    - genome: The genome identifier.</span>

<span class="sd">    - total_positions: Total number of positions compared.</span>

<span class="sd">    - share_allele_pos: Number of positions with shared alleles.</span>

<span class="sd">    - genome_pop_ani: Population ANI percentage.</span>

<span class="sd">    - max_consecutive_length: Length of the longest consecutive block of shared alleles.</span>

<span class="sd">    - shared_genes_count: Number of genes compared.</span>

<span class="sd">    - identical_gene_count: Number of identical genes.</span>

<span class="sd">    - perc_id_genes: Percentage of identical genes.</span>

<span class="sd">    Args:</span>
<span class="sd">        mpile_contig_1 (pl.LazyFrame): The first profile as a LazyFrame.</span>
<span class="sd">        mpile_contig_2 (pl.LazyFrame): The second profile as a LazyFrame.</span>
<span class="sd">        null_model (pl.LazyFrame): The null model LazyFrame that contains the thresholds for sequence error adjustment.</span>
<span class="sd">        scaffold_to_genome (pl.LazyFrame): A mapping LazyFrame from scaffolds to genomes.</span>
<span class="sd">        min_cov (int): Minimum coverage threshold for filtering positions. Default is 5.</span>
<span class="sd">        min_gene_compare_len (int): Minimum length of genes that needs to be covered to consider for comparison. Default is 100.</span>
<span class="sd">        memory_mode (str): Memory mode for processing. Options are &quot;heavy&quot; or &quot;light&quot;. Default is &quot;heavy&quot;.</span>
<span class="sd">        chrom_batch_size (int): Batch size for processing scaffolds in light memory mode. Default</span>
<span class="sd">        shared_scaffolds (list): List of shared scaffolds between the two profiles. Required for light memory mode.</span>
<span class="sd">        scaffold_scope (list): List of scaffolds to limit the comparison to. Default is None.</span>
<span class="sd">        engine (str): The Polars engine to use for computation. Default is &quot;streaming&quot;.</span>
<span class="sd">        ani_method (str): The ANI calculation method to use. Default is &quot;popani&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: A LazyFrame containing genome-level comparison statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">memory_mode</span> <span class="o">==</span> <span class="s2">&quot;heavy&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scaffold_scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mpile_contig_1</span> <span class="o">=</span> <span class="n">mpile_contig_1</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;chrom&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">scaffold_scope</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
            <span class="n">mpile_contig_2</span> <span class="o">=</span> <span class="n">mpile_contig_2</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;chrom&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">scaffold_scope</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
        <span class="n">lf1</span><span class="o">=</span><span class="n">coverage_filter</span><span class="p">(</span><span class="n">mpile_contig_1</span><span class="p">,</span> <span class="n">min_cov</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
        <span class="n">lf1</span><span class="o">=</span><span class="n">adjust_for_sequence_errors</span><span class="p">(</span><span class="n">lf1</span><span class="p">,</span> <span class="n">null_model</span><span class="p">)</span>
        <span class="n">lf2</span><span class="o">=</span><span class="n">coverage_filter</span><span class="p">(</span><span class="n">mpile_contig_2</span><span class="p">,</span> <span class="n">min_cov</span><span class="p">,</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
        <span class="n">lf2</span><span class="o">=</span><span class="n">adjust_for_sequence_errors</span><span class="p">(</span><span class="n">lf2</span><span class="p">,</span> <span class="n">null_model</span><span class="p">)</span>
        <span class="c1">### Now we need to only keep (scaffold, pos) that are in both lf1 and lf2</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="n">get_shared_locs</span><span class="p">(</span><span class="n">lf1</span><span class="p">,</span> <span class="n">lf2</span><span class="p">,</span> <span class="n">ani_method</span><span class="o">=</span><span class="n">ani_method</span><span class="p">)</span>
        <span class="c1">## Add Contiguity Information</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="n">add_contiguity_info</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span>
        <span class="c1">## Let&#39;s add genome information for all scaffolds and positions</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="n">add_genome_info</span><span class="p">(</span><span class="n">lf</span><span class="p">,</span> <span class="n">scaffold_to_genome</span><span class="p">)</span>
        <span class="c1">## Let&#39;s calculate popANI</span>
        <span class="n">genome_comp</span><span class="o">=</span> <span class="n">calculate_pop_ani</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span>
        <span class="c1">## Calculate longest consecutive blocks</span>
        <span class="n">max_consecutive_per_genome</span> <span class="o">=</span> <span class="n">get_longest_consecutive_blocks</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span>
        <span class="c1">## Calculate gene ani for each gene in each genome</span>
        <span class="n">gene</span><span class="o">=</span> <span class="n">get_gene_ani</span><span class="p">(</span><span class="n">lf</span><span class="p">,</span> <span class="n">min_gene_compare_len</span><span class="p">)</span>
        <span class="n">genome_comp</span><span class="o">=</span><span class="n">genome_comp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">max_consecutive_per_genome</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">genome_comp</span><span class="o">=</span><span class="n">genome_comp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gene</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">memory_mode</span> <span class="o">==</span> <span class="s2">&quot;light&quot;</span><span class="p">:</span>
        <span class="n">shared_scaffolds_batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">shared_scaffolds</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">chrom_batch_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shared_scaffolds</span><span class="p">),</span> <span class="n">chrom_batch_size</span><span class="p">)]</span>
        <span class="n">lf_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">scaffold</span> <span class="ow">in</span> <span class="n">shared_scaffolds_batches</span><span class="p">:</span>
            <span class="n">lf1</span><span class="o">=</span> <span class="n">coverage_filter</span><span class="p">(</span><span class="n">mpile_contig_1</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;chrom&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">scaffold</span><span class="p">)),</span> <span class="n">min_cov</span><span class="p">)</span>
            <span class="n">lf1</span><span class="o">=</span><span class="n">adjust_for_sequence_errors</span><span class="p">(</span><span class="n">lf1</span><span class="p">,</span> <span class="n">null_model</span><span class="p">)</span>
            <span class="n">lf2</span><span class="o">=</span> <span class="n">coverage_filter</span><span class="p">(</span><span class="n">mpile_contig_2</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;chrom&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">scaffold</span><span class="p">)),</span> <span class="n">min_cov</span><span class="p">)</span>
            <span class="n">lf2</span><span class="o">=</span><span class="n">adjust_for_sequence_errors</span><span class="p">(</span><span class="n">lf2</span><span class="p">,</span> <span class="n">null_model</span><span class="p">)</span>
            <span class="c1">### Now we need to only keep (scaffold, pos) that are in both lf1 and lf2</span>
            <span class="n">lf</span> <span class="o">=</span> <span class="n">get_shared_locs</span><span class="p">(</span><span class="n">lf1</span><span class="p">,</span> <span class="n">lf2</span><span class="p">,</span> <span class="n">ani_method</span><span class="o">=</span><span class="n">ani_method</span><span class="p">)</span>
            <span class="c1">## Lets add contiguity information</span>
            <span class="n">lf</span><span class="o">=</span> <span class="n">add_contiguity_info</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span>
            <span class="n">lf_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span>
        <span class="n">lf</span><span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">lf_list</span><span class="p">)</span>
        <span class="n">lf</span><span class="o">=</span> <span class="n">add_genome_info</span><span class="p">(</span><span class="n">lf</span><span class="p">,</span> <span class="n">scaffold_to_genome</span><span class="p">)</span>
        <span class="n">genome_comp</span><span class="o">=</span> <span class="n">calculate_pop_ani</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span>
        <span class="n">max_consecutive_per_genome</span> <span class="o">=</span> <span class="n">get_longest_consecutive_blocks</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span>
        <span class="n">gene</span><span class="o">=</span> <span class="n">get_gene_ani</span><span class="p">(</span><span class="n">lf</span><span class="p">,</span> <span class="n">min_gene_compare_len</span><span class="p">)</span>
        <span class="n">genome_comp</span><span class="o">=</span><span class="n">genome_comp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">max_consecutive_per_genome</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">genome_comp</span><span class="o">=</span><span class="n">genome_comp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gene</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid memory_mode. Choose either &#39;heavy&#39; or &#39;light&#39;.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">genome_comp</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.compare.coverage_filter" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">coverage_filter</span><span class="p">(</span><span class="n">mpile_frame</span><span class="p">,</span> <span class="n">min_cov</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Filter the mpile lazyframe based on minimum coverage at each loci.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mpile_frame</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input LazyFrame containing coverage data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_cov</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The minimum coverage threshold.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pl.LazyFrame: Filtered LazyFrame with positions having coverage &gt;= min_cov.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/compare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">coverage_filter</span><span class="p">(</span><span class="n">mpile_frame</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">min_cov</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span><span class="n">engine</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter the mpile lazyframe based on minimum coverage at each loci.</span>

<span class="sd">    Args:</span>
<span class="sd">        mpile_frame (pl.LazyFrame): The input LazyFrame containing coverage data.</span>
<span class="sd">        min_cov (int): The minimum coverage threshold.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: Filtered LazyFrame with positions having coverage &gt;= min_cov.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mpile_frame</span> <span class="o">=</span> <span class="n">mpile_frame</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;cov&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">mpile_frame</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;cov&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_cov</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.compare.get_gene_ani" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_gene_ani</span><span class="p">(</span><span class="n">mpile_contig</span><span class="p">,</span> <span class="n">min_gene_compare_len</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculates gene ANI (Average Nucleotide Identity) for each gene in each genome.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mpile_contig</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input LazyFrame containing mpileup data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_gene_compare_len</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum length of the gene to consider for comparison.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pl.LazyFrame: Updated LazyFrame with gene ANI information added.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/compare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_gene_ani</span><span class="p">(</span><span class="n">mpile_contig</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">min_gene_compare_len</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates gene ANI (Average Nucleotide Identity) for each gene in each genome.</span>

<span class="sd">    Args:</span>
<span class="sd">        mpile_contig (pl.LazyFrame): The input LazyFrame containing mpileup data.</span>
<span class="sd">        min_gene_compare_len (int): Minimum length of the gene to consider for comparison.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: Updated LazyFrame with gene ANI information added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">mpile_contig</span><span class="o">.</span><span class="n">group_by</span><span class="p">([</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span> <span class="s2">&quot;gene&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">total_positions</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">(),</span>
        <span class="n">share_allele_pos</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;surr&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_positions&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_gene_compare_len</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">identical</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;share_allele_pos&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_positions&quot;</span><span class="p">)),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;gene&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;NA&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">shared_genes_count</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">(),</span>
        <span class="n">identical_gene_count</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;identical&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">perc_id_genes</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;identical_gene_count&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;shared_genes_count&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.compare.get_longest_consecutive_blocks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_longest_consecutive_blocks</span><span class="p">(</span><span class="n">mpile_contig</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculates the longest consecutive blocks for each genome in the mpileup LazyFrame for any genome.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mpile_contig</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input LazyFrame containing mpileup data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pl.LazyFrame: Updated LazyFrame with longest consecutive blocks information added.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/compare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_longest_consecutive_blocks</span><span class="p">(</span><span class="n">mpile_contig</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the longest consecutive blocks for each genome in the mpileup LazyFrame for any genome.</span>

<span class="sd">    Args:</span>
<span class="sd">        mpile_contig (pl.LazyFrame): The input LazyFrame containing mpileup data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: Updated LazyFrame with longest consecutive blocks information added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">block_lengths</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">mpile_contig</span><span class="o">.</span><span class="n">group_by</span><span class="p">([</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span> <span class="s2">&quot;scaffold&quot;</span><span class="p">,</span> <span class="s2">&quot;group_id&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">))</span>
    <span class="p">)</span> 
    <span class="k">return</span> <span class="n">block_lengths</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;max_consecutive_length&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.compare.get_shared_locs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_shared_locs</span><span class="p">(</span><span class="n">mpile_contig_1</span><span class="p">,</span> <span class="n">mpile_contig_2</span><span class="p">,</span> <span class="n">ani_method</span><span class="o">=</span><span class="s1">&#39;popani&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Returns a lazyframe with ATCG information for shared scaffolds and positions between two mpileup files.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mpile_contig_1</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The first mpileup LazyFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mpile_contig_2</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The second mpileup LazyFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ani_method</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ANI calculation method to use. Default is "popani".</p>
              </div>
            </td>
            <td>
                  <code>&#39;popani&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pl.LazyFrame: Merged LazyFrame containing shared scaffolds and positions with ATCG information.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/compare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_shared_locs</span><span class="p">(</span><span class="n">mpile_contig_1</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">mpile_contig_2</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span><span class="n">ani_method</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;popani&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a lazyframe with ATCG information for shared scaffolds and positions between two mpileup files.</span>

<span class="sd">    Args:</span>
<span class="sd">        mpile_contig_1 (pl.LazyFrame): The first mpileup LazyFrame.</span>
<span class="sd">        mpile_contig_2 (pl.LazyFrame): The second mpileup LazyFrame.</span>
<span class="sd">        ani_method (str): The ANI calculation method to use. Default is &quot;popani&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: Merged LazyFrame containing shared scaffolds and positions with ATCG information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ani_expr</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">PolarsANIExpressions</span><span class="p">(),</span> <span class="n">ani_method</span><span class="p">)()</span>

    <span class="n">mpile_contig</span><span class="o">=</span> <span class="n">mpile_contig_1</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">mpile_contig_2</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;chrom&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
        <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;_2&quot;</span>  <span class="c1"># To distinguish lf2 columns</span>
    <span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">ani_expr</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;surr&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;surr&quot;</span><span class="p">),</span>
        <span class="n">scaffold</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;chrom&quot;</span><span class="p">),</span>
        <span class="n">pos</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;pos&quot;</span><span class="p">),</span>
        <span class="n">gene</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;gene&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">mpile_contig</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.compare.get_unique_scaffolds" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_unique_scaffolds</span><span class="p">(</span><span class="n">mpile_contig</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Retrieves unique scaffolds from the mpileup LazyFrame.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mpile_contig</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input LazyFrame containing mpileup data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of rows to process in each batch. Default is 10000.</p>
              </div>
            </td>
            <td>
                  <code>10000</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    set: A set of unique scaffold names.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/compare.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_unique_scaffolds</span><span class="p">(</span><span class="n">mpile_contig</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span><span class="n">batch_size</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves unique scaffolds from the mpileup LazyFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        mpile_contig (pl.LazyFrame): The input LazyFrame containing mpileup data.</span>
<span class="sd">        batch_size (int): The number of rows to process in each batch. Default is 10000.</span>
<span class="sd">    Returns:</span>
<span class="sd">        set: A set of unique scaffold names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scaffolds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">start_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">mpile_contig</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">start_index</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;chrom&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">height</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">scaffolds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chrom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
        <span class="n">start_index</span> <span class="o">+=</span> <span class="n">batch_size</span>
    <span class="k">return</span> <span class="n">scaffolds</span> 
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="utils">Utils</h2>


<div class="doc doc-object doc-module">



<a id="zipstrain.utils"></a>
    <div class="doc doc-contents first">

        <h4 id="zipstrain.utils--zipstrainutils">zipstrain.utils</h4>
<p>This module provides utility functions for profiling and compare operations.</p>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="zipstrain.utils.build_null_poisson" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_null_poisson</span><span class="p">(</span><span class="n">error_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">max_total_reads</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">p_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Build a null model to correct for sequencing errors based on the Poisson distribution.</p>
<p>Parameters:
error_rate (float): Error rate for the sequencing technology.
max_total_reads (int): Maximum total reads to consider.
p_threshold (float): Significance threshold for the Poisson distribution.</p>
<p>Returns:
pl.DataFrame: DataFrame containing total reads and maximum error count thresholds.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build_null_poisson</span><span class="p">(</span><span class="n">error_rate</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                       <span class="n">max_total_reads</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                       <span class="n">p_threshold</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a null model to correct for sequencing errors based on the Poisson distribution.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    error_rate (float): Error rate for the sequencing technology.</span>
<span class="sd">    max_total_reads (int): Maximum total reads to consider.</span>
<span class="sd">    p_threshold (float): Significance threshold for the Poisson distribution.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pl.DataFrame: DataFrame containing total reads and maximum error count thresholds.</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_total_reads</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="n">error_rate</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">poisson</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">p_threshold</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">records</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.utils.clean_bases" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clean_bases</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="n">indel_re</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Remove read start/end markers and indels from bases string using regex.
Returns cleaned uppercase string of bases only.
Args:
    bases (str): The bases string from mpileup.
    indel_re (re.Pattern): Compiled regex pattern to match indels and markers.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clean_bases</span><span class="p">(</span><span class="n">bases</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">indel_re</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">Pattern</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove read start/end markers and indels from bases string using regex.</span>
<span class="sd">    Returns cleaned uppercase string of bases only.</span>
<span class="sd">    Args:</span>
<span class="sd">        bases (str): The bases string from mpileup.</span>
<span class="sd">        indel_re (re.Pattern): Compiled regex pattern to match indels and markers.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bases</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">indel_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="c1"># indel length</span>
                <span class="n">indel_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span> <span class="o">+</span> <span class="n">indel_len</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cleaned</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bases</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.utils.collect_breadth_tables" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">collect_breadth_tables</span><span class="p">(</span><span class="n">breadth_tables</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Collect multiple genome breadth tables into a single LazyFrame.</p>
<p>Parameters:
breadth_tables (list[pl.LazyFrame]): List of LazyFrames containing genome breadth data.</p>
<p>Returns:
pl.LazyFrame: A LazyFrame containing the combined genome breadth data.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">collect_breadth_tables</span><span class="p">(</span>
    <span class="n">breadth_tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collect multiple genome breadth tables into a single LazyFrame.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    breadth_tables (list[pl.LazyFrame]): List of LazyFrames containing genome breadth data.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pl.LazyFrame: A LazyFrame containing the combined genome breadth data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">breadth_tables</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No breadth tables provided.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">coalesce</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">breadth_tables</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.utils.count_bases" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">count_bases</span><span class="p">(</span><span class="n">bases</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Count occurrences of A, C, G, T in the cleaned bases string.
Args:
    bases (str): Cleaned bases string.
Returns:
    dict: Dictionary with counts of A, C, G, T.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">count_bases</span><span class="p">(</span><span class="n">bases</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Count occurrences of A, C, G, T in the cleaned bases string.</span>
<span class="sd">    Args:</span>
<span class="sd">        bases (str): Cleaned bases string.</span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary with counts of A, C, G, T.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">bases</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.utils.extract_genome_length" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_genome_length</span><span class="p">(</span><span class="n">stb</span><span class="p">,</span> <span class="n">bed_table</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Extract the genome length information from the scaffold-to-genome mapping table.</p>
<p>Parameters:
stb (pl.LazyFrame): Scaffold-to-bin mapping table.
bed_table (pl.LazyFrame): BED table containing genomic regions.</p>
<p>Returns:
pl.LazyFrame: A LazyFrame containing the genome lengths.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_genome_length</span><span class="p">(</span><span class="n">stb</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> <span class="n">bed_table</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the genome length information from the scaffold-to-genome mapping table.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    stb (pl.LazyFrame): Scaffold-to-bin mapping table.</span>
<span class="sd">    bed_table (pl.LazyFrame): BED table containing genomic regions.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pl.LazyFrame: A LazyFrame containing the genome lengths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lf</span><span class="o">=</span> <span class="n">bed_table</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;scaffold&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;scaffold_length&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;scaffold&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">scaffold_length</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;scaffold_length&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;scaffold&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;scaffold&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;scaffold_length&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">stb</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;scaffold&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;scaffold&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;scaffold&quot;</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">genome_length</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;scaffold_length&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;genome_length&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">lf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.utils.get_genome_breadth_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_genome_breadth_matrix</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">genome_length</span><span class="p">,</span> <span class="n">stb</span><span class="p">,</span> <span class="n">min_cov</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get the genome breadth matrix from the provided profiles and scaffold-to-genome mapping.
Parameters:
profiles (list): List of tuples containing profile names and their corresponding LazyFrames.
stb (pl.LazyFrame): Scaffold-to-genome mapping table.
min_cov (int): Minimum coverage to consider a position. 
Returns:
pl.LazyFrame: A LazyFrame containing the genome breadth matrix.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_genome_breadth_matrix</span><span class="p">(</span>
                              <span class="n">profile</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
                              <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                              <span class="n">genome_length</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
                              <span class="n">stb</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
                              <span class="n">min_cov</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the genome breadth matrix from the provided profiles and scaffold-to-genome mapping.</span>
<span class="sd">    Parameters:</span>
<span class="sd">    profiles (list): List of tuples containing profile names and their corresponding LazyFrames.</span>
<span class="sd">    stb (pl.LazyFrame): Scaffold-to-genome mapping table.</span>
<span class="sd">    min_cov (int): Minimum coverage to consider a position. </span>
<span class="sd">    Returns:</span>
<span class="sd">    pl.LazyFrame: A LazyFrame containing the genome breadth matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">min_cov</span><span class="p">)</span>
    <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;chrom&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">breadth</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;chrom&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;scaffold&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;breadth&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">stb</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;scaffold&quot;</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
    <span class="p">)</span>
    <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">genome_length</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">genome_length</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="s2">&quot;genome_length&quot;</span><span class="p">),</span>
        <span class="n">breadth</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;breadth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;breadth&quot;</span><span class="p">)</span><span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;genome_length&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;breadth&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">profile</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">),</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;breadth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.utils.make_the_bed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_the_bed</span><span class="p">(</span><span class="n">db_fasta_dir</span><span class="p">,</span> <span class="n">max_scaffold_length</span><span class="o">=</span><span class="mi">500000</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Create a BED file from the database in fasta format.</p>
<p>Parameters:
db_fasta_dir (Union[str, pathlib.Path]): Path to the fasta file.
max_scaffold_length (int): Splits scaffolds longer than this into multiple entries of length &lt;= max_scaffold_length.</p>
<p>Returns:
pl.LazyFrame: A LazyFrame containing the BED data.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_the_bed</span><span class="p">(</span><span class="n">db_fasta_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">max_scaffold_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500_000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a BED file from the database in fasta format.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    db_fasta_dir (Union[str, pathlib.Path]): Path to the fasta file.</span>
<span class="sd">    max_scaffold_length (int): Splits scaffolds longer than this into multiple entries of length &lt;= max_scaffold_length.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pl.LazyFrame: A LazyFrame containing the BED data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db_fasta_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">db_fasta_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">db_fasta_dir</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">db_fasta_dir</span><span class="si">}</span><span class="s2"> is not a valid fasta file.&quot;</span><span class="p">)</span>

    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">db_fasta_dir</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">scaffold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">seq_chunks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">):</span>
                <span class="c1"># Process the previous scaffold</span>
                <span class="k">if</span> <span class="n">scaffold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seq_chunks</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> <span class="n">max_scaffold_length</span><span class="p">):</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">max_scaffold_length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>
                        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">scaffold</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
                <span class="c1"># Start new scaffold</span>
                <span class="n">scaffold</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># ID only (up to first whitespace)</span>
                <span class="n">seq_chunks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seq_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># Don&#39;t forget the last scaffold</span>
        <span class="k">if</span> <span class="n">scaffold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seq_chunks</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">),</span> <span class="n">max_scaffold_length</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">max_scaffold_length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>
                <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">scaffold</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scaffold&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.utils.process_mpileup_function" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_mpileup_function</span><span class="p">(</span><span class="n">gene_range_table_loc</span><span class="p">,</span> <span class="n">batch_bed</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Process mpileup files and save the results in a Parquet file.</p>
<p>Parameters:
gene_range_table_loc (str): Path to the gene range table in TSV format.
batch_bed (str): Path to the batch BED file.
batch_size (int): Buffer size for processing stdin from samtools.
output_file (str): Path to save the output Parquet file.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_mpileup_function</span><span class="p">(</span><span class="n">gene_range_table_loc</span><span class="p">,</span> <span class="n">batch_bed</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process mpileup files and save the results in a Parquet file.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    gene_range_table_loc (str): Path to the gene range table in TSV format.</span>
<span class="sd">    batch_bed (str): Path to the batch BED file.</span>
<span class="sd">    batch_size (int): Buffer size for processing stdin from samtools.</span>
<span class="sd">    output_file (str): Path to save the output Parquet file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">indel_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\^.|[\$]|[+-](\d+)&#39;</span><span class="p">)</span>
    <span class="n">gene_ranges_pl</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_csv</span><span class="p">(</span><span class="n">gene_range_table_loc</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">has_header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span>
        <span class="s2">&quot;column_1&quot;</span><span class="p">:</span> <span class="s2">&quot;scaffold&quot;</span><span class="p">,</span>
        <span class="s2">&quot;column_2&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
        <span class="s2">&quot;column_3&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
        <span class="s2">&quot;column_4&quot;</span><span class="p">:</span> <span class="s2">&quot;gene&quot;</span>
    <span class="p">})</span>
    <span class="n">scaffolds</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">batch_bed</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">has_header</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;column_1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">gene_ranges_pl</span> <span class="o">=</span> <span class="n">gene_ranges_pl</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;scaffold&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">scaffolds</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">gene_ranges</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">IntervalTree</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gene_ranges_pl</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">gene_ranges</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;scaffold&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">addi</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">])</span>

    <span class="n">schema</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">schema</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;chrom&#39;</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">string</span><span class="p">()),</span>
        <span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">int32</span><span class="p">()),</span>
        <span class="p">(</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">string</span><span class="p">()),</span>
        <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">uint16</span><span class="p">()),</span>
        <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">uint16</span><span class="p">()),</span>
        <span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">uint16</span><span class="p">()),</span>
        <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">uint16</span><span class="p">()),</span>
    <span class="p">])</span>

    <span class="n">chroms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">genes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">As</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Cs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Gs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Ts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">flush_batch</span><span class="p">():</span>
        <span class="k">nonlocal</span> <span class="n">writer</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chroms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">RecordBatch</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">([</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chroms</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">string</span><span class="p">()),</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">int32</span><span class="p">()),</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">genes</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">string</span><span class="p">()),</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">As</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">uint16</span><span class="p">()),</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Cs</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">uint16</span><span class="p">()),</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Gs</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">uint16</span><span class="p">()),</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">pa</span><span class="o">.</span><span class="n">uint16</span><span class="p">()),</span>
        <span class="p">],</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">writer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Open writer for the first time</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">ParquetWriter</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;snappy&#39;</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_batches</span><span class="p">([</span><span class="n">batch</span><span class="p">]))</span>

        <span class="c1"># Clear buffers</span>
        <span class="n">chroms</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">positions</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">genes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">As</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">Cs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">Gs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">Ts</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">chrom</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bases</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>

        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">clean_bases</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="n">indel_re</span><span class="p">)</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">count_bases</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>

        <span class="n">chroms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chrom</span><span class="p">)</span>
        <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">gene_ranges</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="p">)]</span>
        <span class="n">genes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">matches</span><span class="p">))</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="n">matches</span> <span class="k">else</span> <span class="s2">&quot;NA&quot;</span><span class="p">)</span>
        <span class="n">As</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">])</span>
        <span class="n">Cs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">])</span>
        <span class="n">Gs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">])</span>
        <span class="n">Ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chroms</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">batch_size</span><span class="p">:</span>
            <span class="n">flush_batch</span><span class="p">()</span>

    <span class="c1"># Flush remaining data</span>
    <span class="n">flush_batch</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.utils.split_lf_to_chunks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split_lf_to_chunks</span><span class="p">(</span><span class="n">lf</span><span class="p">,</span> <span class="n">num_chunks</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Split a Polars LazyFrame into smaller chunks.</p>
<p>Parameters:
lf (pl.LazyFrame): The input LazyFrame to be split.
num_chunks (int): The number of chunks to split the LazyFrame into.</p>
<p>Returns:
list[pl.LazyFrame]: A list of smaller LazyFrames.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">split_lf_to_chunks</span><span class="p">(</span><span class="n">lf</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span><span class="n">num_chunks</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">list</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split a Polars LazyFrame into smaller chunks.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    lf (pl.LazyFrame): The input LazyFrame to be split.</span>
<span class="sd">    num_chunks (int): The number of chunks to split the LazyFrame into.</span>

<span class="sd">    Returns:</span>
<span class="sd">    list[pl.LazyFrame]: A list of smaller LazyFrames.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_rows</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">count</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">total_rows</span> <span class="o">//</span> <span class="n">num_chunks</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chunks</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">chunk_size</span>
        <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunk_size</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_chunks</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">total_rows</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
        <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chunks</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="visualize">Visualize</h2>


<div class="doc doc-object doc-module">



<a id="zipstrain.visualize"></a>
    <div class="doc doc-contents first">

        <h4 id="zipstrain.visualize--zipstrainvisualize">zipstrain.visualize</h4>
<p>This module provides statistical analysis and visualization functions for profiling and compare operations.</p>










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="zipstrain.visualize.calculate_ibs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_ibs</span><span class="p">(</span><span class="n">sample_to_population</span><span class="p">,</span> <span class="n">comps_lf</span><span class="p">,</span> <span class="n">max_perc_id_genes</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">min_total_positions</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate the Identity By State (IBS) between two populations for a given genome.
The IBS is defined as the percentage of genes that are identical between two populations for a given genome.
Args:
    sample_to_population (pl.LazyFrame): LazyFrame containing the sample to population mapping.
    comps_lf (pl.LazyFrame): LazyFrame containing the gene profiles of the samples.
    max_perc_id_genes (float, optional): Maximum percentage of identical genes to consider. Defaults to 0.15.
Returns:
    pl.LazyFrame: LazyFrame containing the IBS information for the given genome and populations.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/visualize.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_ibs</span><span class="p">(</span>
    <span class="n">sample_to_population</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span> 
    <span class="n">comps_lf</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
    <span class="n">max_perc_id_genes</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">min_total_positions</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Identity By State (IBS) between two populations for a given genome.</span>
<span class="sd">    The IBS is defined as the percentage of genes that are identical between two populations for a given genome.</span>
<span class="sd">    Args:</span>
<span class="sd">        sample_to_population (pl.LazyFrame): LazyFrame containing the sample to population mapping.</span>
<span class="sd">        comps_lf (pl.LazyFrame): LazyFrame containing the gene profiles of the samples.</span>
<span class="sd">        max_perc_id_genes (float, optional): Maximum percentage of identical genes to consider. Defaults to 0.15.</span>
<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: LazyFrame containing the IBS information for the given genome and populations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">comps_lf_filtered</span> <span class="o">=</span> <span class="n">comps_lf</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;perc_id_genes&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_perc_id_genes</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;total_positions&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="n">min_total_positions</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">comps_lf_filtered</span><span class="o">=</span><span class="n">comps_lf_filtered</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">sample_to_population</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;sample_1&#39;</span><span class="p">,</span>
        <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;population&quot;</span><span class="p">:</span><span class="s2">&quot;population_1&quot;</span><span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">sample_to_population</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;sample_2&#39;</span><span class="p">,</span>
        <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span>
        <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_2&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;population&quot;</span><span class="p">:</span><span class="s2">&quot;population_2&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">comps_lf_filtered</span> <span class="o">=</span> <span class="n">comps_lf_filtered</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;population_1&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;population_2&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">then</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;within_population_&quot;</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;population_1&quot;</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;population_2&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;between_population_&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">min_horizontal</span><span class="p">(</span><span class="s2">&quot;population_1&quot;</span><span class="p">,</span> <span class="s2">&quot;population_2&quot;</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">),</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">max_horizontal</span><span class="p">(</span><span class="s2">&quot;population_1&quot;</span><span class="p">,</span> <span class="s2">&quot;population_2&quot;</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;comparison_type&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">comps_lf_filtered</span><span class="o">.</span><span class="n">group_by</span><span class="p">([</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span><span class="s2">&quot;comparison_type&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;max_consecutive_length&quot;</span><span class="p">),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;comparison_type&quot;</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="s2">&quot;max_consecutive_length&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.visualize.calculate_identical_frac_vs_popani" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_identical_frac_vs_popani</span><span class="p">(</span><span class="n">genome</span><span class="p">,</span> <span class="n">population_1</span><span class="p">,</span> <span class="n">population_2</span><span class="p">,</span> <span class="n">sample_to_population</span><span class="p">,</span> <span class="n">comps_lf</span><span class="p">,</span> <span class="n">min_shared_genes_count</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">min_total_positions</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate the fraction of identical genes vs  popANI for a given genome and two samples in any possible combination of populations.
Args:
    genome (str): The genome to calculate the fraction of identical genes vs popANI for.
    population_1 (str): The first population to compare.
    population_2 (str): The second population to compare.
    sample_to_population (pl.LazyFrame): LazyFrame containing the sample to population mapping.
    comps_lf (pl.LazyFrame): LazyFrame containing the gene profiles of the samples
Returns:
    pl.LazyFrame: LazyFrame containing the fraction of identical genes vs popANI information for</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/visualize.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_identical_frac_vs_popani</span><span class="p">(</span>
    <span class="n">genome</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">population_1</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">population_2</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">sample_to_population</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
    <span class="n">comps_lf</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
    <span class="n">min_shared_genes_count</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">min_total_positions</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the fraction of identical genes vs  popANI for a given genome and two samples in any possible combination of populations.</span>
<span class="sd">    Args:</span>
<span class="sd">        genome (str): The genome to calculate the fraction of identical genes vs popANI for.</span>
<span class="sd">        population_1 (str): The first population to compare.</span>
<span class="sd">        population_2 (str): The second population to compare.</span>
<span class="sd">        sample_to_population (pl.LazyFrame): LazyFrame containing the sample to population mapping.</span>
<span class="sd">        comps_lf (pl.LazyFrame): LazyFrame containing the gene profiles of the samples</span>
<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: LazyFrame containing the fraction of identical genes vs popANI information for</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">comps_lf_filtered</span><span class="o">=</span><span class="n">comps_lf</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;genome&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">genome</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;shared_genes_count&quot;</span><span class="p">)</span><span class="o">&gt;</span><span class="n">min_shared_genes_count</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_positions&quot;</span><span class="p">)</span><span class="o">&gt;</span><span class="n">min_total_positions</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>

    <span class="n">comps_lf_filtered</span><span class="o">=</span><span class="n">comps_lf_filtered</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">sample_to_population</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;sample_1&#39;</span><span class="p">,</span>
        <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;population&quot;</span><span class="p">:</span><span class="s2">&quot;population_1&quot;</span><span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">sample_to_population</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;sample_2&#39;</span><span class="p">,</span>
        <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
        <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_2&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;population&quot;</span><span class="p">:</span><span class="s2">&quot;population_2&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">comps_lf_filtered</span> <span class="o">=</span> <span class="n">comps_lf_filtered</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;population_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">({</span><span class="n">population_1</span><span class="p">,</span> <span class="n">population_2</span><span class="p">}))</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;population_2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">({</span><span class="n">population_1</span><span class="p">,</span> <span class="n">population_2</span><span class="p">}))</span>
    <span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
    <span class="n">groups</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;same_1&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">population_1</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">population_1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;same_2&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">population_2</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">population_2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;diff&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">population_1</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">population_2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">comps_lf_filtered</span><span class="o">=</span><span class="n">comps_lf_filtered</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;population_1&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">population_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;population_2&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">population_1</span><span class="p">))</span>
        <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="s2">&quot;same_1&quot;</span><span class="p">]))</span>
        <span class="o">.</span><span class="n">when</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;population_1&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">population_2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;population_2&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">population_2</span><span class="p">))</span>
        <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="s2">&quot;same_2&quot;</span><span class="p">]))</span>
        <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]))</span>
        <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;relationship&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">comps_lf_filtered</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;relationship&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;perc_id_genes&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;genome_pop_ani&quot;</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.visualize.calculate_strainsharing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">calculate_strainsharing</span><span class="p">(</span><span class="n">comps_lf</span><span class="p">,</span> <span class="n">breadth_lf</span><span class="p">,</span> <span class="n">sample_to_population</span><span class="p">,</span> <span class="n">min_breadth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">strain_similarity_threshold</span><span class="o">=</span><span class="mf">99.9</span><span class="p">,</span> <span class="n">min_total_positions</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate strain sharing between populations based on popANI between genomes in their profiles.
Strain sharing between two samples is defined as the ratio of genomes passing a strain similarity threshold over the total number of genomes in each sample.
So, for two samples A and B, the strain sharing is defined as (Note the assymetric nature of the calculation):
strain_sharing(A, B) = (number of genomes in A and B passing the strain similarity threshold) / (number of genomes in A)
strain_sharing(B, A) = (number of genomes in A and B passing the strain similarity threshold) / (number of genomes in B)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>comps_lf</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>LazyFrame containing the gene profiles of the samples.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>breadth_lf</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>LazyFrame containing the genome breadth information.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_to_population</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>LazyFrame containing the sample to population mapping.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_breadth</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum genome breadth to consider a genome for strain sharing. Defaults to 0.5.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>strain_similarity_threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for strain similarity. Defaults to 0.99.</p>
              </div>
            </td>
            <td>
                  <code>99.9</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>min_total_positions</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum total positions to consider a genome for strain sharing. Defaults to 10000.</p>
              </div>
            </td>
            <td>
                  <code>10000</code>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Returns:
    pl.LazyFrame: LazyFrame containing the strain sharing information between populations. It will be in the following form [Sample A, Sample B, Strain Sharing, Relationship]</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/visualize.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_strainsharing</span><span class="p">(</span>
                            <span class="n">comps_lf</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
                            <span class="n">breadth_lf</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
                            <span class="n">sample_to_population</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
                            <span class="n">min_breadth</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                            <span class="n">strain_similarity_threshold</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">99.9</span><span class="p">,</span>
                            <span class="n">min_total_positions</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span>
                            <span class="p">)</span><span class="o">-&gt;</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>


<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate strain sharing between populations based on popANI between genomes in their profiles.</span>
<span class="sd">    Strain sharing between two samples is defined as the ratio of genomes passing a strain similarity threshold over the total number of genomes in each sample.</span>
<span class="sd">    So, for two samples A and B, the strain sharing is defined as (Note the assymetric nature of the calculation):</span>
<span class="sd">    strain_sharing(A, B) = (number of genomes in A and B passing the strain similarity threshold) / (number of genomes in A)</span>
<span class="sd">    strain_sharing(B, A) = (number of genomes in A and B passing the strain similarity threshold) / (number of genomes in B)</span>

<span class="sd">    Args:</span>
<span class="sd">        comps_lf (pl.LazyFrame): LazyFrame containing the gene profiles of the samples.</span>
<span class="sd">        breadth_lf (pl.LazyFrame): LazyFrame containing the genome breadth information.</span>
<span class="sd">        sample_to_population (pl.LazyFrame): LazyFrame containing the sample to population mapping.</span>
<span class="sd">        min_breadth (float, optional): Minimum genome breadth to consider a genome for strain sharing. Defaults to 0.5.</span>
<span class="sd">        strain_similarity_threshold (float, optional): Threshold for strain similarity. Defaults to 0.99.</span>
<span class="sd">        min_total_positions (int, optional): Minimum total positions to consider a genome for strain sharing. Defaults to 10000.</span>
<span class="sd">    Returns:</span>
<span class="sd">        pl.LazyFrame: LazyFrame containing the strain sharing information between populations. It will be in the following form [Sample A, Sample B, Strain Sharing, Relationship]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">comps_lf</span><span class="o">=</span><span class="n">comps_lf</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_positions&quot;</span><span class="p">)</span><span class="o">&gt;</span><span class="n">min_total_positions</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
    <span class="n">breadth_lf</span><span class="o">=</span><span class="n">breadth_lf</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">breadth_lf_long</span><span class="o">=</span><span class="p">(</span>
        <span class="n">breadth_lf</span><span class="o">.</span><span class="n">unpivot</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;genome&quot;</span><span class="p">],</span>
            <span class="n">variable_name</span><span class="o">=</span><span class="s2">&quot;sample&quot;</span><span class="p">,</span>
            <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;breadth&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">breadth_lf</span><span class="o">=</span><span class="n">breadth_lf_long</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">num_genomes</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;breadth&quot;</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">min_breadth</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">comps_lf</span><span class="o">=</span><span class="n">comps_lf</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">breadth_lf</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;sample_1&#39;</span><span class="p">,</span>
        <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;num_genomes&quot;</span><span class="p">:</span><span class="s2">&quot;num_genomes_1&quot;</span><span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">breadth_lf</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;sample_2&#39;</span><span class="p">,</span>
        <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;num_genomes&quot;</span><span class="p">:</span><span class="s2">&quot;num_genomes_2&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">comps_lf</span> <span class="o">=</span> <span class="n">comps_lf</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">sample_to_population</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;sample_1&#39;</span><span class="p">,</span>
        <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;population&quot;</span><span class="p">:</span><span class="s2">&quot;population_1&quot;</span><span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">sample_to_population</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;sample_2&#39;</span><span class="p">,</span>
        <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;population&quot;</span><span class="p">:</span><span class="s2">&quot;population_2&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">comps_lf</span><span class="o">=</span><span class="n">comps_lf</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">breadth_lf_long</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span><span class="s2">&quot;sample_1&quot;</span><span class="p">],</span>
        <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;genome&#39;</span><span class="p">,</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;breadth&quot;</span><span class="p">:</span><span class="s2">&quot;breadth_1&quot;</span><span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">breadth_lf_long</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span><span class="s2">&quot;sample_2&quot;</span><span class="p">],</span>
        <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;genome&#39;</span><span class="p">,</span><span class="s1">&#39;sample&#39;</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;breadth&quot;</span><span class="p">:</span><span class="s2">&quot;breadth_2&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="n">comps_lf</span><span class="o">=</span><span class="n">comps_lf</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;breadth_1&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_breadth</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;breadth_2&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_breadth</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;genome_pop_ani&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">strain_similarity_threshold</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">comps_lf</span><span class="o">=</span><span class="n">comps_lf</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;sample_1&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_2&quot;</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;shared_strain_count&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;num_genomes_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;num_genomes_1&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;num_genomes_2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;num_genomes_2&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;population_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;population_1&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;population_2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;population_2&quot;</span><span class="p">),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span>
    <span class="n">strainsharingrates</span><span class="o">=</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">comps_lf</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">strainsharingrates</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;population_1&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;population_2&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;shared_strain_count&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;num_genomes_1&quot;</span><span class="p">])</span>
        <span class="n">strainsharingrates</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;population_2&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;population_1&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;shared_strain_count&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;num_genomes_2&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">strainsharingrates</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.visualize.get_cdf" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_cdf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num_bins</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Calculate the cumulative distribution function (CDF) of the given data.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/visualize.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_cdf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">num_bins</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the cumulative distribution function (CDF) of the given data.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">counts</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50000</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">))</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">bin_edges</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cummulative_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
    <span class="n">cdf</span><span class="o">=</span> <span class="n">cummulative_counts</span> <span class="o">/</span> <span class="n">cummulative_counts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">cdf</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.visualize.plot_clustermap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_clustermap</span><span class="p">(</span><span class="n">comps_lf</span><span class="p">,</span> <span class="n">genome</span><span class="p">,</span> <span class="n">sample_to_population</span><span class="p">,</span> <span class="n">min_comp_len</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">impute_method</span><span class="o">=</span><span class="mf">97.0</span><span class="p">,</span> <span class="n">max_null_samples</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot a clustermap for the given genome and its associated samples.
Args:
    comps_lf (pl.LazyFrame): LazyFrame containing the comparison data.
    genome (str): The genome to plot.
    sample_to_population (pl.LazyFrame): LazyFrame containing the sample to population mapping.
Returns:
    go.Figure: Plotly figure containing the clustermap.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/visualize.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_clustermap</span><span class="p">(</span>
    <span class="n">comps_lf</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
    <span class="n">genome</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">sample_to_population</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
    <span class="n">min_comp_len</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">impute_method</span><span class="p">:</span><span class="nb">str</span><span class="o">|</span><span class="nb">float</span><span class="o">=</span><span class="mf">97.0</span><span class="p">,</span>
    <span class="n">max_null_samples</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">color_map</span><span class="p">:</span><span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a clustermap for the given genome and its associated samples.</span>
<span class="sd">    Args:</span>
<span class="sd">        comps_lf (pl.LazyFrame): LazyFrame containing the comparison data.</span>
<span class="sd">        genome (str): The genome to plot.</span>
<span class="sd">        sample_to_population (pl.LazyFrame): LazyFrame containing the sample to population mapping.</span>
<span class="sd">    Returns:</span>
<span class="sd">        go.Figure: Plotly figure containing the clustermap.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Filter the comparison data for the specific genome</span>
    <span class="n">comps_lf_filtered</span> <span class="o">=</span> <span class="n">comps_lf</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">genome</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_positions&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_comp_len</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sample_2&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;genome_pop_ani&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">comps_lf_filtered_oposite</span> <span class="o">=</span> <span class="n">comps_lf_filtered</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sample_2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;sample_2&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;genome_pop_ani&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># Combine the filtered data with its opposite pairs</span>
    <span class="n">comps_lf_filtered</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">comps_lf_filtered</span><span class="p">,</span> <span class="n">comps_lf_filtered_oposite</span><span class="p">])</span>
    <span class="c1"># Make a synthetic table for similarity of samples with themselves of all samples in sample_1 and sample_2 but each sample exists only once</span>
    <span class="n">self_similarity</span> <span class="o">=</span><span class="p">(</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
        <span class="n">comps_lf_filtered</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">)),</span>
        <span class="n">comps_lf_filtered</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sample_2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">))</span>
    <span class="p">])</span>
    <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;sample_2&quot;</span><span class="p">),</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;genome_pop_ani&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Combine the self similarity with the filtered data</span>
    <span class="n">comps_lf_filtered</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">self_similarity</span><span class="p">,</span> <span class="n">comps_lf_filtered</span><span class="p">])</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="c1"># Pivot the data for the clustermap</span>
    <span class="n">clustermap_data</span> <span class="o">=</span> <span class="n">comps_lf_filtered</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="s2">&quot;sample_1&quot;</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;sample_2&quot;</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="s2">&quot;genome_pop_ani&quot;</span>
    <span class="p">)</span>
    <span class="c1"># We want to make this a similarity matrix, so we need to frop null values, have sample_1 and sample_2 as index and columns as we</span>
    <span class="c1"># Create the clustermap</span>
    <span class="n">exclude_samples</span><span class="o">=</span><span class="n">clustermap_data</span><span class="o">.</span><span class="n">null_count</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">include_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">header_name</span><span class="o">=</span><span class="s2">&quot;column&quot;</span><span class="p">,</span> <span class="n">column_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;null_count&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;null_count&quot;</span><span class="p">)</span><span class="o">&gt;</span><span class="n">max_null_samples</span><span class="p">)[</span><span class="s2">&quot;column&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="c1"># Only include rows and cols not in exclude_samples</span>
    <span class="n">clustermap_data</span> <span class="o">=</span> <span class="n">clustermap_data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">exclude_samples</span><span class="p">))</span>
    <span class="n">clustermap_data</span> <span class="o">=</span> <span class="n">clustermap_data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">clustermap_data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_samples</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impute_method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">pass</span> <span class="c1"># To be implemented later</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">impute_method</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="n">clustermap_data</span> <span class="o">=</span> <span class="n">clustermap_data</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">impute_method</span><span class="p">)</span>
    <span class="n">sample_to_population</span> <span class="o">=</span> <span class="n">clustermap_data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">sample_to_population</span><span class="o">.</span><span class="n">collect</span><span class="p">(),</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;sample_1&quot;</span><span class="p">,</span>
        <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;sample&quot;</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="n">sample_to_population_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sample_to_population</span><span class="p">[</span><span class="s2">&quot;sample_1&quot;</span><span class="p">],</span> <span class="n">sample_to_population</span><span class="p">[</span><span class="s2">&quot;population&quot;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">color_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">num_categories</span> <span class="o">=</span> <span class="n">sample_to_population</span><span class="p">[</span><span class="s2">&quot;population&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_unique</span><span class="p">()</span>
        <span class="n">groups</span><span class="o">=</span> <span class="n">sample_to_population</span><span class="p">[</span><span class="s2">&quot;population&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">qualitative_palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;hls&quot;</span><span class="p">,</span> <span class="n">num_categories</span><span class="p">)</span>
        <span class="n">row_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">qualitative_palette</span><span class="p">[</span><span class="n">groups</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sample_to_population_dict</span><span class="p">[</span><span class="n">sample</span><span class="p">])]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">clustermap_data</span><span class="p">[</span><span class="s2">&quot;sample_1&quot;</span><span class="p">]]</span>
        <span class="n">col_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">qualitative_palette</span><span class="p">[</span><span class="n">groups</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sample_to_population_dict</span><span class="p">[</span><span class="n">sample</span><span class="p">])]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">clustermap_data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">sample</span> <span class="o">!=</span> <span class="s2">&quot;sample_1&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">groups</span><span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">color_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">qualitative_palette</span><span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">color_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">row_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_map</span><span class="p">[</span><span class="n">sample_to_population_dict</span><span class="p">[</span><span class="n">sample</span><span class="p">]]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">clustermap_data</span><span class="p">[</span><span class="s2">&quot;sample_1&quot;</span><span class="p">]]</span>
        <span class="n">col_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_map</span><span class="p">[</span><span class="n">sample_to_population_dict</span><span class="p">[</span><span class="n">sample</span><span class="p">]]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">clustermap_data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">sample</span> <span class="o">!=</span> <span class="s2">&quot;sample_1&quot;</span><span class="p">]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">clustermap</span><span class="p">(</span>
        <span class="n">clustermap_data</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;sample_1&quot;</span><span class="p">),</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="n">xticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">yticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">row_colors</span><span class="o">=</span><span class="n">row_colors</span><span class="p">,</span>
        <span class="n">col_colors</span><span class="o">=</span><span class="n">col_colors</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">get_xmajorticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">get_ymajorticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">qualitative_palette</span><span class="p">)]</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span>
                          <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Population&#39;</span><span class="p">,</span>
                        <span class="n">title_fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>   <span class="c1"># bigger title</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>         <span class="c1"># bigger labels</span>
                        <span class="n">handlelength</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>    <span class="c1"># wider color boxes</span>
                        <span class="n">handleheight</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.visualize.plot_ibs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_ibs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">genome</span><span class="p">,</span> <span class="n">population_1</span><span class="p">,</span> <span class="n">population_2</span><span class="p">,</span> <span class="n">vert_thresh_hor_distance</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">num_bins</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;IBS for &lt;GENOME&gt;: &lt;POPULATION_1&gt; vs &lt;POPULATION_2&gt;&#39;</span><span class="p">,</span> <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Max Consecutive Length&#39;</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;CDF&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot the Identity By State (IBS) for a given genome and two populations.
Args:
    df (pl.DataFrame): DataFrame containing the IBS information.
    genome (str): The genome to plot the IBS for.
    population_1 (str): The first population to plot the IBS for.
    population_2 (str): The second population to plot the IBS for.
    title (str, optional): Title of the plot. Defaults to "IBS for <GENOME>".
    xaxis_title (str, optional): Title of the x-axis. Defaults to "Membership".
    yaxis_title (str, optional): Title of the y-axis. Defaults to "Max Consecutive Length".
Returns:
    go.Figure: Plotly figure containing the IBS plot.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/visualize.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_ibs</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">genome</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">population_1</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">population_2</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">vert_thresh_hor_distance</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">num_bins</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
            <span class="n">title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;IBS for &lt;GENOME&gt;: &lt;POPULATION_1&gt; vs &lt;POPULATION_2&gt;&quot;</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;Max Consecutive Length&quot;</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;CDF&quot;</span>
            <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the Identity By State (IBS) for a given genome and two populations.</span>
<span class="sd">    Args:</span>
<span class="sd">        df (pl.DataFrame): DataFrame containing the IBS information.</span>
<span class="sd">        genome (str): The genome to plot the IBS for.</span>
<span class="sd">        population_1 (str): The first population to plot the IBS for.</span>
<span class="sd">        population_2 (str): The second population to plot the IBS for.</span>
<span class="sd">        title (str, optional): Title of the plot. Defaults to &quot;IBS for &lt;GENOME&gt;&quot;.</span>
<span class="sd">        xaxis_title (str, optional): Title of the x-axis. Defaults to &quot;Membership&quot;.</span>
<span class="sd">        yaxis_title (str, optional): Title of the y-axis. Defaults to &quot;Max Consecutive Length&quot;.</span>
<span class="sd">    Returns:</span>
<span class="sd">        go.Figure: Plotly figure containing the IBS plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">genome</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">df_filtered</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Genome </span><span class="si">{</span><span class="n">genome</span><span class="si">}</span><span class="s2"> not found in the dataframe.&quot;</span><span class="p">)</span>
    <span class="n">plot_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">key_within_1</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;within_population_</span><span class="si">{</span><span class="n">population_1</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">population_1</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">key_within_2</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;within_population_</span><span class="si">{</span><span class="n">population_2</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">population_2</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">key_between</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;between_population_</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">population_1</span><span class="p">,</span><span class="n">population_2</span><span class="p">)</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">population_1</span><span class="p">,</span><span class="n">population_2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">df_filtered</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">key_within_1</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">len</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">df_filtered</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">key_within_2</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">len</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">df_filtered</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">key_between</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">len</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not enough data for populations </span><span class="si">{</span><span class="n">population_1</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">population_2</span><span class="si">}</span><span class="s2"> in genome </span><span class="si">{</span><span class="n">genome</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;within_population&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">df_filtered</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">key_within_1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="o">+</span><span class="n">df_filtered</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">key_within_2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;between_population&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">df_filtered</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="n">key_between</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    <span class="n">between_pop_cdf</span><span class="o">=</span><span class="n">get_cdf</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;between_population&quot;</span><span class="p">],</span> <span class="n">num_bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">between_pop_cdf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">y</span><span class="o">=</span><span class="n">between_pop_cdf</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;between_population&#39;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    <span class="p">))</span>
    <span class="n">within_pop_cdf</span><span class="o">=</span><span class="n">get_cdf</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="s2">&quot;within_population&quot;</span><span class="p">],</span> <span class="n">num_bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">within_pop_cdf</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">y</span><span class="o">=</span><span class="n">within_pop_cdf</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;within_population&#39;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="p">))</span>

    <span class="n">bin_edges</span><span class="o">=</span><span class="n">within_pop_cdf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cdf</span><span class="o">=</span><span class="n">within_pop_cdf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">within_intersect</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cdf</span><span class="o">&gt;=</span><span class="n">vert_thresh_hor_distance</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">bin_edges</span><span class="o">=</span><span class="n">between_pop_cdf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cdf</span><span class="o">=</span><span class="n">between_pop_cdf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">between_intersect</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cdf</span><span class="o">&gt;=</span><span class="n">vert_thresh_hor_distance</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>  
    <span class="n">distance</span><span class="o">=</span><span class="n">within_intersect</span><span class="o">-</span><span class="n">between_intersect</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;GENOME&gt;&quot;</span><span class="p">,</span> <span class="n">genome</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;POPULATION_1&gt;&quot;</span><span class="p">,</span> <span class="n">population_1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;POPULATION_2&gt;&quot;</span><span class="p">,</span> <span class="n">population_2</span><span class="p">),</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="n">xaxis_title</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="n">yaxis_title</span><span class="p">,</span>

    <span class="p">)</span>
    <span class="c1">###Add a horizontal line from (between_intersect, vert_thresh_hor_distance) to (within_intersect, vert_thresh_hor_distance)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">between_intersect</span><span class="p">,</span> <span class="n">within_intersect</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">vert_thresh_hor_distance</span><span class="p">,</span> <span class="n">vert_thresh_hor_distance</span><span class="p">],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines+markers&#39;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">),</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">))</span>
    <span class="c1">###Add a text annotation at the middle of the horizontal line with the distance</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="p">[(</span><span class="n">between_intersect</span><span class="o">+</span><span class="n">within_intersect</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">vert_thresh_hor_distance</span><span class="p">],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">distance</span><span class="p">),</span>
        <span class="n">textposition</span><span class="o">=</span><span class="s2">&quot;top center&quot;</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">))</span>
    <span class="c1">##make both axes logarithmic</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.visualize.plot_ibs_heatmap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_ibs_heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">vert_thresh</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">populations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_bins</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">min_member</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;IBS Heatmap&#39;</span><span class="p">,</span> <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Population Pair&#39;</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Genome&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot the Identity By State (IBS) heatmap for a given genome and two populations.
Args:
    df (pl.DataFrame): DataFrame containing the IBS information.
    title (str, optional): Title of the plot. Defaults to "IBS Heatmap".
    xaxis_title (str, optional): Title of the x-axis. Defaults to "Population Pair".
    yaxis_title (str, optional): Title of the y-axis. Defaults to "Genome".
Returns:
    go.Figure: Plotly figure containing the IBS heatmap.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/visualize.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_ibs_heatmap</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">vert_thresh</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">populations</span><span class="p">:</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">num_bins</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">min_member</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;IBS Heatmap&quot;</span><span class="p">,</span>
    <span class="n">xaxis_title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;Population Pair&quot;</span><span class="p">,</span>
    <span class="n">yaxis_title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;Genome&quot;</span><span class="p">,</span>

<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the Identity By State (IBS) heatmap for a given genome and two populations.</span>
<span class="sd">    Args:</span>
<span class="sd">        df (pl.DataFrame): DataFrame containing the IBS information.</span>
<span class="sd">        title (str, optional): Title of the plot. Defaults to &quot;IBS Heatmap&quot;.</span>
<span class="sd">        xaxis_title (str, optional): Title of the x-axis. Defaults to &quot;Population Pair&quot;.</span>
<span class="sd">        yaxis_title (str, optional): Title of the y-axis. Defaults to &quot;Genome&quot;.</span>
<span class="sd">    Returns:</span>
<span class="sd">        go.Figure: Plotly figure containing the IBS heatmap.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">min_member</span><span class="p">)</span>
        <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;genome&quot;</span>
    <span class="p">]</span>
<span class="p">)</span>
    <span class="k">if</span> <span class="n">populations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">populations</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;within_population_&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;between_population_&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="s2">&quot;genome&quot;</span><span class="p">))</span>
        <span class="n">populations</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">populations</span><span class="p">)</span>
    <span class="n">heatmap_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rows_by_key</span><span class="p">(</span><span class="s2">&quot;genome&quot;</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">include_key</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fig_data</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">genome</span><span class="p">,</span> <span class="n">genome_data</span> <span class="ow">in</span> <span class="n">heatmap_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">fig_data</span><span class="p">[</span><span class="n">genome</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">pop1</span><span class="p">,</span><span class="n">pop2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">populations</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">key_between</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;between_population_</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">pop1</span><span class="p">,</span><span class="n">pop2</span><span class="p">)</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">pop1</span><span class="p">,</span><span class="n">pop2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">key_within_1</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;within_population_</span><span class="si">{</span><span class="n">pop1</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">pop1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">key_within_2</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;within_population_</span><span class="si">{</span><span class="n">pop2</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">pop2</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">genome_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key_between</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">genome_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key_within_1</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">genome_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key_within_2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">fig_data</span><span class="p">[</span><span class="n">genome</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">pop1</span><span class="p">,</span><span class="n">pop2</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">pop1</span><span class="p">,</span><span class="n">pop2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
                <span class="k">continue</span>
            <span class="n">between</span><span class="o">=</span><span class="n">get_cdf</span><span class="p">(</span><span class="n">genome_data</span><span class="p">[</span><span class="n">key_between</span><span class="p">],</span> <span class="n">num_bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">)</span>
            <span class="n">within</span><span class="o">=</span><span class="n">get_cdf</span><span class="p">(</span><span class="n">genome_data</span><span class="p">[</span><span class="n">key_within_1</span><span class="p">]</span><span class="o">+</span><span class="n">genome_data</span><span class="p">[</span><span class="n">key_within_2</span><span class="p">],</span> <span class="n">num_bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">)</span>

            <span class="n">between_intersect</span><span class="o">=</span><span class="n">between</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">between</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">vert_thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">within_intersect</span><span class="o">=</span><span class="n">within</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">within</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">vert_thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">distance</span><span class="o">=</span><span class="n">within_intersect</span><span class="o">-</span><span class="n">between_intersect</span>
            <span class="n">fig_data</span><span class="p">[</span><span class="n">genome</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">pop1</span><span class="p">,</span><span class="n">pop2</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">pop1</span><span class="p">,</span><span class="n">pop2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">distance</span>
    <span class="c1">###Filter the dataframe to only have useful information</span>
    <span class="n">heatmap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fig_data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">heatmap_df</span><span class="o">=</span><span class="n">heatmap_df</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">heatmap_df</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">heatmap_df</span><span class="o">=</span><span class="n">heatmap_df</span><span class="p">[</span><span class="n">heatmap_df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">heatmap_df</span><span class="o">=</span><span class="n">heatmap_df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">heatmap_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">heatmap_df_sorted</span> <span class="o">=</span> <span class="n">heatmap_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">row_sum</span><span class="o">=</span><span class="n">heatmap_df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;row_sum&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;row_sum&quot;</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span>
        <span class="n">z</span><span class="o">=</span><span class="n">heatmap_df_sorted</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">heatmap_df_sorted</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">heatmap_df_sorted</span><span class="o">.</span><span class="n">index</span>
    <span class="p">))</span>
    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.visualize.plot_identical_frac_vs_popani" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_identical_frac_vs_popani</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">genome</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Fraction of Identical Genes vs popANI for &lt;GENOME&gt;&#39;</span><span class="p">,</span> <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Genome-Wide popANI&#39;</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Fraction of Identical Genes&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot the fraction of identical genes vs popANI for a given genome and two samples in any possible combination of populations.
Args:
    df (pl.DataFrame): DataFrame containing the fraction of identical genes vs popANI information.
    title (str, optional): Title of the plot. Defaults to "Fraction of Identical Genes vs popANI".
    xaxis_title (str, optional): Title of the x-axis. Defaults to "popANI".
    yaxis_title (str, optional): Title of the y-axis. Defaults to "Fraction of Identical Genes".
Returns:
    go.Figure: Plotly figure containing the fraction of identical genes vs popANI plot.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/visualize.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_identical_frac_vs_popani</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                  <span class="n">genome</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                                  <span class="n">title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;Fraction of Identical Genes vs popANI for &lt;GENOME&gt;&quot;</span><span class="p">,</span>
                                  <span class="n">xaxis_title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;Genome-Wide popANI&quot;</span><span class="p">,</span>
                                  <span class="n">yaxis_title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;Fraction of Identical Genes&quot;</span><span class="p">,</span>
                                  <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the fraction of identical genes vs popANI for a given genome and two samples in any possible combination of populations.</span>
<span class="sd">    Args:</span>
<span class="sd">        df (pl.DataFrame): DataFrame containing the fraction of identical genes vs popANI information.</span>
<span class="sd">        title (str, optional): Title of the plot. Defaults to &quot;Fraction of Identical Genes vs popANI&quot;.</span>
<span class="sd">        xaxis_title (str, optional): Title of the x-axis. Defaults to &quot;popANI&quot;.</span>
<span class="sd">        yaxis_title (str, optional): Title of the y-axis. Defaults to &quot;Fraction of Identical Genes&quot;.</span>
<span class="sd">    Returns:</span>
<span class="sd">        go.Figure: Plotly figure containing the fraction of identical genes vs popANI plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">perc_id_genes</span><span class="p">,</span> <span class="n">genome_pop_ani</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;relationship&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;perc_id_genes&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;genome_pop_ani&quot;</span><span class="p">]):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">genome_pop_ani</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">perc_id_genes</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">group</span>
        <span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;GENOME&gt;&quot;</span><span class="p">,</span> <span class="n">genome</span><span class="p">),</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="n">xaxis_title</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="n">yaxis_title</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.visualize.plot_strainsharing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_strainsharing</span><span class="p">(</span><span class="n">strainsharingrates</span><span class="p">,</span> <span class="n">sample_frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Strain Sharing Rates&#39;</span><span class="p">,</span> <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Population Pair&#39;</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Strain Sharing Rate&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Plot the strain sharing rates between populations.
Args:
    strainsharingrates (dict[str, list[float]]): Dictionary containing the strain sharing rates between populations.
    title (str, optional): Title of the plot. Defaults to "Strain Sharing".
    xaxis_title (str, optional): Title of the x-axis. Defaults to "Population Pair".
    yaxis_title (str, optional): Title of the y-axis. Defaults to "Strain Sharing Rate".
Returns:
    go.Figure: Plotly figure containing the strain sharing plot.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/visualize.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_strainsharing</span><span class="p">(</span>
    <span class="n">strainsharingrates</span><span class="p">:</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">sample_frac</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;Strain Sharing Rates&quot;</span><span class="p">,</span>
    <span class="n">xaxis_title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;Population Pair&quot;</span><span class="p">,</span>
    <span class="n">yaxis_title</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;Strain Sharing Rate&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the strain sharing rates between populations.</span>
<span class="sd">    Args:</span>
<span class="sd">        strainsharingrates (dict[str, list[float]]): Dictionary containing the strain sharing rates between populations.</span>
<span class="sd">        title (str, optional): Title of the plot. Defaults to &quot;Strain Sharing&quot;.</span>
<span class="sd">        xaxis_title (str, optional): Title of the x-axis. Defaults to &quot;Population Pair&quot;.</span>
<span class="sd">        yaxis_title (str, optional): Title of the y-axis. Defaults to &quot;Strain Sharing Rate&quot;.</span>
<span class="sd">    Returns:</span>
<span class="sd">        go.Figure: Plotly figure containing the strain sharing plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">strainsharingrates</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">strainsharingrates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">strainsharingrates</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">strainsharingrates</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">*</span> <span class="n">sample_frac</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">rates</span> <span class="ow">in</span> <span class="n">strainsharingrates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
            <span class="n">y</span><span class="o">=</span><span class="n">rates</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">pair</span><span class="p">,</span>
            <span class="n">boxpoints</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
            <span class="n">jitter</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="n">pointpos</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="n">xaxis_title</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="n">yaxis_title</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<p>For more advanced users, new workflows can be developed using the task_manager module to create custom pipelines tailored to specific research needs.</p>
<hr />
<h2 id="task-manager">Task Manager</h2>


<div class="doc doc-object doc-module">



<a id="zipstrain.task_manager"></a>
    <div class="doc doc-contents first">

        <h4 id="zipstrain.task_manager--zipstraintask_manager">zipstrain.task_manager</h4>
<p>Lightweight, asyncio-driven orchestration primitives for building and running
scientific data-processing pipelines. This module provides a small, composable
framework for defining Tasks with explicit inputs/outputs, bundling Tasks into
Batches (local or Slurm), and coordinating their execution with a live terminal
UI. It is designed to be easy to extend for new Task types and execution
environments. For most users, this module is not directly used. However, 
it can be used to define new pipelines that chain together multiple steps with clear input/outputs.
The unit of execution is a batch, which is a collection of tasks to be executed together.
Each batch can have an optional finalization step that runs after all tasks are complete.</p>
<h5 id="zipstrain.task_manager--key-concepts">Key concepts</h5>
<ul>
<li>
<p>Inputs and Outputs:
    These classes encapsulate task inputs and outputs with validation logics.
    By default, Input and output classes for files, strings, and integers are provided.
    If needed, new types can be defined by subclassing Input or Output.</p>
</li>
<li>
<p>Engines:
    Any task object can use a container engine (Docker or Apptainer) or run natively (LocalEngine).</p>
</li>
<li>
<p>Task 
    Each task runs a unit of bash script with defined inputs and expected outputs. If an engine is provided,
    the command will be wrapped accordingly to run inside the container.</p>
</li>
<li>
<p>Batches:
    A batch is a collection of tasks to be executed together. Batches can be run locally or submitted to Slurm.
    Each batch monitors the status of its tasks and updates its own status accordingly. A batch can also have
    expected outputs that are checked after all tasks are complete. Additionally, a batch can have a finalization step that runs after all tasks are complete.</p>
</li>
<li>
<p>Runner:
    The Runner class orchestrates task generation, batching, and execution. It manages concurrent batch execution,
    monitors progress, and provides a live terminal UI using the rich library.</p>
</li>
</ul>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.Batch" class="doc doc-heading">
            <code>Batch</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Batch is a collection of tasks to be executed as a group. This is a base class and should not be instantiated directly.
A batch is the unit of execution meaning that the enitre batch is either run locally or submitted to a job scheduler like Slurm.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tasks</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="Task (zipstrain.task_manager.Task)" href="#zipstrain.task_manager.Task">Task</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of Task objects to be included in the batch.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the batch.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>run_dir</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory where the batch will be executed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>expected_outputs</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="Output (zipstrain.task_manager.Output)" href="#zipstrain.task_manager.Output">Output</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of expected outputs for the batch.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Batch</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Batch is a collection of tasks to be executed as a group. This is a base class and should not be instantiated directly.</span>
<span class="sd">    A batch is the unit of execution meaning that the enitre batch is either run locally or submitted to a job scheduler like Slurm.</span>

<span class="sd">    Args:</span>
<span class="sd">        tasks (list[Task]): List of Task objects to be included in the batch.</span>
<span class="sd">        id (str): Unique identifier for the batch.</span>
<span class="sd">        run_dir (pathlib.Path): Directory where the batch will be executed.</span>
<span class="sd">        expected_outputs (list[Output]): List of expected outputs for the batch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TEMPLATE_CMD</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Task</span><span class="p">],</span>
                 <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">run_dir</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
                 <span class="n">expected_outputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Output</span><span class="p">],</span>
                 <span class="n">file_semaphore</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_outputs</span> <span class="o">=</span> <span class="n">expected_outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span> <span class="o">=</span> <span class="n">file_semaphore</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_outputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">BatchFileOutput</span><span class="p">):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">register_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_initial_status</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">_batch_obj</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">task</span><span class="o">.</span><span class="n">file_semaphore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span>
            <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">expected_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">output</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">_status</span><span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">_get_initial_status</span><span class="p">()</span>
            <span class="n">task</span><span class="o">.</span><span class="n">map_io</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_runner_obj</span><span class="p">:</span><span class="n">Runner</span> <span class="o">=</span> <span class="kc">None</span>



    <span class="k">def</span><span class="w"> </span><span class="nf">_get_initial_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the initial status of the batch based on the presence of the batch directory.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">status_as_written</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">status_as_written</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Status</span><span class="o">.</span><span class="n">DONE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="n">all_ready</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_outputs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
                        <span class="n">all_ready</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">all_ready</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">all_ready</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The base class defines if any cleanup is needed after batch success. By default, it does nothing.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancels the batch. This method should be implemented by subclasses.&quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">outputs_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if all BATCH-LEVEL expected outputs are ready.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_outputs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_collect_task_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collects the status of all tasks asynchronously.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">])</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs the batch. This method should be implemented by subclasses.&quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_job_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sbatch_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parses the job ID from the sbatch output. This method should be implemented by subclasses.&quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the current status of the batch.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of task IDs and their statuses.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the status of the batch by collecting the status of all tasks.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_task_status</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_file_semaphore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_semaphore</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span> <span class="o">=</span> <span class="n">file_semaphore</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">file_semaphore</span> <span class="o">=</span> <span class="n">file_semaphore</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h5 id="zipstrain.task_manager.Batch.stats" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">stats</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Returns a dictionary of task IDs and their statuses.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="zipstrain.task_manager.Batch.status" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">status</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Returns the current status of the batch.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.Batch.cancel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cancel</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Cancels the batch. This method should be implemented by subclasses.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cancels the batch. This method should be implemented by subclasses.&quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.Batch.cleanup" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cleanup</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>The base class defines if any cleanup is needed after batch success. By default, it does nothing.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The base class defines if any cleanup is needed after batch success. By default, it does nothing.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.Batch.outputs_ready" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">outputs_ready</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Check if all BATCH-LEVEL expected outputs are ready.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">outputs_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if all BATCH-LEVEL expected outputs are ready.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_outputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.Batch.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Runs the batch. This method should be implemented by subclasses.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Runs the batch. This method should be implemented by subclasses.&quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.Batch.update_status" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_status</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Updates the status of the batch by collecting the status of all tasks.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Updates the status of the batch by collecting the status of all tasks.&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_task_status</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.BatchFileOutput" class="doc doc-heading">
            <code>BatchFileOutput</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Output (zipstrain.task_manager.Output)" href="#zipstrain.task_manager.Output">Output</a></code></p>


        <p>This is used when the output is a file path relative to the batch directory.
Also it will be registered to the batch instead of the task.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BatchFileOutput</span><span class="p">(</span><span class="n">Output</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is used when the output is a file path relative to the batch directory.</span>
<span class="sd">    Also it will be registered to the batch instead of the task.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_file</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expected_file_name</span> <span class="o">=</span> <span class="n">expected_file</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the expected output file exists.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_file</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Batch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Registers the batch that produces this output and sets the expected file path.</span>

<span class="sd">        Args:</span>
<span class="sd">        batch (Batch): The batch that produces this output and sets the expected file path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_file</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_file_name</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.BatchFileOutput.ready" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ready</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Check if the expected output file exists.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the expected output file exists.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_file</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.BatchFileOutput.register_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">register_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Registers the batch that produces this output and sets the expected file path.</p>
<p>Args:
batch (Batch): The batch that produces this output and sets the expected file path.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">register_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Batch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Registers the batch that produces this output and sets the expected file path.</span>

<span class="sd">    Args:</span>
<span class="sd">    batch (Batch): The batch that produces this output and sets the expected file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">expected_file</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_file_name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.CollectComps" class="doc doc-heading">
            <code>CollectComps</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Task (zipstrain.task_manager.Task)" href="#zipstrain.task_manager.Task">Task</a></code></p>


        <p>A Task that collects and merges comparison parquet files from multiple FastCompareTask tasks into a single parquet file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the task.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inputs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="Input (zipstrain.task_manager.Input)" href="#zipstrain.task_manager.Input">Input</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of input parameters for the task.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>expected_outputs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="Output (zipstrain.task_manager.Output)" href="#zipstrain.task_manager.Output">Output</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of expected outputs for the task.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>engine</code>
            </td>
            <td>
                  <code><span title="zipstrain.task_manager.Engine">Engine</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Container engine to wrap the command.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CollectComps</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Task that collects and merges comparison parquet files from multiple FastCompareTask tasks into a single parquet file.</span>

<span class="sd">    Args:</span>
<span class="sd">        id (str): Unique identifier for the task.</span>
<span class="sd">        inputs (dict[str, Input]): Dictionary of input parameters for the task.</span>
<span class="sd">        expected_outputs (dict[str, Output]): Dictionary of expected outputs for the task.</span>
<span class="sd">        engine (Engine): Container engine to wrap the command.&quot;&quot;&quot;</span>
    <span class="n">TEMPLATE_CMD</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    mkdir -p comps</span>
<span class="s2">    cp */*_comparison.parquet comps/</span>
<span class="s2">    zipstrain utilities merge_parquet --input-dir comps --output-file &lt;output-file&gt;</span>
<span class="s2">    rm -rf comps</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pre_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;echo </span><span class="si">{</span><span class="n">Status</span><span class="o">.</span><span class="n">RUNNING</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dir</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">/.status&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.CompareRunner" class="doc doc-heading">
            <code>CompareRunner</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Runner (zipstrain.task_manager.Runner)" href="#zipstrain.task_manager.Runner">Runner</a></code></p>


        <p>Creates and schedules batches of FastCompareTask tasks using either local or Slurm batches.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>run_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory where the runner will operate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>task_generator</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskGenerator (zipstrain.task_manager.TaskGenerator)" href="#zipstrain.task_manager.TaskGenerator">TaskGenerator</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of TaskGenerator to produce tasks.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container_engine</code>
            </td>
            <td>
                  <code><span title="zipstrain.task_manager.Engine">Engine</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of Engine to wrap task commands.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_concurrent_batches</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of batches to run concurrently. Default is 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>poll_interval</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time interval in seconds to poll for batch status updates. Default is 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tasks_per_batch</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of tasks to include in each batch. Default is 10.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of batch to use ("local" or "slurm"). Default is "local".</p>
              </div>
            </td>
            <td>
                  <code>&#39;local&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>slurm_config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="SlurmConfig (zipstrain.task_manager.SlurmConfig)" href="#zipstrain.task_manager.SlurmConfig">SlurmConfig</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for Slurm batches if batch_type
is "slurm". Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CompareRunner</span><span class="p">(</span><span class="n">Runner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates and schedules batches of FastCompareTask tasks using either local or Slurm batches.</span>

<span class="sd">    Args:</span>
<span class="sd">        run_dir (str | pathlib.Path): Directory where the runner will operate.</span>
<span class="sd">        task_generator (TaskGenerator): An instance of TaskGenerator to produce tasks.</span>
<span class="sd">        container_engine (Engine): An instance of Engine to wrap task commands.</span>
<span class="sd">        max_concurrent_batches (int): Maximum number of batches to run concurrently. Default is 1.</span>
<span class="sd">        poll_interval (float): Time interval in seconds to poll for batch status updates. Default is 1.0.</span>
<span class="sd">        tasks_per_batch (int): Number of tasks to include in each batch. Default is 10.</span>
<span class="sd">        batch_type (str): Type of batch to use (&quot;local&quot; or &quot;slurm&quot;). Default is &quot;local&quot;.</span>
<span class="sd">        slurm_config (SlurmConfig | None): Configuration for Slurm batches if batch_type</span>
<span class="sd">            is &quot;slurm&quot;. Default is None.    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
        <span class="n">task_generator</span><span class="p">:</span> <span class="n">TaskGenerator</span><span class="p">,</span>
        <span class="n">container_engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
        <span class="n">max_concurrent_batches</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">tasks_per_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">batch_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span><span class="p">,</span>
        <span class="n">slurm_config</span><span class="p">:</span> <span class="n">SlurmConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">batch_type</span> <span class="o">==</span> <span class="s2">&quot;slurm&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">slurm_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Slurm config must be provided for slurm batch type.&quot;</span><span class="p">)</span>
            <span class="n">batch_factory</span> <span class="o">=</span> <span class="n">FastCompareSlurmBatch</span>
            <span class="n">final_batch_factory</span> <span class="o">=</span> <span class="n">PrepareCompareGenomeRunOutputsSlurmBatch</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_factory</span> <span class="o">=</span> <span class="n">FastCompareLocalBatch</span>
            <span class="n">final_batch_factory</span> <span class="o">=</span> <span class="n">PrepareCompareGenomeRunOutputsLocalBatch</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">run_dir</span><span class="o">=</span><span class="n">run_dir</span><span class="p">,</span>
            <span class="n">task_generator</span><span class="o">=</span><span class="n">task_generator</span><span class="p">,</span>
            <span class="n">container_engine</span><span class="o">=</span><span class="n">container_engine</span><span class="p">,</span>
            <span class="n">batch_factory</span><span class="o">=</span><span class="n">batch_factory</span><span class="p">,</span>
            <span class="n">final_batch_factory</span><span class="o">=</span><span class="n">final_batch_factory</span><span class="p">,</span>
            <span class="n">max_concurrent_batches</span><span class="o">=</span><span class="n">max_concurrent_batches</span><span class="p">,</span>
            <span class="n">poll_interval</span><span class="o">=</span><span class="n">poll_interval</span><span class="p">,</span>
            <span class="n">tasks_per_batch</span><span class="o">=</span><span class="n">tasks_per_batch</span><span class="p">,</span>
            <span class="n">batch_type</span><span class="o">=</span><span class="n">batch_type</span><span class="p">,</span>
            <span class="n">slurm_config</span><span class="o">=</span><span class="n">slurm_config</span><span class="p">,</span>
        <span class="p">)</span>




    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_batcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines the batcher coroutine that collects tasks from the tasks_queue, groups them into batches,</span>
<span class="sd">        and puts the batches into the batches_queue. Each batch includes a CollectComps task to merge the outputs of the tasks in the batch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buffer</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">buffer</span><span class="p">:</span>
                    <span class="n">batch_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;batch_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_counter</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_batch_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">batch_tasks</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="p">[</span>
                        <span class="n">CollectComps</span><span class="p">(</span>
                            <span class="s2">&quot;concat_parquet&quot;</span><span class="p">,</span>
                            <span class="p">{},</span>
                            <span class="p">{</span><span class="s2">&quot;output-file&quot;</span><span class="p">:</span> <span class="n">FileOutput</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merged_batch_</span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">)},</span>
                            <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">container_engine</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">]</span>
                    <span class="n">expected_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">BatchFileOutput</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;concat_parquet/Merged_batch_</span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_type</span> <span class="o">==</span> <span class="s2">&quot;slurm&quot;</span><span class="p">:</span>
                        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_factory</span><span class="p">(</span>
                            <span class="n">tasks</span><span class="o">=</span><span class="n">batch_tasks</span><span class="p">,</span>
                            <span class="nb">id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">,</span>
                            <span class="n">run_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span>
                            <span class="n">expected_outputs</span><span class="o">=</span><span class="n">expected_outputs</span><span class="p">,</span>
                            <span class="n">slurm_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_config</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_factory</span><span class="p">(</span>
                            <span class="n">tasks</span><span class="o">=</span><span class="n">batch_tasks</span><span class="p">,</span>
                            <span class="nb">id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">,</span>
                            <span class="n">run_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span>
                            <span class="n">expected_outputs</span><span class="o">=</span><span class="n">expected_outputs</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_batcher_done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_per_batch</span><span class="p">:</span>
                <span class="n">batch_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;batch_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_counter</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_batch_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">batch_tasks</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="p">[</span>
                    <span class="n">CollectComps</span><span class="p">(</span>
                        <span class="s2">&quot;concat_parquet&quot;</span><span class="p">,</span>
                        <span class="p">{},</span>
                        <span class="p">{</span><span class="s2">&quot;output-file&quot;</span><span class="p">:</span> <span class="n">FileOutput</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merged_batch_</span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">)},</span>
                        <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">container_engine</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">]</span>
                <span class="n">expected_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">BatchFileOutput</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;concat_parquet/Merged_batch_</span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2">.parquet&quot;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_type</span> <span class="o">==</span> <span class="s2">&quot;slurm&quot;</span><span class="p">:</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_factory</span><span class="p">(</span>
                        <span class="n">tasks</span><span class="o">=</span><span class="n">batch_tasks</span><span class="p">,</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">,</span>
                        <span class="n">run_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span>
                        <span class="n">expected_outputs</span><span class="o">=</span><span class="n">expected_outputs</span><span class="p">,</span>
                        <span class="n">slurm_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_config</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_factory</span><span class="p">(</span>
                        <span class="n">tasks</span><span class="o">=</span><span class="n">batch_tasks</span><span class="p">,</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">,</span>
                        <span class="n">run_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span>
                        <span class="n">expected_outputs</span><span class="o">=</span><span class="n">expected_outputs</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>



    <span class="k">def</span><span class="w"> </span><span class="nf">_create_final_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Batch</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates the final batch that prepares the overall outputs after all comparison batches are done.&quot;&quot;&quot;</span>
        <span class="n">final_task</span> <span class="o">=</span> <span class="n">PrepareCompareGenomeRunOutputs</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;prepare_outputs&quot;</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;output-dir&quot;</span><span class="p">:</span> <span class="n">StringInput</span><span class="p">(</span><span class="s2">&quot;Outputs&quot;</span><span class="p">)},</span>
            <span class="n">expected_outputs</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">container_engine</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">expected_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">BatchFileOutput</span><span class="p">(</span><span class="s2">&quot;all_comparisons.parquet&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_type</span> <span class="o">==</span> <span class="s2">&quot;slurm&quot;</span><span class="p">:</span>
            <span class="n">final_batch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">final_batch_factory</span><span class="p">(</span>
                <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="n">final_task</span><span class="p">],</span>
                <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Outputs&quot;</span><span class="p">,</span>
                <span class="n">run_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span>
                <span class="n">expected_outputs</span><span class="o">=</span><span class="n">expected_outputs</span><span class="p">,</span>
                <span class="n">slurm_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_config</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">final_batch</span><span class="o">.</span><span class="n">_runner_obj</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">return</span> <span class="n">final_batch</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_batch_factory</span><span class="p">(</span>
                <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="n">final_task</span><span class="p">],</span>
                <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;Outputs&quot;</span><span class="p">,</span>
                <span class="n">run_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span>
                <span class="n">expected_outputs</span><span class="o">=</span><span class="n">expected_outputs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">final_batch</span><span class="o">.</span><span class="n">_runner_obj</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">return</span> <span class="n">final_batch</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.CompareTaskGenerator" class="doc doc-heading">
            <code>CompareTaskGenerator</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="TaskGenerator (zipstrain.task_manager.TaskGenerator)" href="#zipstrain.task_manager.TaskGenerator">TaskGenerator</a></code></p>


        <p>This TaskGenerator generates FastCompareTask objects from a polars DataFrame. Each task compares two profiles using compare_genomes functionality in
zipstrain.compare module.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="polars.LazyFrame">LazyFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Polars LazyFrame containing the data for generating tasks.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>yield_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of tasks to yield at a time.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>comp_config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="GenomeComparisonConfig (zipstrain.database.GenomeComparisonConfig)" href="#zipstrain.database.GenomeComparisonConfig">GenomeComparisonConfig</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for genome comparison.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>memory_mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Memory mode for the comparison task. Default is "heavy".</p>
              </div>
            </td>
            <td>
                  <code>&#39;heavy&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>polars_engine</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Polars engine to use. Default is "streaming".</p>
              </div>
            </td>
            <td>
                  <code>&#39;streaming&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chrom_batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Chromosome batch size for the comparison task in light memory mode. Default is 10000.</p>
              </div>
            </td>
            <td>
                  <code>10000</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CompareTaskGenerator</span><span class="p">(</span><span class="n">TaskGenerator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This TaskGenerator generates FastCompareTask objects from a polars DataFrame. Each task compares two profiles using compare_genomes functionality in</span>
<span class="sd">    zipstrain.compare module.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (pl.LazyFrame): Polars LazyFrame containing the data for generating tasks.</span>
<span class="sd">        yield_size (int): Number of tasks to yield at a time.</span>
<span class="sd">        comp_config (database.GenomeComparisonConfig): Configuration for genome comparison.</span>
<span class="sd">        memory_mode (str): Memory mode for the comparison task. Default is &quot;heavy&quot;.</span>
<span class="sd">        polars_engine (str): Polars engine to use. Default is &quot;streaming&quot;.</span>
<span class="sd">        chrom_batch_size (int): Chromosome batch size for the comparison task in light memory mode. Default is 10000.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
        <span class="n">yield_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">container_engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
        <span class="n">comp_config</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">GenomeComparisonConfig</span><span class="p">,</span>
        <span class="n">memory_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;heavy&quot;</span><span class="p">,</span>
        <span class="n">polars_engine</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;streaming&quot;</span><span class="p">,</span>
        <span class="n">chrom_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">yield_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comp_config</span> <span class="o">=</span> <span class="n">comp_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">container_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory_mode</span> <span class="o">=</span> <span class="n">memory_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polars_engine</span> <span class="o">=</span> <span class="n">polars_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chrom_batch_size</span> <span class="o">=</span> <span class="n">chrom_batch_size</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data must be a polars LazyFrame.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns total number of pairwise comparisons to be made.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yeilds lists of FastCompareTask objects based on the data in batches of yield_size. This method yields the control back to the event loop</span>
<span class="sd">        while polars is collecting data to avoid blocking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_size</span><span class="p">):</span>
            <span class="n">batch_df</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_size</span><span class="p">)</span><span class="o">.</span><span class="n">collect_async</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">batch_df</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mpile_1_file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;profile_location_1&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;mpile_2_file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;profile_location_2&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;scaffold_1_file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;scaffold_location_1&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;scaffold_2_file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;scaffold_location_2&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;null_model_file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_config</span><span class="o">.</span><span class="n">null_model_loc</span><span class="p">),</span>
                <span class="s2">&quot;stb_file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_config</span><span class="o">.</span><span class="n">stb_file_loc</span><span class="p">),</span>
                <span class="s2">&quot;min_cov&quot;</span><span class="p">:</span> <span class="n">IntInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_config</span><span class="o">.</span><span class="n">min_cov</span><span class="p">),</span>
                <span class="s2">&quot;min-gene-compare-len&quot;</span><span class="p">:</span> <span class="n">IntInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_config</span><span class="o">.</span><span class="n">min_gene_compare_len</span><span class="p">),</span>
                <span class="s2">&quot;memory-mode&quot;</span><span class="p">:</span> <span class="n">StringInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_mode</span><span class="p">),</span>
                <span class="s2">&quot;chrom-batch-size&quot;</span><span class="p">:</span> <span class="n">IntInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chrom_batch_size</span><span class="p">),</span>
                <span class="s2">&quot;genome-name&quot;</span><span class="p">:</span> <span class="n">StringInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_config</span><span class="o">.</span><span class="n">scope</span><span class="p">),</span>
                <span class="s2">&quot;engine&quot;</span><span class="p">:</span> <span class="n">StringInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polars_engine</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="n">expected_outputs</span> <span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;output-file&quot;</span><span class="p">:</span>  <span class="n">FileOutput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name_1&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name_2&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_comparison.parquet&quot;</span> <span class="p">),</span>

                <span class="p">}</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">FastCompareTask</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name_1&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name_2&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">expected_outputs</span><span class="o">=</span><span class="n">expected_outputs</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">tasks</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.CompareTaskGenerator.generate_tasks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_tasks</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Yeilds lists of FastCompareTask objects based on the data in batches of yield_size. This method yields the control back to the event loop
while polars is collecting data to avoid blocking.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Yeilds lists of FastCompareTask objects based on the data in batches of yield_size. This method yields the control back to the event loop</span>
<span class="sd">    while polars is collecting data to avoid blocking.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_size</span><span class="p">):</span>
        <span class="n">batch_df</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_size</span><span class="p">)</span><span class="o">.</span><span class="n">collect_async</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">batch_df</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;mpile_1_file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;profile_location_1&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;mpile_2_file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;profile_location_2&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;scaffold_1_file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;scaffold_location_1&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;scaffold_2_file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;scaffold_location_2&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;null_model_file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_config</span><span class="o">.</span><span class="n">null_model_loc</span><span class="p">),</span>
            <span class="s2">&quot;stb_file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_config</span><span class="o">.</span><span class="n">stb_file_loc</span><span class="p">),</span>
            <span class="s2">&quot;min_cov&quot;</span><span class="p">:</span> <span class="n">IntInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_config</span><span class="o">.</span><span class="n">min_cov</span><span class="p">),</span>
            <span class="s2">&quot;min-gene-compare-len&quot;</span><span class="p">:</span> <span class="n">IntInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_config</span><span class="o">.</span><span class="n">min_gene_compare_len</span><span class="p">),</span>
            <span class="s2">&quot;memory-mode&quot;</span><span class="p">:</span> <span class="n">StringInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_mode</span><span class="p">),</span>
            <span class="s2">&quot;chrom-batch-size&quot;</span><span class="p">:</span> <span class="n">IntInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chrom_batch_size</span><span class="p">),</span>
            <span class="s2">&quot;genome-name&quot;</span><span class="p">:</span> <span class="n">StringInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_config</span><span class="o">.</span><span class="n">scope</span><span class="p">),</span>
            <span class="s2">&quot;engine&quot;</span><span class="p">:</span> <span class="n">StringInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polars_engine</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">expected_outputs</span> <span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;output-file&quot;</span><span class="p">:</span>  <span class="n">FileOutput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name_1&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name_2&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_comparison.parquet&quot;</span> <span class="p">),</span>

            <span class="p">}</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">FastCompareTask</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name_1&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name_2&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">expected_outputs</span><span class="o">=</span><span class="n">expected_outputs</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">tasks</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.CompareTaskGenerator.get_total_tasks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_total_tasks</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Returns total number of pairwise comparisons to be made.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_total_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns total number of pairwise comparisons to be made.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.FastCompareLocalBatch" class="doc doc-heading">
            <code>FastCompareLocalBatch</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="LocalBatch (zipstrain.task_manager.LocalBatch)" href="#zipstrain.task_manager.LocalBatch">LocalBatch</a></code></p>


        <p>A LocalBatch that runs FastCompareTask tasks locally.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FastCompareLocalBatch</span><span class="p">(</span><span class="n">LocalBatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A LocalBatch that runs FastCompareTask tasks locally.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tasks_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">FastCompareTask</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks_to_remove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">task_dir</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.FastCompareSlurmBatch" class="doc doc-heading">
            <code>FastCompareSlurmBatch</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="SlurmBatch (zipstrain.task_manager.SlurmBatch)" href="#zipstrain.task_manager.SlurmBatch">SlurmBatch</a></code></p>


        <p>A SlurmBatch that runs FastCompareTask tasks on a Slurm cluster. Maybe removed in future</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FastCompareSlurmBatch</span><span class="p">(</span><span class="n">SlurmBatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A SlurmBatch that runs FastCompareTask tasks on a Slurm cluster. Maybe removed in future&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tasks_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">FastCompareTask</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks_to_remove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">task_dir</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.FastCompareTask" class="doc doc-heading">
            <code>FastCompareTask</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Task (zipstrain.task_manager.Task)" href="#zipstrain.task_manager.Task">Task</a></code></p>


        <p>A Task that performs a fast genome comparison using the fast_profile compare single_compare_genome command.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the task.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inputs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="Input (zipstrain.task_manager.Input)" href="#zipstrain.task_manager.Input">Input</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of input parameters for the task.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>expected_outputs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="Output (zipstrain.task_manager.Output)" href="#zipstrain.task_manager.Output">Output</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of expected outputs for the task.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>engine</code>
            </td>
            <td>
                  <code><span title="zipstrain.task_manager.Engine">Engine</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Container engine to wrap the command.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FastCompareTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Task that performs a fast genome comparison using the fast_profile compare single_compare_genome command.</span>

<span class="sd">    Args:</span>
<span class="sd">        id (str): Unique identifier for the task.</span>
<span class="sd">        inputs (dict[str, Input]): Dictionary of input parameters for the task.</span>
<span class="sd">        expected_outputs (dict[str, Output]): Dictionary of expected outputs for the task.</span>
<span class="sd">        engine (Engine): Container engine to wrap the command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">TEMPLATE_CMD</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    zipstrain compare single_compare_genome --mpileup-contig-1 &lt;mpile_1_file&gt; </span><span class="se">\</span>
<span class="s2">    --mpileup-contig-2 &lt;mpile_2_file&gt; </span><span class="se">\</span>
<span class="s2">    --scaffolds-1 &lt;scaffold_1_file&gt; </span><span class="se">\</span>
<span class="s2">    --scaffolds-2 &lt;scaffold_2_file&gt; </span><span class="se">\</span>
<span class="s2">    --null-model &lt;null_model_file&gt; </span><span class="se">\</span>
<span class="s2">    --stb-file &lt;stb_file&gt; </span><span class="se">\</span>
<span class="s2">    --min-cov &lt;min_cov&gt; </span><span class="se">\</span>
<span class="s2">    --min-gene-compare-len &lt;min-gene-compare-len&gt; </span><span class="se">\</span>
<span class="s2">    --memory-mode &lt;memory-mode&gt; </span><span class="se">\</span>
<span class="s2">    --chrom-batch-size &lt;chrom-batch-size&gt; </span><span class="se">\</span>
<span class="s2">    --output-file &lt;output-file&gt; </span><span class="se">\</span>
<span class="s2">    --genome &lt;genome-name&gt; </span><span class="se">\</span>
<span class="s2">    --engine &lt;engine&gt; </span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.FileInput" class="doc doc-heading">
            <code>FileInput</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Input (zipstrain.task_manager.Input)" href="#zipstrain.task_manager.Input">Input</a></code></p>


        <p>This is used when the input is a file path. By default, the validate method checks for file existence.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FileInput</span><span class="p">(</span><span class="n">Input</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is used when the input is a file path. By default, the validate method checks for file existence.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_exists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">check_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the absolute path of the input file as a string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.FileInput.get_value" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_value</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Returns the absolute path of the input file as a string.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the absolute path of the input file as a string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.FileOutput" class="doc doc-heading">
            <code>FileOutput</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Output (zipstrain.task_manager.Output)" href="#zipstrain.task_manager.Output">Output</a></code></p>


        <p>This is used when the output is a file path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>expected_file</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The expected output file name relative to the task directory.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FileOutput</span><span class="p">(</span><span class="n">Output</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is used when the output is a file path.</span>

<span class="sd">    Args:</span>
<span class="sd">        expected_file (str): The expected output file name relative to the task directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected_file</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expected_file_name</span> <span class="o">=</span> <span class="n">expected_file</span> <span class="c1">### When the task is finished, the expected file should be in task.task_dir / expected_file otherwise ready() will return False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the expected output file exists.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_file</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Registers the task that produces this output and sets the expected file path.</span>

<span class="sd">        Args:</span>
<span class="sd">        task (Task): The task that produces this output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">task_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_file_name</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.FileOutput.ready" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ready</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Check if the expected output file exists.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the expected output file exists.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_file</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.FileOutput.register_task" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">register_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Registers the task that produces this output and sets the expected file path.</p>
<p>Args:
task (Task): The task that produces this output.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">register_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Registers the task that produces this output and sets the expected file path.</span>

<span class="sd">    Args:</span>
<span class="sd">    task (Task): The task that produces this output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">register_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">expected_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">task_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_file_name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.Input" class="doc doc-heading">
            <code>Input</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Abstract base class for task inputs. DO NOT INSTANTIATE DIRECTLY.
Most commonly used Input types are provided but if you want to define a new one,
subclass this and implement validate() and get_value().</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Input</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for task inputs. DO NOT INSTANTIATE DIRECTLY.</span>
<span class="sd">    Most commonly used Input types are provided but if you want to define a new one,</span>
<span class="sd">    subclass this and implement validate() and get_value().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">:</span>
        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.IntInput" class="doc doc-heading">
            <code>IntInput</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Input (zipstrain.task_manager.Input)" href="#zipstrain.task_manager.Input">Input</a></code></p>


        <p>This is used when the input is an integer.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">IntInput</span><span class="p">(</span><span class="n">Input</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is used when the input is an integer.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate that the input value is an integer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input value </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">!r}</span><span class="s2"> is not an integer.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the integer value as a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.IntInput.get_value" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_value</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Returns the integer value as a string.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the integer value as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.IntInput.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Validate that the input value is an integer.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate that the input value is an integer.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input value </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">!r}</span><span class="s2"> is not an integer.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.IntOutput" class="doc doc-heading">
            <code>IntOutput</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Output (zipstrain.task_manager.Output)" href="#zipstrain.task_manager.Output">Output</a></code></p>


        <p>This is used when the output is an integer.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">IntOutput</span><span class="p">(</span><span class="n">Output</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is used when the output is an integer.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the output value is an integer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output value for task </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> is not an integer.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.IntOutput.ready" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ready</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Check if the output value is an integer.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the output value is an integer.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output value for task </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> is not an integer.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.LocalBatch" class="doc doc-heading">
            <code>LocalBatch</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Batch (zipstrain.task_manager.Batch)" href="#zipstrain.task_manager.Batch">Batch</a></code></p>


        <p>Batch that runs tasks locally in a single shell script.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LocalBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Batch that runs tasks locally in a single shell script.&quot;&quot;&quot;</span>
    <span class="n">TEMPLATE_CMD</span> <span class="o">=</span> <span class="s2">&quot;#!/bin/bash</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">,</span> <span class="n">expected_outputs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">,</span> <span class="n">expected_outputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEMPLATE_CMD</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">set -o pipefail</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Process</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span> 


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method runs all tasks in the batch locally by creating a shell script and executing it.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">RUNNING</span><span class="o">.</span><span class="n">value</span>


            <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">task_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Create task directory</span>
                    <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">task_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

            <span class="n">script_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.sh&quot;</span> <span class="c1"># Path to the shell script for the batch</span>

            <span class="n">script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_script</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">pre_run</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">command</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">post_run</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
                <span class="s2">&quot;bash&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.sh&quot;</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out_bytes</span><span class="p">,</span> <span class="n">err_bytes</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="k">raise</span>

            <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.out&quot;</span><span class="p">,</span> <span class="n">out_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.err&quot;</span><span class="p">,</span> <span class="n">err_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_ready</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span>
                <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
                <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_ready</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_job_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sbatch_output</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_parse_job_id</span><span class="p">(</span><span class="n">sbatch_output</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancels the local batch by terminating the subprocess if it&#39;s running.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
            <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.LocalBatch.cancel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cancel</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Cancels the local batch by terminating the subprocess if it's running.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cancels the local batch by terminating the subprocess if it&#39;s running.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
        <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.LocalBatch.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>This method runs all tasks in the batch locally by creating a shell script and executing it.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This method runs all tasks in the batch locally by creating a shell script and executing it.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">RUNNING</span><span class="o">.</span><span class="n">value</span>


        <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">task_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Create task directory</span>
                <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">task_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

        <span class="n">script_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.sh&quot;</span> <span class="c1"># Path to the shell script for the batch</span>

        <span class="n">script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_script</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span> <span class="ow">or</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">pre_run</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">command</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">post_run</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
            <span class="s2">&quot;bash&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.sh&quot;</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out_bytes</span><span class="p">,</span> <span class="n">err_bytes</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">raise</span>

        <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.out&quot;</span><span class="p">,</span> <span class="n">out_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.err&quot;</span><span class="p">,</span> <span class="n">err_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_ready</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span>
            <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
            <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_ready</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.Output" class="doc doc-heading">
            <code>Output</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Abstract base class for task outputs. DO NOT INSTANTIATE DIRECTLY.
Most commonly used Output types are provided but if you want to define a new one,
subclass this and implement ready().
This method is used to check if the output is ready/valid after task completion.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Output</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for task outputs. DO NOT INSTANTIATE DIRECTLY.</span>
<span class="sd">    Most commonly used Output types are provided but if you want to define a new one,</span>
<span class="sd">    subclass this and implement ready().</span>
<span class="sd">    This method is used to check if the output is ready/valid after task completion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">## Will be set by the task when it completes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">## Will be set when the output is registered to a task</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Registers the task that produces this output. In most cases, you won&#39;t need to override this.</span>

<span class="sd">        Args:</span>
<span class="sd">        task (Task): The task that produces this output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.Output.register_task" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">register_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Registers the task that produces this output. In most cases, you won't need to override this.</p>
<p>Args:
task (Task): The task that produces this output.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">register_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Registers the task that produces this output. In most cases, you won&#39;t need to override this.</span>

<span class="sd">    Args:</span>
<span class="sd">    task (Task): The task that produces this output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.PrepareCompareGenomeRunOutputs" class="doc doc-heading">
            <code>PrepareCompareGenomeRunOutputs</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Task (zipstrain.task_manager.Task)" href="#zipstrain.task_manager.Task">Task</a></code></p>


        <p>A Task that prepares the final output by merging all parquet files after all genome comparisons are done.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PrepareCompareGenomeRunOutputs</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Task that prepares the final output by merging all parquet files after all genome comparisons are done.&quot;&quot;&quot;</span>
    <span class="n">TEMPLATE_CMD</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    mkdir -p &lt;output-dir&gt;/comps</span>
<span class="s2">    find &quot;$(pwd)&quot; -type f -name &quot;Merged_batch_*.parquet&quot; -print0 | xargs -0 -I </span><span class="si">{}</span><span class="s2"> ln -s </span><span class="si">{}</span><span class="s2"> &lt;output-dir&gt;/comps/</span>
<span class="s2">    zipstrain utilities merge_parquet --input-dir &lt;output-dir&gt;/comps --output-file &lt;output-dir&gt;/all_comparisons.parquet</span>
<span class="s2">    rm -rf &lt;output-dir&gt;/comps</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pre_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the task status to RUNNING and changes directory to the runner&#39;s run directory since this task may need to access multiple batch outputs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;echo </span><span class="si">{</span><span class="n">Status</span><span class="o">.</span><span class="n">RUNNING</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dir</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">/.status &amp;&amp; cd </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_obj</span><span class="o">.</span><span class="n">_runner_obj</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h5 id="zipstrain.task_manager.PrepareCompareGenomeRunOutputs.pre_run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pre_run</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Sets the task status to RUNNING and changes directory to the runner's run directory since this task may need to access multiple batch outputs.</p>

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.ProfileBamTask" class="doc doc-heading">
            <code>ProfileBamTask</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Task (zipstrain.task_manager.Task)" href="#zipstrain.task_manager.Task">Task</a></code></p>


        <p>A Task that generates a mpileup file and genome breadth file in parquet format for a given BAM file using the fast_profile profile_bam command.
The inputs to this task includes:</p>
<pre><code>- bam-file: The input BAM file to be profiled.

- bed-file: The BED file specifying the regions to profile.

- sample-name: The name of the sample being processed.

- gene-range-table: A BED file specifying the gene ranges for the sample.

- num-threads: The number of threads to use for processing.

- genome-length-file: A file containing the lengths of the genomes in the reference fasta.

- stb-file: The STB file used for profiling.
</code></pre>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the task.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>inputs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="Input (zipstrain.task_manager.Input)" href="#zipstrain.task_manager.Input">Input</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of input parameters for the task.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>expected_outputs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="Output (zipstrain.task_manager.Output)" href="#zipstrain.task_manager.Output">Output</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary of expected outputs for the task.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>engine</code>
            </td>
            <td>
                  <code><span title="zipstrain.task_manager.Engine">Engine</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Container engine to wrap the command.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProfileBamTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Task that generates a mpileup file and genome breadth file in parquet format for a given BAM file using the fast_profile profile_bam command.</span>
<span class="sd">    The inputs to this task includes:</span>

<span class="sd">        - bam-file: The input BAM file to be profiled.</span>

<span class="sd">        - bed-file: The BED file specifying the regions to profile.</span>

<span class="sd">        - sample-name: The name of the sample being processed.</span>

<span class="sd">        - gene-range-table: A BED file specifying the gene ranges for the sample.</span>

<span class="sd">        - num-threads: The number of threads to use for processing.</span>

<span class="sd">        - genome-length-file: A file containing the lengths of the genomes in the reference fasta.</span>

<span class="sd">        - stb-file: The STB file used for profiling.</span>

<span class="sd">    Args:</span>
<span class="sd">        id (str): Unique identifier for the task.</span>
<span class="sd">        inputs (dict[str, Input]): Dictionary of input parameters for the task.</span>
<span class="sd">        expected_outputs (dict[str, Output]): Dictionary of expected outputs for the task.</span>
<span class="sd">        engine (Engine): Container engine to wrap the command.&quot;&quot;&quot;</span>

    <span class="n">TEMPLATE_CMD</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ln -s &lt;bam-file&gt; input.bam</span>
<span class="s2">    ln -s &lt;bed-file&gt; bed_file.bed</span>
<span class="s2">    ln -s &lt;gene-range-table&gt; gene-range-table.bed</span>
<span class="s2">    samtools index &lt;bam-file&gt;</span>
<span class="s2">    zipstrain profile profile-single --bam-file input.bam </span><span class="se">\</span>
<span class="s2">    --bed-file bed_file.bed </span><span class="se">\</span>
<span class="s2">    --gene-range-table gene-range-table.bed </span><span class="se">\</span>
<span class="s2">    --num-workers &lt;num-workers&gt; </span><span class="se">\</span>
<span class="s2">    --output-dir .</span>
<span class="s2">    mv input.bam.parquet &lt;sample-name&gt;.parquet</span>
<span class="s2">    samtools idxstats &lt;bam-file&gt; |  awk &#39;$3 &gt; 0 {print $1}&#39; &gt; &lt;sample-name&gt;.parquet.scaffolds</span>
<span class="s2">    zipstrain utilities genome_breadth_matrix --profile &lt;sample-name&gt;.parquet </span><span class="se">\</span>
<span class="s2">        --genome-length &lt;genome-length-file&gt; </span><span class="se">\</span>
<span class="s2">        --stb &lt;stb-file&gt; </span><span class="se">\</span>
<span class="s2">        --min-cov &lt;breadth-min-cov&gt; </span><span class="se">\</span>
<span class="s2">        --output-file &lt;sample-name&gt;_breadth.parquet</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.ProfileRunner" class="doc doc-heading">
            <code>ProfileRunner</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Runner (zipstrain.task_manager.Runner)" href="#zipstrain.task_manager.Runner">Runner</a></code></p>


        <p>Creates and schedules batches of ProfileBamTask tasks using either local or Slurm batches.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>run_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory where the runner will operate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>task_generator</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskGenerator (zipstrain.task_manager.TaskGenerator)" href="#zipstrain.task_manager.TaskGenerator">TaskGenerator</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of TaskGenerator to produce tasks.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container_engine</code>
            </td>
            <td>
                  <code><span title="zipstrain.task_manager.Engine">Engine</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of Engine to wrap task commands.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_concurrent_batches</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of batches to run concurrently. Default is 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>poll_interval</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time interval in seconds to poll for batch status updates. Default is 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tasks_per_batch</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of tasks to include in each batch. Default is 10.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of batch to use ("local" or "slurm"). Default is "local".</p>
              </div>
            </td>
            <td>
                  <code>&#39;local&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>slurm_config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="SlurmConfig (zipstrain.task_manager.SlurmConfig)" href="#zipstrain.task_manager.SlurmConfig">SlurmConfig</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for Slurm batches if batch_type
is "slurm". Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProfileRunner</span><span class="p">(</span><span class="n">Runner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates and schedules batches of ProfileBamTask tasks using either local or Slurm batches.</span>

<span class="sd">    Args:</span>
<span class="sd">        run_dir (str | pathlib.Path): Directory where the runner will operate.</span>
<span class="sd">        task_generator (TaskGenerator): An instance of TaskGenerator to produce tasks.</span>
<span class="sd">        container_engine (Engine): An instance of Engine to wrap task commands.</span>
<span class="sd">        max_concurrent_batches (int): Maximum number of batches to run concurrently. Default is 1.</span>
<span class="sd">        poll_interval (float): Time interval in seconds to poll for batch status updates. Default is 1.0.</span>
<span class="sd">        tasks_per_batch (int): Number of tasks to include in each batch. Default is 10.</span>
<span class="sd">        batch_type (str): Type of batch to use (&quot;local&quot; or &quot;slurm&quot;). Default is &quot;local&quot;.</span>
<span class="sd">        slurm_config (SlurmConfig | None): Configuration for Slurm batches if batch_type</span>
<span class="sd">            is &quot;slurm&quot;. Default is None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
        <span class="n">task_generator</span><span class="p">:</span> <span class="n">TaskGenerator</span><span class="p">,</span>
        <span class="n">container_engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
        <span class="n">max_concurrent_batches</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">tasks_per_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">batch_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span><span class="p">,</span>
        <span class="n">slurm_config</span><span class="p">:</span> <span class="n">SlurmConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">batch_type</span> <span class="o">==</span> <span class="s2">&quot;slurm&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">slurm_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Slurm config must be provided for slurm batch type.&quot;</span><span class="p">)</span>
            <span class="n">batch_factory</span> <span class="o">=</span> <span class="n">SlurmBatch</span>
            <span class="n">final_batch_factory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_factory</span> <span class="o">=</span> <span class="n">LocalBatch</span>
            <span class="n">final_batch_factory</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">run_dir</span><span class="o">=</span><span class="n">run_dir</span><span class="p">,</span>
            <span class="n">task_generator</span><span class="o">=</span><span class="n">task_generator</span><span class="p">,</span>
            <span class="n">container_engine</span><span class="o">=</span><span class="n">container_engine</span><span class="p">,</span>
            <span class="n">batch_factory</span><span class="o">=</span><span class="n">batch_factory</span><span class="p">,</span>
            <span class="n">final_batch_factory</span><span class="o">=</span><span class="n">final_batch_factory</span><span class="p">,</span>
            <span class="n">max_concurrent_batches</span><span class="o">=</span><span class="n">max_concurrent_batches</span><span class="p">,</span>
            <span class="n">poll_interval</span><span class="o">=</span><span class="n">poll_interval</span><span class="p">,</span>
            <span class="n">tasks_per_batch</span><span class="o">=</span><span class="n">tasks_per_batch</span><span class="p">,</span>
            <span class="n">batch_type</span><span class="o">=</span><span class="n">batch_type</span><span class="p">,</span>
            <span class="n">slurm_config</span><span class="o">=</span><span class="n">slurm_config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_batcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines the batcher coroutine that collects tasks from the tasks_queue, groups them into batches,</span>
<span class="sd">        and puts the batches into the batches_queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buffer</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">buffer</span><span class="p">:</span>
                    <span class="n">batch_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;batch_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_counter</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_batch_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_type</span> <span class="o">==</span> <span class="s2">&quot;slurm&quot;</span><span class="p">:</span>
                        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_factory</span><span class="p">(</span>
                            <span class="n">tasks</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span>
                            <span class="nb">id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">,</span>
                            <span class="n">run_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span>
                            <span class="n">expected_outputs</span><span class="o">=</span><span class="p">[],</span>
                            <span class="n">slurm_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_config</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_factory</span><span class="p">(</span>
                            <span class="n">tasks</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span>
                            <span class="nb">id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">,</span>
                            <span class="n">run_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span>
                            <span class="n">expected_outputs</span><span class="o">=</span><span class="p">[],</span>
                        <span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_batcher_done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_per_batch</span><span class="p">:</span>
                <span class="n">batch_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;batch_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_counter</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_batch_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_type</span> <span class="o">==</span> <span class="s2">&quot;slurm&quot;</span><span class="p">:</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_factory</span><span class="p">(</span>
                        <span class="n">tasks</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">,</span>
                        <span class="n">run_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span>
                        <span class="n">expected_outputs</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">slurm_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm_config</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_factory</span><span class="p">(</span>
                        <span class="n">tasks</span><span class="o">=</span><span class="n">buffer</span><span class="p">,</span>
                        <span class="nb">id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">,</span>
                        <span class="n">run_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span>
                        <span class="n">expected_outputs</span><span class="o">=</span><span class="p">[],</span>
                    <span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.ProfileTaskGenerator" class="doc doc-heading">
            <code>ProfileTaskGenerator</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="TaskGenerator (zipstrain.task_manager.TaskGenerator)" href="#zipstrain.task_manager.TaskGenerator">TaskGenerator</a></code></p>


        <p>This TaskGenerator generates FastProfileTask objects from a polars DataFrame. Each task profiles a BAM file.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ProfileTaskGenerator</span><span class="p">(</span><span class="n">TaskGenerator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This TaskGenerator generates FastProfileTask objects from a polars DataFrame. Each task profiles a BAM file.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">,</span>
        <span class="n">yield_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">container_engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
        <span class="n">stb_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">profile_bed_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">gene_range_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">genome_length_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">num_procs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">breadth_min_cov</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">yield_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stb_file</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">stb_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile_bed_file</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">profile_bed_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gene_range_file</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">gene_range_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genome_length_file</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">genome_length_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_procs</span> <span class="o">=</span> <span class="n">num_procs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">breadth_min_cov</span> <span class="o">=</span> <span class="n">breadth_min_cov</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">container_engine</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;data must be a polars LazyFrame.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">path_attr</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stb_file</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profile_bed_file</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gene_range_file</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genome_length_file</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path_attr</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">path_attr</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns total number of profiles to be generated.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yeilds lists of FastProfileTask objects based on the data in batches of yield_size. This method yields the control back to the event loop</span>
<span class="sd">        while polars is collecting data to avoid blocking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_size</span><span class="p">):</span>
            <span class="n">batch_df</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_size</span><span class="p">)</span><span class="o">.</span><span class="n">collect_async</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">batch_df</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;bam-file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;bamfile&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;sample-name&quot;</span><span class="p">:</span> <span class="n">StringInput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;stb-file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stb_file</span><span class="p">),</span>
                <span class="s2">&quot;bed-file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_bed_file</span><span class="p">),</span>
                <span class="s2">&quot;gene-range-table&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_range_file</span><span class="p">),</span>
                <span class="s2">&quot;genome-length-file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_length_file</span><span class="p">),</span>
                <span class="s2">&quot;num-threads&quot;</span><span class="p">:</span> <span class="n">IntInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_procs</span><span class="p">),</span>
                <span class="s2">&quot;breadth-min-cov&quot;</span><span class="p">:</span> <span class="n">IntInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">breadth_min_cov</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="n">expected_outputs</span> <span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;profile&quot;</span><span class="p">:</span>  <span class="n">FileOutput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.parquet&quot;</span> <span class="p">),</span>
                <span class="s2">&quot;breadth&quot;</span><span class="p">:</span>  <span class="n">FileOutput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_breadth.parquet&quot;</span> <span class="p">),</span>
                <span class="s2">&quot;scaffold&quot;</span><span class="p">:</span> <span class="n">FileOutput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.parquet.scaffolds&quot;</span> <span class="p">),</span>
                <span class="p">}</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">ProfileBamTask</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">expected_outputs</span><span class="o">=</span><span class="n">expected_outputs</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">tasks</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.ProfileTaskGenerator.generate_tasks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_tasks</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Yeilds lists of FastProfileTask objects based on the data in batches of yield_size. This method yields the control back to the event loop
while polars is collecting data to avoid blocking.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Yeilds lists of FastProfileTask objects based on the data in batches of yield_size. This method yields the control back to the event loop</span>
<span class="sd">    while polars is collecting data to avoid blocking.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_size</span><span class="p">):</span>
        <span class="n">batch_df</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yield_size</span><span class="p">)</span><span class="o">.</span><span class="n">collect_async</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">batch_df</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bam-file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;bamfile&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;sample-name&quot;</span><span class="p">:</span> <span class="n">StringInput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;stb-file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stb_file</span><span class="p">),</span>
            <span class="s2">&quot;bed-file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_bed_file</span><span class="p">),</span>
            <span class="s2">&quot;gene-range-table&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_range_file</span><span class="p">),</span>
            <span class="s2">&quot;genome-length-file&quot;</span><span class="p">:</span> <span class="n">FileInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genome_length_file</span><span class="p">),</span>
            <span class="s2">&quot;num-threads&quot;</span><span class="p">:</span> <span class="n">IntInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_procs</span><span class="p">),</span>
            <span class="s2">&quot;breadth-min-cov&quot;</span><span class="p">:</span> <span class="n">IntInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">breadth_min_cov</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="n">expected_outputs</span> <span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;profile&quot;</span><span class="p">:</span>  <span class="n">FileOutput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.parquet&quot;</span> <span class="p">),</span>
            <span class="s2">&quot;breadth&quot;</span><span class="p">:</span>  <span class="n">FileOutput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_breadth.parquet&quot;</span> <span class="p">),</span>
            <span class="s2">&quot;scaffold&quot;</span><span class="p">:</span> <span class="n">FileOutput</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.parquet.scaffolds&quot;</span> <span class="p">),</span>
            <span class="p">}</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">ProfileBamTask</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;sample_name&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">expected_outputs</span><span class="o">=</span><span class="n">expected_outputs</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">tasks</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.ProfileTaskGenerator.get_total_tasks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_total_tasks</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Returns total number of profiles to be generated.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_total_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns total number of profiles to be generated.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">)[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.Runner" class="doc doc-heading">
            <code>Runner</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Base Runner class to manage task generation, batching, and execution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>run_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory where the runner will operate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>task_generator</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskGenerator (zipstrain.task_manager.TaskGenerator)" href="#zipstrain.task_manager.TaskGenerator">TaskGenerator</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of TaskGenerator to produce tasks.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container_engine</code>
            </td>
            <td>
                  <code><span title="zipstrain.task_manager.Engine">Engine</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of Engine to wrap task commands.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_factory</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Batch (zipstrain.task_manager.Batch)" href="#zipstrain.task_manager.Batch">Batch</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The class that creates Batch instances. It should be a subclass of Batch or its subclasses.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>final_batch_factory</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Batch (zipstrain.task_manager.Batch)" href="#zipstrain.task_manager.Batch">Batch</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A callable that creates the final Batch instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_concurrent_batches</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of batches to run concurrently. Default is 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>poll_interval</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time interval in seconds to poll for batch status updates. Default is 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tasks_per_batch</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of tasks to include in each batch. Default is</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of batch to use ("local" or "slurm"). Default is "local".</p>
              </div>
            </td>
            <td>
                  <code>&#39;local&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>slurm_config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="SlurmConfig (zipstrain.task_manager.SlurmConfig)" href="#zipstrain.task_manager.SlurmConfig">SlurmConfig</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for Slurm batches if batch_type
is "slurm". Default is None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Runner</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base Runner class to manage task generation, batching, and execution.</span>

<span class="sd">    Args:</span>
<span class="sd">        run_dir (str | pathlib.Path): Directory where the runner will operate.</span>
<span class="sd">        task_generator (TaskGenerator): An instance of TaskGenerator to produce tasks.</span>
<span class="sd">        container_engine (Engine): An instance of Engine to wrap task commands.</span>
<span class="sd">        batch_factory (Batch): The class that creates Batch instances. It should be a subclass of Batch or its subclasses.</span>
<span class="sd">        final_batch_factory (Batch): A callable that creates the final Batch instance.</span>
<span class="sd">        max_concurrent_batches (int): Maximum number of batches to run concurrently. Default is 1.</span>
<span class="sd">        poll_interval (float): Time interval in seconds to poll for batch status updates. Default is 1.0.</span>
<span class="sd">        tasks_per_batch (int): Number of tasks to include in each batch. Default is</span>
<span class="sd">        batch_type (str): Type of batch to use (&quot;local&quot; or &quot;slurm&quot;). Default is &quot;local&quot;.</span>
<span class="sd">        slurm_config (SlurmConfig | None): Configuration for Slurm batches if batch_type</span>
<span class="sd">            is &quot;slurm&quot;. Default is None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TERMINAL_BATCH_STATES</span> <span class="o">=</span> <span class="p">{</span><span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
                    <span class="n">task_generator</span><span class="p">:</span> <span class="n">TaskGenerator</span><span class="p">,</span>
                    <span class="n">container_engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
                    <span class="n">batch_factory</span><span class="p">:</span> <span class="n">Batch</span><span class="p">,</span>
                    <span class="n">final_batch_factory</span><span class="p">:</span> <span class="n">Batch</span><span class="p">,</span>
                    <span class="n">max_concurrent_batches</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">tasks_per_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                    <span class="n">batch_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span><span class="p">,</span>
                    <span class="n">slurm_config</span><span class="p">:</span> <span class="n">SlurmConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_generator</span> <span class="o">=</span> <span class="n">task_generator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container_engine</span> <span class="o">=</span> <span class="n">container_engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_concurrent_batches</span> <span class="o">=</span> <span class="n">max_concurrent_batches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poll_interval</span> <span class="o">=</span> <span class="n">poll_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_per_batch</span> <span class="o">=</span> <span class="n">tasks_per_batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_type</span> <span class="o">=</span> <span class="n">batch_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_config</span> <span class="o">=</span> <span class="n">slurm_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">max_concurrent_batches</span> <span class="o">*</span> <span class="n">tasks_per_batch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">max_concurrent_batches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finished_batches_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_success_batches_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_produced_tasks_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Batch</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batcher_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_final_batch_created</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_factory</span> <span class="o">=</span> <span class="n">batch_factory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_batch_factory</span> <span class="o">=</span> <span class="n">final_batch_factory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_failed_batches_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_expected_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_generator</span><span class="o">.</span><span class="n">get_total_tasks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_expected_batches</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_expected_tasks</span> <span class="o">+</span> <span class="n">tasks_per_batch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">tasks_per_batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_initiated</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_refill_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Repeatedly call task_generator until it returns an empty list. This feeds tasks into the tasks_queue and waits for the queue to have space if it&#39;s full in an async manner.&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">tasks</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_generator</span><span class="o">.</span><span class="n">generate_tasks</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_produced_tasks_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_batcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_final_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Batch</span><span class="o">|</span><span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates the final batch using the final_batch_factory callable.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancel all active batches and signal shutdown.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_initiated</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_initiated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[yellow]Shutdown requested. Cancelling active jobs...[/]&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">batch</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>  
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Error cancelling batch </span><span class="si">{</span><span class="n">batch</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/]&quot;</span><span class="p">)</span>

        <span class="c1"># Signal the main loop to stop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the producer, batcher and worker coroutines and present a live UI while working.</span>
<span class="sd">        Runs the task generator to produce tasks, batches them using the batcher,</span>
<span class="sd">        and executes batches with up to [max_concurrent_batches] parallel workers.</span>
<span class="sd">        UI: displays an overall panel (produced/finished counts), active batch Progress bars,</span>
<span class="sd">        and system stats (CPU/RAM) using Rich Live to mirror the Runner presentation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_batcher</span><span class="p">())</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_refill_tasks</span><span class="p">())</span>
        <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_concurrent_batches</span><span class="p">)</span>
        <span class="n">file_semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">Batch</span><span class="p">):</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">batch</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="n">batch</span><span class="o">.</span><span class="n">retry_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">batch</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">batch</span><span class="o">.</span><span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_finished_batches_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_success_batches_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">elif</span> <span class="n">batch</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_failed_batches_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

        <span class="c1"># Rich progress objects</span>

        <span class="n">overall_progress</span> <span class="o">=</span> <span class="n">Progress</span><span class="p">(</span>
            <span class="n">TextColumn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold white]</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">[/]&quot;</span><span class="p">),</span>
            <span class="n">BarColumn</span><span class="p">(),</span>
            <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{task.fields[produced_tasks]}</span><span class="s2">/</span><span class="si">{task.fields[total_expected_tasks]}</span><span class="s2"> tasks produced&quot;</span><span class="p">),</span>
            <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{task.fields[finished_batches]}</span><span class="s2">/</span><span class="si">{task.fields[total_expected_batches]}</span><span class="s2"> batches finished  </span><span class="si">{task.fields[failed_batches]}</span><span class="s2"> batches failed&quot;</span><span class="p">),</span>
            <span class="n">TimeElapsedColumn</span><span class="p">(),</span>
            <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">overall_task</span> <span class="o">=</span> <span class="n">overall_progress</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;overall&quot;</span><span class="p">,</span> <span class="n">produced_tasks</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_expected_tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_expected_tasks</span><span class="p">,</span> <span class="n">finished_batches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_expected_batches</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_expected_batches</span><span class="p">,</span> <span class="n">failed_batches</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">batch_progress</span> <span class="o">=</span> <span class="n">Progress</span><span class="p">(</span>
            <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[bold white]</span><span class="si">{task.fields[batch_id]}</span><span class="s2">[/]&quot;</span><span class="p">),</span>
            <span class="n">BarColumn</span><span class="p">(),</span>
            <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{task.completed}</span><span class="s2">/</span><span class="si">{task.total}</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{task.fields[status]}</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="n">TimeElapsedColumn</span><span class="p">(),</span>
            <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">batch_to_progress_id</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Batch</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">batch_task_totals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Batch</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">body</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span><span class="n">Group</span><span class="p">(</span>
            <span class="n">Align</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold magenta]ZipStrain </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">[/]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;middle&quot;</span><span class="p">),</span>
            <span class="n">Panel</span><span class="p">(</span><span class="n">overall_progress</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Overall Progress&quot;</span><span class="p">),</span>
            <span class="n">Panel</span><span class="p">(</span><span class="n">batch_progress</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Active Batches&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
            <span class="n">Panel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_system_stats_panel</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;System Stats&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">),</span> <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">)</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">):</span>
            <span class="n">loop</span><span class="o">.</span><span class="n">add_signal_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">s</span><span class="o">=</span><span class="n">sig</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shutdown</span><span class="p">()))</span>

        <span class="k">with</span> <span class="n">Live</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">console</span><span class="o">=</span><span class="n">console</span><span class="p">,</span> <span class="n">refresh_per_second</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">live</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_statuses</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batcher_done</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_final_batch_created</span><span class="p">:</span>
                        <span class="n">final_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_final_batch</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">final_batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">final_batch</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_final_batch_created</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_final_batch_created</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_concurrent_batches</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span> 
                    <span class="n">batch</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">batch</span><span class="o">.</span><span class="n">_set_file_semaphore</span><span class="p">(</span><span class="n">file_semaphore</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">run_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>
                <span class="c1"># Update overall progress fields</span>
                <span class="n">overall_progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overall_task</span><span class="p">,</span> <span class="n">produced_tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_produced_tasks_count</span><span class="p">,</span> <span class="n">finished_batches</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_finished_batches_count</span><span class="p">,</span> <span class="n">failed_batches</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed_batches_count</span><span class="p">)</span>  
                <span class="c1"># Add newly queued batches into UI</span>


                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">batch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch_to_progress_id</span> <span class="ow">and</span> <span class="n">batch</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TERMINAL_BATCH_STATES</span><span class="p">:</span>
                        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span> <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">tasks</span> <span class="k">else</span> <span class="mi">1</span>
                        <span class="n">task_id</span> <span class="o">=</span> <span class="n">batch_progress</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span> <span class="n">batch_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Batch </span><span class="si">{</span><span class="n">batch</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                        <span class="n">batch_to_progress_id</span><span class="p">[</span><span class="n">batch</span><span class="p">]</span> <span class="o">=</span> <span class="n">task_id</span>
                        <span class="n">batch_task_totals</span><span class="p">[</span><span class="n">batch</span><span class="p">]</span> <span class="o">=</span> <span class="n">total</span>
                <span class="c1"># Remove finished batches from UI</span>
                <span class="k">for</span> <span class="n">batch</span><span class="p">,</span> <span class="n">tid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">batch_to_progress_id</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TERMINAL_BATCH_STATES</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">batch_progress</span><span class="o">.</span><span class="n">remove_task</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">del</span> <span class="n">batch_to_progress_id</span><span class="p">[</span><span class="n">batch</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batch_task_totals</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">batch_task_totals</span><span class="p">[</span><span class="n">batch</span><span class="p">]</span>
                <span class="c1"># Update per-batch progress</span>
                <span class="k">for</span> <span class="n">batch</span><span class="p">,</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">batch_to_progress_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">completed</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">tasks</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TERMINAL_BATCH_STATES</span><span class="p">)</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="n">batch_task_totals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tasks</span><span class="p">)))</span>
                    <span class="n">batch_progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">completed</span><span class="o">=</span><span class="n">completed</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                <span class="c1"># Update system panel</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span><span class="n">Group</span><span class="p">(</span>
                    <span class="n">Align</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold magenta]ZipStrain </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">[/]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;middle&quot;</span><span class="p">),</span>
                    <span class="n">Panel</span><span class="p">(</span><span class="n">overall_progress</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Overall Progress&quot;</span><span class="p">),</span>
                    <span class="n">Panel</span><span class="p">(</span><span class="n">batch_progress</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Active Batches&quot;</span><span class="p">),</span>
                    <span class="n">Panel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_system_stats_panel</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;System Stats&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="p">),</span> <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">)</span>
                <span class="n">live</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poll_interval</span><span class="p">)</span>

        <span class="c1"># final UI summary</span>
        <span class="n">console</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">total_batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_counter</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_final_batch_created</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_batch_factory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold green]Run finished![/]</span><span class="se">\n\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_success_batches_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_batches</span><span class="si">}</span><span class="s2"> batches succeeded.</span><span class="se">\n\n</span><span class="s2">Produced tasks: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_produced_tasks_count</span><span class="si">}</span><span class="se">\n</span><span class="s2">Elapsed: (see time in UI)&quot;</span><span class="p">,</span>
            <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Summary&quot;</span><span class="p">,</span>
            <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_update_statuses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">batch</span><span class="o">.</span><span class="n">update_status</span><span class="p">()</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span> <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TERMINAL_BATCH_STATES</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_system_stats_panel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;helpers to create a system stats panel for the live UI.&quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">usage_bar</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">percent</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Progress</span><span class="p">(</span>
                <span class="n">TextColumn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold]</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">[/]&quot;</span><span class="p">),</span>
                <span class="n">BarColumn</span><span class="p">(</span><span class="n">bar_width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">complete_style</span><span class="o">=</span><span class="n">color</span><span class="p">),</span>
                <span class="n">TextColumn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">percent</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">),</span>
                <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">completed</span><span class="o">=</span><span class="n">percent</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Panel</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

        <span class="n">cpu</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">ram</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">percent</span>
        <span class="n">cpu_panel</span> <span class="o">=</span> <span class="n">usage_bar</span><span class="p">(</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="s2">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">ram_panel</span> <span class="o">=</span> <span class="n">usage_bar</span><span class="p">(</span><span class="s2">&quot;RAM&quot;</span><span class="p">,</span> <span class="n">ram</span><span class="p">,</span> <span class="s2">&quot;magenta&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Columns</span><span class="p">([</span><span class="n">cpu_panel</span><span class="p">,</span> <span class="n">ram_panel</span><span class="p">],</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.Runner.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Run the producer, batcher and worker coroutines and present a live UI while working.
Runs the task generator to produce tasks, batches them using the batcher,
and executes batches with up to [max_concurrent_batches] parallel workers.
UI: displays an overall panel (produced/finished counts), active batch Progress bars,
and system stats (CPU/RAM) using Rich Live to mirror the Runner presentation.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the producer, batcher and worker coroutines and present a live UI while working.</span>
<span class="sd">    Runs the task generator to produce tasks, batches them using the batcher,</span>
<span class="sd">    and executes batches with up to [max_concurrent_batches] parallel workers.</span>
<span class="sd">    UI: displays an overall panel (produced/finished counts), active batch Progress bars,</span>
<span class="sd">    and system stats (CPU/RAM) using Rich Live to mirror the Runner presentation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_batcher</span><span class="p">())</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_refill_tasks</span><span class="p">())</span>
    <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_concurrent_batches</span><span class="p">)</span>
    <span class="n">file_semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="n">Batch</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">batch</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="n">batch</span><span class="o">.</span><span class="n">retry_count</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">batch</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_finished_batches_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_success_batches_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="n">batch</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_failed_batches_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="c1"># Rich progress objects</span>

    <span class="n">overall_progress</span> <span class="o">=</span> <span class="n">Progress</span><span class="p">(</span>
        <span class="n">TextColumn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold white]</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">[/]&quot;</span><span class="p">),</span>
        <span class="n">BarColumn</span><span class="p">(),</span>
        <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{task.fields[produced_tasks]}</span><span class="s2">/</span><span class="si">{task.fields[total_expected_tasks]}</span><span class="s2"> tasks produced&quot;</span><span class="p">),</span>
        <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{task.fields[finished_batches]}</span><span class="s2">/</span><span class="si">{task.fields[total_expected_batches]}</span><span class="s2"> batches finished  </span><span class="si">{task.fields[failed_batches]}</span><span class="s2"> batches failed&quot;</span><span class="p">),</span>
        <span class="n">TimeElapsedColumn</span><span class="p">(),</span>
        <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">overall_task</span> <span class="o">=</span> <span class="n">overall_progress</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;overall&quot;</span><span class="p">,</span> <span class="n">produced_tasks</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_expected_tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_expected_tasks</span><span class="p">,</span> <span class="n">finished_batches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_expected_batches</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_expected_batches</span><span class="p">,</span> <span class="n">failed_batches</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">batch_progress</span> <span class="o">=</span> <span class="n">Progress</span><span class="p">(</span>
        <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;[bold white]</span><span class="si">{task.fields[batch_id]}</span><span class="s2">[/]&quot;</span><span class="p">),</span>
        <span class="n">BarColumn</span><span class="p">(),</span>
        <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{task.completed}</span><span class="s2">/</span><span class="si">{task.total}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="n">TextColumn</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{task.fields[status]}</span><span class="s2">&quot;</span><span class="p">),</span>
        <span class="n">TimeElapsedColumn</span><span class="p">(),</span>
        <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">batch_to_progress_id</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Batch</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">batch_task_totals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Batch</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">body</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span><span class="n">Group</span><span class="p">(</span>
        <span class="n">Align</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold magenta]ZipStrain </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">[/]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;middle&quot;</span><span class="p">),</span>
        <span class="n">Panel</span><span class="p">(</span><span class="n">overall_progress</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Overall Progress&quot;</span><span class="p">),</span>
        <span class="n">Panel</span><span class="p">(</span><span class="n">batch_progress</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Active Batches&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
        <span class="n">Panel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_system_stats_panel</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;System Stats&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">),</span> <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">)</span>

    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">):</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">add_signal_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">s</span><span class="o">=</span><span class="n">sig</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shutdown</span><span class="p">()))</span>

    <span class="k">with</span> <span class="n">Live</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">console</span><span class="o">=</span><span class="n">console</span><span class="p">,</span> <span class="n">refresh_per_second</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="n">live</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_statuses</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batcher_done</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_final_batch_created</span><span class="p">:</span>
                    <span class="n">final_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_final_batch</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">final_batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">final_batch</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_final_batch_created</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_final_batch_created</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_concurrent_batches</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span> 
                <span class="n">batch</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">batch</span><span class="o">.</span><span class="n">_set_file_semaphore</span><span class="p">(</span><span class="n">file_semaphore</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">run_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">))</span>
            <span class="c1"># Update overall progress fields</span>
            <span class="n">overall_progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">overall_task</span><span class="p">,</span> <span class="n">produced_tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_produced_tasks_count</span><span class="p">,</span> <span class="n">finished_batches</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_finished_batches_count</span><span class="p">,</span> <span class="n">failed_batches</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed_batches_count</span><span class="p">)</span>  
            <span class="c1"># Add newly queued batches into UI</span>


            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">batch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch_to_progress_id</span> <span class="ow">and</span> <span class="n">batch</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TERMINAL_BATCH_STATES</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span> <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">tasks</span> <span class="k">else</span> <span class="mi">1</span>
                    <span class="n">task_id</span> <span class="o">=</span> <span class="n">batch_progress</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span> <span class="n">batch_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Batch </span><span class="si">{</span><span class="n">batch</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                    <span class="n">batch_to_progress_id</span><span class="p">[</span><span class="n">batch</span><span class="p">]</span> <span class="o">=</span> <span class="n">task_id</span>
                    <span class="n">batch_task_totals</span><span class="p">[</span><span class="n">batch</span><span class="p">]</span> <span class="o">=</span> <span class="n">total</span>
            <span class="c1"># Remove finished batches from UI</span>
            <span class="k">for</span> <span class="n">batch</span><span class="p">,</span> <span class="n">tid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">batch_to_progress_id</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TERMINAL_BATCH_STATES</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">batch_progress</span><span class="o">.</span><span class="n">remove_task</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">del</span> <span class="n">batch_to_progress_id</span><span class="p">[</span><span class="n">batch</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batch_task_totals</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">batch_task_totals</span><span class="p">[</span><span class="n">batch</span><span class="p">]</span>
            <span class="c1"># Update per-batch progress</span>
            <span class="k">for</span> <span class="n">batch</span><span class="p">,</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">batch_to_progress_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">completed</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">tasks</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">TERMINAL_BATCH_STATES</span><span class="p">)</span>
                <span class="n">total</span> <span class="o">=</span> <span class="n">batch_task_totals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tasks</span><span class="p">)))</span>
                <span class="n">batch_progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">completed</span><span class="o">=</span><span class="n">completed</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
            <span class="c1"># Update system panel</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span><span class="n">Group</span><span class="p">(</span>
                <span class="n">Align</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold magenta]ZipStrain </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">[/]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vertical</span><span class="o">=</span><span class="s2">&quot;middle&quot;</span><span class="p">),</span>
                <span class="n">Panel</span><span class="p">(</span><span class="n">overall_progress</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Overall Progress&quot;</span><span class="p">),</span>
                <span class="n">Panel</span><span class="p">(</span><span class="n">batch_progress</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Active Batches&quot;</span><span class="p">),</span>
                <span class="n">Panel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_make_system_stats_panel</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;System Stats&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">),</span> <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">)</span>
            <span class="n">live</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poll_interval</span><span class="p">)</span>

    <span class="c1"># final UI summary</span>
    <span class="n">console</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">total_batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_counter</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_final_batch_created</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_batch_factory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">Panel</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[bold green]Run finished![/]</span><span class="se">\n\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_success_batches_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_batches</span><span class="si">}</span><span class="s2"> batches succeeded.</span><span class="se">\n\n</span><span class="s2">Produced tasks: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_produced_tasks_count</span><span class="si">}</span><span class="se">\n</span><span class="s2">Elapsed: (see time in UI)&quot;</span><span class="p">,</span>
        <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Summary&quot;</span><span class="p">,</span>
        <span class="n">border_style</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.SlurmBatch" class="doc doc-heading">
            <code>SlurmBatch</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Batch (zipstrain.task_manager.Batch)" href="#zipstrain.task_manager.Batch">Batch</a></code></p>


        <p>Batch that submits tasks to a Slurm job scheduler.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tasks</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="Task (zipstrain.task_manager.Task)" href="#zipstrain.task_manager.Task">Task</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of Task objects to be included in the batch.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the batch.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>run_dir</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory where the batch will be executed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>expected_outputs</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="Output (zipstrain.task_manager.Output)" href="#zipstrain.task_manager.Output">Output</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of expected outputs for the batch.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>slurm_config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="SlurmConfig (zipstrain.task_manager.SlurmConfig)" href="#zipstrain.task_manager.SlurmConfig">SlurmConfig</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration for Slurm job submission. Refer to SlurmConfig class for details.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SlurmBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Batch that submits tasks to a Slurm job scheduler.</span>

<span class="sd">     Args:</span>
<span class="sd">        tasks (list[Task]): List of Task objects to be included in the batch.</span>
<span class="sd">        id (str): Unique identifier for the batch.</span>
<span class="sd">        run_dir (pathlib.Path): Directory where the batch will be executed.</span>
<span class="sd">        expected_outputs (list[Output]): List of expected outputs for the batch.</span>
<span class="sd">        slurm_config (SlurmConfig): Configuration for Slurm job submission. Refer to SlurmConfig class for details.&quot;&quot;&quot;</span>
    <span class="n">TEMPLATE_CMD</span> <span class="o">=</span> <span class="s2">&quot;#!/bin/bash</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">,</span> <span class="n">expected_outputs</span><span class="p">,</span> <span class="n">slurm_config</span><span class="p">:</span> <span class="n">SlurmConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">,</span> <span class="n">expected_outputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_slurm_works</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slurm_config</span> <span class="o">=</span> <span class="n">slurm_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_script</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEMPLATE_CMD</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm_config</span><span class="o">.</span><span class="n">to_slurm_args</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">set -o pipefail</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_slurm_works</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if Slurm commands are available on the system.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;sbatch&quot;</span><span class="p">,</span> <span class="s2">&quot;--version&quot;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;sacct&quot;</span><span class="p">,</span> <span class="s2">&quot;--version&quot;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;Slurm does not seem to be available or configured properly on this system.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancel a running or submitted Slurm job.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
                <span class="s2">&quot;scancel&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
        <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method submits the batch to Slurm by creating a batch script and using sbatch command. It also monitors the job status until completion.</span>
<span class="sd">        This method is unavoidably different from LocalBatch.run() because of the nature of Slurm job submission.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">RUNNING</span><span class="o">.</span><span class="n">value</span>
            <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
            <span class="c1"># create task directories and initialize .status if needed</span>

            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">task_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">task_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
            <span class="c1"># write the batch script (all tasks included)</span>

            <span class="n">batch_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.batch&quot;</span>
            <span class="n">script</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_script</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">pre_run</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">command</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">post_run</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="n">batch_path</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

            <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
                <span class="s2">&quot;sbatch&quot;</span><span class="p">,</span><span class="s2">&quot;--parsable&quot;</span><span class="p">,</span> <span class="n">batch_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">out_bytes</span><span class="p">,</span> <span class="n">out_err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">out_bytes</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_id</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUBMITTED</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_to_finish</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_ready</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span>
                <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
                <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_ready</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_job_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sbatch_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">match</span> <span class="o">:=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d+)&quot;</span><span class="p">,</span> <span class="n">sbatch_output</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not parse job ID from sbatch output.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_wait_to_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sleep_duration</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_status</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_duration</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="o">=</span><span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_task_status</span><span class="p">()</span>
            <span class="n">out</span><span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
                <span class="s2">&quot;sacct&quot;</span><span class="p">,</span> <span class="s2">&quot;-j&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span><span class="p">,</span> <span class="s2">&quot;--format=State&quot;</span><span class="p">,</span> <span class="s2">&quot;--noheader&quot;</span><span class="p">,</span><span class="s2">&quot;--allocations&quot;</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">out_bytes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">out</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">out_bytes</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">out_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;FAILED&quot;</span><span class="p">,</span> <span class="s2">&quot;CANCELLED&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMEOUT&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
                <span class="k">elif</span> <span class="n">state</span><span class="o">==</span><span class="s2">&quot;RUNNING&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">RUNNING</span><span class="o">.</span><span class="n">value</span>
                <span class="k">elif</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;COMPLETED&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLETING&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">PENDING</span><span class="o">.</span><span class="n">value</span>
                <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.SlurmBatch.cancel" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cancel</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Cancel a running or submitted Slurm job.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cancel a running or submitted Slurm job.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span><span class="p">:</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
            <span class="s2">&quot;scancel&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
    <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.SlurmBatch.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>This method submits the batch to Slurm by creating a batch script and using sbatch command. It also monitors the job status until completion.
This method is unavoidably different from LocalBatch.run() because of the nature of Slurm job submission.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This method submits the batch to Slurm by creating a batch script and using sbatch command. It also monitors the job status until completion.</span>
<span class="sd">    This method is unavoidably different from LocalBatch.run() because of the nature of Slurm job submission.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">RUNNING</span><span class="o">.</span><span class="n">value</span>
        <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
        <span class="c1"># create task directories and initialize .status if needed</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">task_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">task_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
        <span class="c1"># write the batch script (all tasks included)</span>

        <span class="n">batch_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.batch&quot;</span>
        <span class="n">script</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_script</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">pre_run</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">command</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">post_run</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="n">batch_path</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

        <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span>
            <span class="s2">&quot;sbatch&quot;</span><span class="p">,</span><span class="s2">&quot;--parsable&quot;</span><span class="p">,</span> <span class="n">batch_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">out_bytes</span><span class="p">,</span> <span class="n">out_err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">out_bytes</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_id</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUBMITTED</span><span class="o">.</span><span class="n">value</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_to_finish</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_ready</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span>
            <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
            <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs_ready</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.SlurmConfig" class="doc doc-heading">
            <code>SlurmConfig</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>


        <p>Configuration model for Slurm batch jobs.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="zipstrain.task_manager.SlurmConfig.time">time</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time limit for the job in HH:MM:SS format.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zipstrain.task_manager.SlurmConfig.tasks">tasks</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of tasks.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zipstrain.task_manager.SlurmConfig.mem">mem</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Memory in GB.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="zipstrain.task_manager.SlurmConfig.additional_params">additional_params</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional SLURM parameters as key-value pairs.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>NOTE: Additional paramters for slurm should be provided in the additional_params dict in the form
of {"param-name": "param-value"}, e.g., {"cpus-per-task": "4"} will result in the addition of
"#SBATCH --cpus-per-task=4" to the sbatch script.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SlurmConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration model for Slurm batch jobs.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        time (str): Time limit for the job in HH:MM:SS format.</span>
<span class="sd">        tasks (int): Number of tasks.</span>
<span class="sd">        mem (int): Memory in GB.</span>
<span class="sd">        additional_params (dict): Additional SLURM parameters as key-value pairs.</span>

<span class="sd">    NOTE: Additional paramters for slurm should be provided in the additional_params dict in the form</span>
<span class="sd">    of {&quot;param-name&quot;: &quot;param-value&quot;}, e.g., {&quot;cpus-per-task&quot;: &quot;4&quot;} will result in the addition of</span>
<span class="sd">    &quot;#SBATCH --cpus-per-task=4&quot; to the sbatch script.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Time limit for the job.&quot;</span><span class="p">)</span>
    <span class="n">tasks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of tasks.&quot;</span><span class="p">)</span>
    <span class="n">mem</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Memory in GB.&quot;</span><span class="p">)</span>
    <span class="n">additional_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Additional SLURM parameters as key-value pairs.&quot;</span><span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_time</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate time format HH:MM:SS (H..HHH allowed).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\d{1,3}:\d</span><span class="si">{2}</span><span class="s2">:\d</span><span class="si">{2}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Time must be in the format HH:MM:SS (H..HHH allowed)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_slurm_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates the slurm batch file header form the configuration object&quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;#SBATCH --time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;#SBATCH --ntasks=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;#SBATCH --mem=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="si">}</span><span class="s2">G&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SlurmConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load SlurmConfig from a JSON file.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slurm config file </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">model_validate_json</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.SlurmConfig.from_json" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_json</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Load SlurmConfig from a JSON file.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SlurmConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load SlurmConfig from a JSON file.&quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Slurm config file </span><span class="si">{</span><span class="n">json_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">model_validate_json</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.SlurmConfig.to_slurm_args" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_slurm_args</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Generates the slurm batch file header form the configuration object</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_slurm_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates the slurm batch file header form the configuration object&quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;#SBATCH --time=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;#SBATCH --ntasks=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;#SBATCH --mem=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mem</span><span class="si">}</span><span class="s2">G&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#SBATCH --</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.SlurmConfig.validate_time" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_time</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Validate time format HH:MM:SS (H..HHH allowed).</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_time</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate time format HH:MM:SS (H..HHH allowed).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\d{1,3}:\d</span><span class="si">{2}</span><span class="s2">:\d</span><span class="si">{2}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Time must be in the format HH:MM:SS (H..HHH allowed)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.Status" class="doc doc-heading">
            <code>Status</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="enum.StrEnum">StrEnum</span></code></p>


        <p>Enumeration of possible task and batch statuses.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Status</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumeration of possible task and batch statuses.&quot;&quot;&quot;</span>
    <span class="n">BATCH_NOT_ASSIGNED</span> <span class="o">=</span> <span class="s2">&quot;batch_not_assigned&quot;</span>
    <span class="n">NOT_STARTED</span> <span class="o">=</span> <span class="s2">&quot;not_started&quot;</span>
    <span class="n">RUNNING</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
    <span class="n">DONE</span> <span class="o">=</span> <span class="s2">&quot;done&quot;</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
    <span class="n">SUBMITTED</span> <span class="o">=</span> <span class="s2">&quot;submitted&quot;</span>
    <span class="n">SUCCESS</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.StringInput" class="doc doc-heading">
            <code>StringInput</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Input (zipstrain.task_manager.Input)" href="#zipstrain.task_manager.Input">Input</a></code></p>


        <p>This is used when the input is a string.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StringInput</span><span class="p">(</span><span class="n">Input</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is used when the input is a string.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate that the input value is a string.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input value </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">!r}</span><span class="s2"> is not a string.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the string value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.StringInput.get_value" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_value</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Returns the string value.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the string value.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.StringInput.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Validate that the input value is a string.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate that the input value is a string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input value </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">!r}</span><span class="s2"> is not a string.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.StringOutput" class="doc doc-heading">
            <code>StringOutput</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Output (zipstrain.task_manager.Output)" href="#zipstrain.task_manager.Output">Output</a></code></p>


        <p>This is used when the output is a string.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StringOutput</span><span class="p">(</span><span class="n">Output</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is used when the output is a string.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the output value is a string.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output value for task </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> is not a string.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.StringOutput.ready" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ready</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Check if the output value is a string.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the output value is a string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output value for task </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> is not a string.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.Task" class="doc doc-heading">
            <code>Task</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Abstract base class for tasks. DO NOT INSTANTIATE DIRECTLY. Any new task type should subclass this
and implement the TEMPLATE_CMD class attribute. Inputs and expected outputs are specified using &lt;&gt;.
As an example, if a task has an input file called "input-file" and an expected output file called "output-file",
the TEMPLATE_CMD could be something like:
    TEMPLATE_CMD = "some_command --input <input-file> --output <output-file>"
the outputs and inputs will be mapped to the command when map_io() is called later in the runtime.</p>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for tasks. DO NOT INSTANTIATE DIRECTLY. Any new task type should subclass this</span>
<span class="sd">    and implement the TEMPLATE_CMD class attribute. Inputs and expected outputs are specified using &lt;&gt;.</span>
<span class="sd">    As an example, if a task has an input file called &quot;input-file&quot; and an expected output file called &quot;output-file&quot;,</span>
<span class="sd">    the TEMPLATE_CMD could be something like:</span>
<span class="sd">        TEMPLATE_CMD = &quot;some_command --input &lt;input-file&gt; --output &lt;output-file&gt;&quot;</span>
<span class="sd">    the outputs and inputs will be mapped to the command when map_io() is called later in the runtime.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TEMPLATE_CMD</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Input</span> <span class="o">|</span> <span class="n">Output</span><span class="p">],</span>
        <span class="n">expected_outputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Output</span><span class="p">]</span> <span class="p">,</span>
        <span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
        <span class="n">batch_obj</span><span class="p">:</span> <span class="n">Batch</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">file_semaphore</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_outputs</span> <span class="o">=</span> <span class="n">expected_outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_obj</span> <span class="o">=</span> <span class="n">batch_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_initial_status</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span> <span class="o">=</span> <span class="n">file_semaphore</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map_io</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Maps inputs and expected outputs to the command template. Note that when this method is called,</span>
<span class="sd">        all of the inputs and outputs in the TEMPLATE_CMD must be defined in the inputs and expected_outputs dictionaries.</span>
<span class="sd">        However, this method is not called by the user directly. It is called by the Batch when the task is added to a batch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEMPLATE_CMD</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span>
        <span class="c1"># if any placeholders remain, report them</span>

        <span class="k">for</span> <span class="n">handle</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">handle</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">expected_file</span><span class="o">.</span><span class="n">absolute</span><span class="p">()))</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;\w+&gt;&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not all inputs were mapped in task </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">. Remaining placeholders: </span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="n">cmd</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">batch_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the batch directory path. Raises an error if the task is not associated with any batch yet.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> is not associated with any batch yet.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_obj</span><span class="o">.</span><span class="n">batch_dir</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">task_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the task directory path.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">command</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the command to be executed, wrapped with the engine if applicable.&quot;&quot;&quot;</span>
        <span class="n">file_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">FileInput</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_command</span><span class="p">,</span> <span class="n">file_inputs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pre_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Does the necessary setup before running the task command. This should not be overridden by subclasses unless a task needs special setup like</span>
<span class="sd">        batch aggregation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;echo </span><span class="si">{</span><span class="n">Status</span><span class="o">.</span><span class="n">RUNNING</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dir</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">/.status &amp;&amp; cd </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dir</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the current status of the task.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">post_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Does the necessary steps after running the task command. This should not be overridden by subclasses unless a task needs special teardown like</span>
<span class="sd">        batch aggregation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;cd </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dir</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2"> &amp;&amp; echo </span><span class="si">{</span><span class="n">Status</span><span class="o">.</span><span class="n">DONE</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dir</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">/.status&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Asynchronously reads the task status from the .status file in the task directory.&quot;&quot;&quot;</span>
        <span class="n">status_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span>
        <span class="c1"># read the status file if it exists</span>
        <span class="k">if</span> <span class="n">status_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="k">await</span> <span class="n">read_file</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># if task reported &#39;done&#39;, check outputs to decide success/failure</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">DONE</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">all_ready</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
                            <span class="n">all_ready</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">all_ready</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">all_ready</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> reported done but outputs are not ready or invalid. </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_outputs</span><span class="p">[</span><span class="s1">&#39;output-file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expected_file</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_initial_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the initial status of the task based on the presence of the batch and task directories.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Status</span><span class="o">.</span><span class="n">BATCH_NOT_ASSIGNED</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Status</span><span class="o">.</span><span class="n">NOT_STARTED</span><span class="o">.</span><span class="n">value</span>
        <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">status_as_written</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">status_as_written</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Status</span><span class="o">.</span><span class="n">DONE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="n">all_ready</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
                        <span class="n">all_ready</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">all_ready</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">all_ready</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h5 id="zipstrain.task_manager.Task.batch_dir" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">batch_dir</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Returns the batch directory path. Raises an error if the task is not associated with any batch yet.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="zipstrain.task_manager.Task.command" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">command</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Returns the command to be executed, wrapped with the engine if applicable.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="zipstrain.task_manager.Task.post_run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">post_run</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Does the necessary steps after running the task command. This should not be overridden by subclasses unless a task needs special teardown like
batch aggregation.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="zipstrain.task_manager.Task.pre_run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pre_run</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Does the necessary setup before running the task command. This should not be overridden by subclasses unless a task needs special setup like
batch aggregation.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="zipstrain.task_manager.Task.status" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">status</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Returns the current status of the task.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h5 id="zipstrain.task_manager.Task.task_dir" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">task_dir</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Returns the task directory path.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.Task.get_status" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_status</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Asynchronously reads the task status from the .status file in the task directory.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Asynchronously reads the task status from the .status file in the task directory.&quot;&quot;&quot;</span>
    <span class="n">status_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_dir</span> <span class="o">/</span> <span class="s2">&quot;.status&quot;</span>
    <span class="c1"># read the status file if it exists</span>
    <span class="k">if</span> <span class="n">status_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="k">await</span> <span class="n">read_file</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># if task reported &#39;done&#39;, check outputs to decide success/failure</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">Status</span><span class="o">.</span><span class="n">DONE</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">all_ready</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_outputs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
                        <span class="n">all_ready</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">all_ready</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">all_ready</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span>
                <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">SUCCESS</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span>
                <span class="k">await</span> <span class="n">write_file</span><span class="p">(</span><span class="n">status_path</span><span class="p">,</span> <span class="n">Status</span><span class="o">.</span><span class="n">FAILED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_semaphore</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> reported done but outputs are not ready or invalid. </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_outputs</span><span class="p">[</span><span class="s1">&#39;output-file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expected_file</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h5 id="zipstrain.task_manager.Task.map_io" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_io</span><span class="p">()</span></code>

</h5>


    <div class="doc doc-contents ">

        <p>Maps inputs and expected outputs to the command template. Note that when this method is called,
all of the inputs and outputs in the TEMPLATE_CMD must be defined in the inputs and expected_outputs dictionaries.
However, this method is not called by the user directly. It is called by the Batch when the task is added to a batch.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">map_io</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maps inputs and expected outputs to the command template. Note that when this method is called,</span>
<span class="sd">    all of the inputs and outputs in the TEMPLATE_CMD must be defined in the inputs and expected_outputs dictionaries.</span>
<span class="sd">    However, this method is not called by the user directly. It is called by the Batch when the task is added to a batch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TEMPLATE_CMD</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">get_value</span><span class="p">())</span>
    <span class="c1"># if any placeholders remain, report them</span>

    <span class="k">for</span> <span class="n">handle</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">handle</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">expected_file</span><span class="o">.</span><span class="n">absolute</span><span class="p">()))</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;\w+&gt;&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">remaining</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not all inputs were mapped in task </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">. Remaining placeholders: </span><span class="si">{</span><span class="n">remaining</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_command</span> <span class="o">=</span> <span class="n">cmd</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h4 id="zipstrain.task_manager.TaskGenerator" class="doc doc-heading">
            <code>TaskGenerator</code>


</h4>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Abstract base class for task generators. DO NOT INSTANTIATE DIRECTLY. A subclass of this class 
should provide an async generator method called generate_tasks() that yields lists of Task objects in an async manner.
Some important concepts:</p>
<ul>
<li>
<p>generate_tasks() is an async generator that yields lists of Task objects.</p>
</li>
<li>
<p>yield_size determines how many tasks are generated and yielded at a time.</p>
</li>
<li>
<p>get_total_tasks() returns the total number of tasks that can be generated.</p>
</li>
</ul>








              <details class="quote">
                <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TaskGenerator</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for task generators. DO NOT INSTANTIATE DIRECTLY. A subclass of this class </span>
<span class="sd">    should provide an async generator method called generate_tasks() that yields lists of Task objects in an async manner.</span>
<span class="sd">    Some important concepts:</span>

<span class="sd">    - generate_tasks() is an async generator that yields lists of Task objects.</span>

<span class="sd">    - yield_size determines how many tasks are generated and yielded at a time.</span>

<span class="sd">    - get_total_tasks() returns the total number of tasks that can be generated.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">data</span><span class="p">,</span>
                 <span class="n">yield_size</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span>

                 <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yield_size</span> <span class="o">=</span> <span class="n">yield_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_total_tasks</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]:</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h4 id="zipstrain.task_manager.get_cpu_usage" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_cpu_usage</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Returns the current CPU usage percentage.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_cpu_usage</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the current CPU usage percentage.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.task_manager.get_memory_usage" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_memory_usage</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Returns the current memory usage percentage.</p>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_memory_usage</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the current memory usage percentage.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">percent</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="zipstrain.task_manager.lazy_run_compares" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">lazy_run_compares</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">container_engine</span><span class="p">,</span> <span class="n">comps_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tasks_per_batch</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_concurrent_batches</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">poll_interval</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">execution_mode</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">slurm_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">memory_mode</span><span class="o">=</span><span class="s1">&#39;heavy&#39;</span><span class="p">,</span> <span class="n">chrom_batch_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">polars_engine</span><span class="o">=</span><span class="s1">&#39;streaming&#39;</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>A helper function to quickly set up and run a CompareRunner with given parameters.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>run_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory where the runner will operate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container_engine</code>
            </td>
            <td>
                  <code><span title="zipstrain.task_manager.Engine">Engine</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of Engine to wrap task commands.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>comps_db</code>
            </td>
            <td>
                  <code><span title="GenomeComparisonDatabase">GenomeComparisonDatabase</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of GenomeComparisonDatabase containing comparison data.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>tasks_per_batch</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of tasks to include in each batch. Default is 10.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_concurrent_batches</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of batches to run concurrently. Default is 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>poll_interval</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time interval in seconds to poll for batch status updates. Default is 5.0.</p>
              </div>
            </td>
            <td>
                  <code>5.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>execution_mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Execution mode, either "local" or "slurm". Default is "local".</p>
              </div>
            </td>
            <td>
                  <code>&#39;local&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>zipstrain/src/zipstrain/task_manager.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">lazy_run_compares</span><span class="p">(</span>
    <span class="n">run_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
    <span class="n">container_engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
    <span class="n">comps_db</span><span class="p">:</span> <span class="n">database</span><span class="o">.</span><span class="n">GenomeComparisonDatabase</span><span class="o">|</span><span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tasks_per_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">max_concurrent_batches</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="n">execution_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span><span class="p">,</span>
    <span class="n">slurm_config</span><span class="p">:</span> <span class="n">SlurmConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">memory_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;heavy&quot;</span><span class="p">,</span>
    <span class="n">chrom_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="n">polars_engine</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;streaming&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A helper function to quickly set up and run a CompareRunner with given parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        run_dir (str | pathlib.Path): Directory where the runner will operate.</span>
<span class="sd">        container_engine (Engine): An instance of Engine to wrap task commands.</span>
<span class="sd">        comps_db (GenomeComparisonDatabase | None): An instance of GenomeComparisonDatabase containing comparison data.</span>
<span class="sd">        tasks_per_batch (int): Number of tasks to include in each batch. Default is 10.</span>
<span class="sd">        max_concurrent_batches (int): Maximum number of batches to run concurrently. Default is 1.</span>
<span class="sd">        poll_interval (float): Time interval in seconds to poll for batch status updates. Default is 5.0.</span>
<span class="sd">        execution_mode (str): Execution mode, either &quot;local&quot; or &quot;slurm&quot;. Default is &quot;local&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task_generator</span> <span class="o">=</span> <span class="n">CompareTaskGenerator</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">comps_db</span><span class="o">.</span><span class="n">to_complete_input_table</span><span class="p">(),</span>
        <span class="n">yield_size</span><span class="o">=</span><span class="n">tasks_per_batch</span><span class="p">,</span>
        <span class="n">container_engine</span><span class="o">=</span><span class="n">container_engine</span><span class="p">,</span>
        <span class="n">comp_config</span><span class="o">=</span><span class="n">comps_db</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
        <span class="n">memory_mode</span><span class="o">=</span><span class="n">memory_mode</span><span class="p">,</span>
        <span class="n">polars_engine</span><span class="o">=</span><span class="n">polars_engine</span><span class="p">,</span>
        <span class="n">chrom_batch_size</span><span class="o">=</span><span class="n">chrom_batch_size</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">execution_mode</span><span class="o">==</span><span class="s2">&quot;local&quot;</span><span class="p">:</span>
        <span class="n">batch_type</span><span class="o">=</span><span class="s2">&quot;local&quot;</span>
    <span class="k">elif</span> <span class="n">execution_mode</span><span class="o">==</span><span class="s2">&quot;slurm&quot;</span><span class="p">:</span>
        <span class="n">batch_type</span><span class="o">=</span><span class="s2">&quot;slurm&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown execution mode: </span><span class="si">{</span><span class="n">execution_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">CompareRunner</span><span class="p">(</span>
        <span class="n">run_dir</span><span class="o">=</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">run_dir</span><span class="p">),</span>
        <span class="n">task_generator</span><span class="o">=</span><span class="n">task_generator</span><span class="p">,</span>
        <span class="n">container_engine</span><span class="o">=</span><span class="n">container_engine</span><span class="p">,</span>
        <span class="n">max_concurrent_batches</span><span class="o">=</span><span class="n">max_concurrent_batches</span><span class="p">,</span>
        <span class="n">poll_interval</span><span class="o">=</span><span class="n">poll_interval</span><span class="p">,</span>
        <span class="n">tasks_per_batch</span><span class="o">=</span><span class="n">tasks_per_batch</span><span class="p">,</span>
        <span class="n">batch_type</span><span class="o">=</span><span class="n">batch_type</span><span class="p">,</span>
        <span class="n">slurm_config</span><span class="o">=</span><span class="n">slurm_config</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>